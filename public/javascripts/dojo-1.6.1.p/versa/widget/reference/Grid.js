/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["versa.widget.reference.Grid"]){dojo._hasResource["versa.widget.reference.Grid"]=true;dojo.provide("versa.widget.reference.Grid");dojo.require("bfree.widget._Grid");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.document.ViewMenu");dojo.require("versa.widget.reference.dnd.Source");dojo.require("versa.widget.reference.ContextMenu");dojo.declare("versa.widget.reference.Grid",bfree.widget._Grid,{_sourceIndex:-1,_deferSelect:false,_dndSource:null,_mnuReference:null,_mnuViews:null,activeFolder:null,activeLibrary:null,activeUser:null,activeZone:null,__doSearch:function(_1){this.setQuery(_1,{cache:false});this.resize();this.setSelectedIndex(0,true);this._sourceIndex=0;this.onQueryComplete(this.rowCount);},__reWriteView:function(_2){var _3=this.activeLibrary.getViewDefinitions().fetchById({id:this.activeView.id});if(_3.is_template){_3=this.activeLibrary.getViewDefinitions().cloneItem(_3);var _4=bfree.api.ViewDefinition.getCustomName(this.activeUser,this.activeFolder);this.activeLibrary.getViewDefinitions().setValue(_3,"name",_4);}cell_definitions=[];for(var _5=0;_5<this.layout.cellCount;_5++){var _6=this.getCell(_5);if((_2.removeProperty)&&(_2.removeProperty.getDbName()==_6.field)){continue;}var _7=_3.getCellByField(_6.field);var _8=bfree.api.CellDefinition.clone(_7);if((_2.resizeIndex)&&(_2.resizeIndex==_6.index)){_8.width=_6.unitWidth;}_8.column_order=cell_definitions.length;cell_definitions.push(_8);}if(_2.addProperty){cell_definitions.push({table_name:_2.addProperty.table_name,column_name:_2.addProperty.column_name,name:_2.addProperty.name,label:_2.addProperty.name,formatter:_2.addProperty.format_id?_2.addProperty.format_id:bfree.api.CellDefinition.formats.none,noresize:false,width:bfree.api.CellDefinitions.getDefaultWidth(_2.addProperty.data_type_id)+"px",style:"",column_order:cell_definitions.length});}if(_2.sortInfo){var _9=(_2.sortInfo<0);var _a=this.getCell(Math.abs(_2.sortInfo)-1).field;this.activeLibrary.getViewDefinitions().setValue(_3,"sort_by",_a);this.activeLibrary.getViewDefinitions().setValue(_3,"is_desc",_9);}this.activeLibrary.getViewDefinitions().setValue(_3,"cell_definitions",cell_definitions);this.activeLibrary.getViewDefinitions().save();return _3;},_canSort:function(_b){return !(_b==1||this._isLoading);},_onCommand:function(_c,_d,_e){this.onCommand(_c,_d,_e);},_onViewChange:function(_f,evt){this.set("activeView",_f);this.set("activeQuery",this.activeFolder.getActiveQuery().getQuery());},_setActiveFolderAttr:function(_10){if((_10)&&(_10.isError())){return;}var _11=((_10)&&(_10!==this.activeFolder));this.activeFolder=_10;this._mnuReference.set("activeFolder",this.activeFolder);if(_11){var _12=this.activeLibrary.getViewDefinitions().fetchById({id:this.activeFolder.view_definition_id});this.selection.clear();this.set("activeView",_12.getView(this.activeLibrary));this.set("activeQuery",this.activeFolder.getActiveQuery().getQuery());}else{this.onQueryComplete(this.rowCount);}},_setActiveQueryAttr:function(_13){this._clearData();this.showMessage(this.loadingMessage);setTimeout(versa.widget.reference.Grid._searchFnRef(this,_13),10);},_setActiveViewAttr:function(_14){this.activeView=_14;this._clearData();this.set("sortInfo",this.activeView.sort_column);this.set("structure",this.activeView);this.resize();if(this._dndSource){this._dndSource.destroy();}this._dndSource=new versa.widget.reference.dnd.Source(this.views.views[0].contentNode,{accept:[],grid:this});this._mnuViews.set("activeView",this.activeView);if((this.activeFolder)&&(!this.activeLibrary.getFolders().containsValue(this.activeFolder,"view_definition_id",this.activeView.id))){var _15=this.activeFolder.getActiveQuery();this.activeLibrary.getFolders().setValue(this.activeFolder,"view_definition_id",this.activeView.id);this.activeLibrary.getFolders().save();if(this.activeFolder.isSearch()){this.activeFolder.setActiveQuery(_15);}}},constructor:function(_16){this.updateDelay=0;this.rowsPerPage=25;this.queryOptions={cache:false};this.selectionMode="extended";this.clientSort=false;this.canSort=this._canSort;this.noDataMessage="No Documents Found";this.columnReordering=true;},export_results:function(_17){var box=bfree.api.Utilities.getBox({scale:0.75});var _18=this.getSortProps();this.activeLibrary.getReferences().export_query({zone:this.activeZone,library:this.activeLibrary,windowBox:box,type:_17,query:this.get("query"),sort:((_18)&&(_18.length>0))?_18[0]:null});},onColumnToggle:function(_19,_1a){var _1b=null;var _1c=null;var _1d=(_1a)?this.__reWriteView({addProperty:_19}):this.__reWriteView({removeProperty:_19});this.set("activeView",_1d.getView(this.activeLibrary));this.set("activeQuery",this.activeFolder.getActiveQuery().getQuery());},onCommand:function(_1e,_1f,_20){},onMouseDown:function(){this.onFocus();},onMoveColumn:function(){var _21=this.__reWriteView({});this.set("activeView",_21.getView(this.activeLibrary));this.set("activeQuery",this.activeFolder.getActiveQuery().getQuery());},onQueryComplete:function(){},onResizeColumn:function(_22){var _23=this.__reWriteView({resizeIndex:_22});this.set("activeView",_23.getView(this.activeLibrary));this.set("activeQuery",this.activeFolder.getActiveQuery().getQuery());},onRowContextMenu:function(evt){if(evt.rowIndex<0){this._mnuReference.rowHit=false;evt.cancelBubble=true;return;}var _24=this.selection.getSelected();if(this.selection.isSelected(evt.rowIndex)){this.onSelectedItems(_24);}else{this.setSelectedIndex(evt.rowIndex);_24=this.selection.getSelected();}this._mnuReference.rowHit=true;this._mnuReference.set("activeItems",_24);},onRowClick:function(evt){if(this._deferSelect){this.selection.clickSelect(evt.rowIndex,evt.ctrlKey,evt.shiftKey);}dojo.stopEvent(evt);},onRowMouseDown:function(evt){this._deferSelect=this.selection.isSelected(evt.rowIndex);if(!this._deferSelect){this.selection.clickSelect(evt.rowIndex,evt.ctrlKey,evt.shiftKey);}},onRowDblClick:function(evt){if(evt.rowIndex<0){dojo.stopEvent(evt);return;}var _25=this.getItem(evt.rowIndex);this._onCommand(bfree.widget.Bfree.Commands.VIEW,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{items:[_25]});},onSelectionChanged:function(){var _26=this.selection.getSelected();if(this._dndSource){this._dndSource.deleteSelectedNodes();this._dndSource.insertNodes(true,_26);}this.inherited("onSelectionChanged",arguments);},postCreate:function(){this.inherited("postCreate",arguments);this._mnuReference=new versa.widget.reference.ContextMenu({id:"mnuReference",grid:this,activeLibrary:this.activeLibrary,activeUser:this.activeUser,targetNodeIds:[this.id],onCommand:dojo.hitch(this,this._onCommand)});this._mnuViews=new bfree.widget.document.ViewMenu({id:"mnuViews",library:this.activeLibrary,parentMenu:this,onChange:dojo.hitch(this,this._onViewChange),onColumnToggle:dojo.hitch(this,this.onColumnToggle)});},postrender:function(){this.inherited("postrender",arguments);var _27=dojo.query(".dojoxGridSortNode");var _28=dojo.query(".dojoxGridMasterHeader");dojo.forEach(_27,function(_29,idx){var h=(dojo.contentBox(_28[0]).h-8);if(h<=0){h=1;}_29.style.height=h+"px";_29.parentNode.style.verticalAlign="top";});},print_results:function(){var box=bfree.api.Utilities.getBox({scale:0.75});var _2a=this.getSortProps();this.activeLibrary.getReferences().print_query({zone:this.activeZone,library:this.activeLibrary,windowBox:box,query:this.get("query"),sort:((_2a)&&(_2a.length>0))?_2a[0]:null});},refreshViews:function(_2b){if(this._mnuViews){this._mnuViews.destroy();}this._mnuViews=new bfree.widget.document.ViewMenu({id:"mnuViews",library:this.activeLibrary,parentMenu:this,onChange:dojo.hitch(this,this._onViewChange),onColumnToggle:dojo.hitch(this,this.onColumnToggle)});this._mnuViews.startup();this.set("headerMenu",this._mnuViews);this._mnuViews.set("activeView",this.activeView);if(_2b){var _2c=this.activeLibrary.getViewDefinitions().fetchById({id:this.activeView.id});this.set("activeView",_2c.getView(this.activeLibrary));this.set("activeQuery",this.activeFolder.getActiveQuery().getQuery());}},setBusy:function(_2d,_2e){var idx=this.getItemIndex(_2d);if(idx<0){return;}if(_2e){var _2f=this.getRowNode(idx);var e=_2f.getElementsByTagName("img");dojo.forEach(e,function(_30,idx){if(_30.name=="statusIcon"){dojo.attr(_30,"src","/images/loading/loading16.gif");}});}else{this.updateRow(idx);}},sort:function(){var _31=this.__reWriteView({sortInfo:this.sortInfo});this.set("activeView",_31.getView(this.activeLibrary));this.set("activeQuery",this.activeFolder.getActiveQuery().getQuery());},startup:function(){this.inherited("startup",arguments);this._mnuViews.startup();this.focus._delayedCellFocus=versa.widget.reference.Grid._delayedCellFocus;this.set("headerMenu",this._mnuViews);var _32=this.activeLibrary.getViewDefinitions().getSystem()[0];this.set("activeView",_32.getView(this.activeLibrary));this.setStore(this.activeLibrary.getReferences().store,{type:bfree.api.Search.types.NONE});this.set("autoRender",false);}});versa.widget.reference.Grid._searchFnRef=function(_33,_34){return (function(){_33.__doSearch(_34);});};versa.widget.reference.Grid._delayedCellFocus=function(){if(this.isNavHeader()||!this.grid._focused){return;}var n=this.cell&&this.cell.getNode(this.rowIndex);if(n){try{if(!this.grid.edit.isEditing()){dojo.toggleClass(n,this.focusClass,true);if(this._colHeadNode){this.blurHeader();}dojox.grid.util.fire(n,"focus");}}catch(e){}}};}