/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.search.Criterion"]){dojo._hasResource["bfree.widget.search.Criterion"]=true;dojo.provide("bfree.widget.search.Criterion");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("bfree.widget.Button");dojo.require("bfree.widget.FilteringSelect");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.propdef.Widget");dojo.require("bfree.widget.search.ConjunctionBar");dojo.declare("bfree.widget.search.Criterion",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree.widget.search","template/Criterion.html","<div style=\"width:100%;padding:0\">\n<table>\n    <tr>\n        <td><div dojoAttachPoint=\"propertiesNode\"></div></td>\n        <td><div dojoAttachPoint=\"operatorsNode\"></div></td>\n        <td style=\"width:184px\"><div dojoAttachPoint=\"valueNode\"></div></td>\n        <td style=\"width:20px\"><div dojoAttachPoint=\"cmdBarNode\"></div></td>\n    </tr>\n</table>\n</div>\n"),_cmdBar:null,_onChangeHndl:null,_onChangeHndl2:null,_cmbOperators:null,_cmbProperties:null,_wdgValue:null,dataTypes:null,operators:null,propertyDefinitions:null,_cmbOperators_onChange:function(_1){var op=this.operators.fetchById({id:_1});if(op.no_rhs){this._wdgValue.set("disabled",true);}else{this._wdgValue.set("disabled",false);}this._setState();this.onValueChange(null);},_cmbProperties_onChange:function(_2){var _3=this.propertyDefinitions.fetchById({id:_2});var _4=this.dataTypes.fetchById({id:_3.data_type_id});var _5=this.operators.byDataType(_4.id);this._cmbOperators.set("query",{data_type_id:_4.id});this._cmbOperators.set("value",_5[0].id);var _6=this._wdgValue;var _7=(_4.isBoolean())?bfree.widget.propdef.Widget.formats.LONG:bfree.widget.propdef.Widget.formats.SHORT;this._wdgValue=bfree.widget.propdef.Widget.getWidget(_4,null,null,_7);this._wdgValue.set("required",true);this._wdgValue.set("intermediateChanges",true);dojo.place(this._wdgValue.domNode,_6.domNode,"replace");this._wdgValue.startup();if(this._onChangeHndl){dojo.disconnect(this._onChangeHndl);this._onChangeHndl=null;}if(this._onChangeHndl2){dojo.disconnect(this._onChangeHndl2);this._onChangeHndl2=null;}this._onChangeHndl=dojo.connect(this._wdgValue,"onKeyUp",this,this._onChange);if(_4.isDateTime()){this._onChangeHndl2=dojo.connect(this._wdgValue,"onChange",this,this._onChange);}if(_6){_6.destroy();_6=null;}this.onStateChange();this.onValueChange(null);},_formatValue:function(_8,_9){var _a=[_8];if(_9.isBoolean()){_a=[(_8==1)];}else{if(_9.isDateTime()){_a=[dojo.date.stamp.toISOString(_8,{zulu:true})];}}return _a;},_onChange:function(_b){this.onValueChange(_b);this.onKeyUp(_b);},_onCommand:function(_c){switch(_c){case bfree.widget.Bfree.Commands.ADD:this._onRowAdd();break;case bfree.widget.Bfree.Commands.REMOVE:this._onRowRemove();break;}},_onRowAdd:function(){this.onNewRow();},_onRowRemove:function(){this.onDeleteRow(this);},_setState:function(){this.onStateChange();},constructor:function(_d){},destroy:function(){if(this._cmbOperators){this._cmbOperators.destroy();this._cmbOperators=null;}if(this._cmbProperties){this._cmbProperties.destroy();this._cmbProperties=null;}if(this._wdgValue){this._wdgValue.destroy();this._wdgValue=null;}if(this._cmdBar){this._cmdBar.destroy();this._cmdBar=null;}this.inherited("destroy",arguments);},getQuery:function(){var _e=this._cmbProperties.get("item");var _f=this._cmbOperators.get("item");var _10=this.dataTypes.fetchById({id:_e.data_type_id});return {operator_id:_f.id,lhs:_e.id,rhs:this._formatValue(this._wdgValue.get("value"),_10)};},onStateChange:function(){},onDeleteRow:function(_11){},onNewRow:function(){},onValueChange:function(_12){},postCreate:function(){this.inherited("postCreate",arguments);this._cmbProperties=new bfree.widget.FilteringSelect({store:this.propertyDefinitions.store,onChange:dojo.hitch(this,this._cmbProperties_onChange)},this.propertiesNode);this._cmbOperators=new bfree.widget.FilteringSelect({store:this.operators.store,onChange:dojo.hitch(this,this._cmbOperators_onChange)},this.operatorsNode);this._wdgValue=new bfree.widget.ValidationTextBox({style:"width:100%"},this.valueNode);this._cmdBar=new bfree.widget.search.ConjunctionBar({"class":"versaSidebar",onCommand:dojo.hitch(this,this._onCommand)},this.cmdBarNode);},onKeyUp:function(evt){},startup:function(){this.inherited("startup",arguments);var _13=this.propertyDefinitions.fetchByDbName("documents.name");this._cmbProperties.set("value",_13.id);}});}