/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.view.cell.Editor"]){dojo._hasResource["bfree.widget.view.cell.Editor"]=true;dojo.provide("bfree.widget.view.cell.Editor");dojo.require("bfree.api.ItemFileWriteStore");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.FilteringSelect");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.view.cell.Editor",[dijit._Widget,dijit._Templated,bfree.widget._DialogWidget],{templateString:dojo.cache("bfree/widget/view/cell","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoType=\"dijit.layout.ContentPane\"\n        style=\"padding:8px;overflow:hidden;\">\n\n<div class=\"highlightPane\" style=\"padding:8px\">\n    <div dojoAttachPoint=\"formNode\">\n        <div dojoAttachPoint=\"tableNode\"></div>\n    </div>\n</div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,_cmbColumn:null,_form:null,_first:null,_formatStore:null,_propertyStore:null,_tblProperties:null,_txtLabel:null,propertyDefinitions:null,filter:[],_buildFormatStore:function(){var _1=[{id:bfree.api.DataTypes.types.BOOLEAN+":"+bfree.api.CellDefinition.formats.none,format_id:bfree.api.CellDefinition.formats.none,data_type_id:bfree.api.DataTypes.types.BOOLEAN,name:"None"},{id:bfree.api.DataTypes.types.DATETIME+":"+bfree.api.CellDefinition.formats.none,format_id:bfree.api.CellDefinition.formats.none,data_type_id:bfree.api.DataTypes.types.DATETIME,name:"None"},{id:bfree.api.DataTypes.types.DATETIME+":"+bfree.api.CellDefinition.formats.datetime,format_id:bfree.api.CellDefinition.formats.datetime,data_type_id:bfree.api.DataTypes.types.DATETIME,name:"Date"},{id:bfree.api.DataTypes.types.FLOAT+":"+bfree.api.CellDefinition.formats.none,format_id:bfree.api.CellDefinition.formats.none,data_type_id:bfree.api.DataTypes.types.FLOAT,name:"None"},{id:bfree.api.DataTypes.types.INTEGER+":"+bfree.api.CellDefinition.formats.none,format_id:bfree.api.CellDefinition.formats.none,data_type_id:bfree.api.DataTypes.types.INTEGER,name:"None"},{id:bfree.api.DataTypes.types.INTEGER+":"+bfree.api.CellDefinition.formats.size,format_id:bfree.api.CellDefinition.formats.size,data_type_id:bfree.api.DataTypes.types.INTEGER,name:"File Size"},{id:bfree.api.DataTypes.types.STRING+":"+bfree.api.CellDefinition.formats.none,format_id:bfree.api.CellDefinition.formats.none,data_type_id:bfree.api.DataTypes.types.STRING,name:"None"},{id:bfree.api.DataTypes.types.TEXT+":"+bfree.api.CellDefinition.formats.none,format_id:bfree.api.CellDefinition.formats.none,data_type_id:bfree.api.DataTypes.types.TEXT,name:"None"}];this._formatStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:_1}});},_buildPropertyStore:function(){var _2=[];this.propertyDefinitions.forEach(function(_3,_4){var _5=_3.getDbName();if(!dojo.has(this.filter,_5)){var _6={id:_5,name:_3.name,table_name:_3.table_name,column_name:_3.column_name,data_type_id:_3.data_type_id};if(!this._first){this._first=_6;}_2.push(_6);}},this);if(!dojo.has(this.filter,"document_types.name")){_2.push({id:"document_types.name",name:"Document Type",table_name:"document_types",column_name:"name",data_type_id:bfree.api.DataTypes.types.STRING});}if(!dojo.has(this.filter,"versions.version_number")){_2.push({id:"versions.version_number",name:"Version",table_name:"versions",column_name:"version_number",data_type_id:bfree.api.DataTypes.types.STRING});}_2.sort(function(a,b){na=a.name.toLowerCase();nb=b.name.toLowerCase();return (na==nb)?0:((na<nb)?-1:1);});this._propertyStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:_2}});},_getDefaultWidth:function(_7){var w=128;switch(_7){case bfree.api.DataTypes.types.VOID:w=18;break;case bfree.api.DataTypes.types.BOOLEAN:w=18;break;case bfree.api.DataTypes.types.INTEGER:w=64;break;case bfree.api.DataTypes.types.FLOAT:w=64;break;case bfree.api.DataTypes.types.DATETIME:w=128;break;case bfree.api.DataTypes.types.STRING:w=128;break;case bfree.api.DataTypes.types.TEXT:w=128;break;}return w;},_onColumnChange:function(_8){var _9=this._cmbColumn.item;if(_9){var _a=this._propertyStore.getValue(_9,"name");var _b=this._propertyStore.getValue(_9,"data_type_id");this._txtLabel.set("value",_a);this._txtWidth.set("value",this._getDefaultWidth(_b));this._cmbFormatType.set("query",{data_type_id:_b});this._cmbFormatType.set("value",_b+":"+bfree.api.CellDefinition.formats.none);}else{this._txtName.reset();this._txtLabel.reset();}this.onValueChange();},constructor:function(_c){if(_c){dojo.safeMixin(this,_c);}this._buildPropertyStore();this._buildFormatStore();},destroy:function(){this.destroyDescendants();this.inherited("destroy",arguments);},focus:function(){},isValid:function(){return true;},onDialogClosing:function(_d){if(_d==bfree.widget.Dialog.dialogResult.cancel){this.returnValue=null;}else{if(isNaN(this._txtWidth.get("value"))){alert("Width must be a number");return false;}if(this._txtWidth.get("value")<=0){alert("Width must be greater than 0");return false;}var _e=this._cmbColumn.item;var _f=this._cmbFormatType.item;this.returnValue={id:this._propertyStore.getIdentity(_e),table_name:this._propertyStore.getValue(_e,"table_name"),column_name:this._propertyStore.getValue(_e,"column_name"),name:this._propertyStore.getValue(_e,"name"),label:this._txtLabel.get("value"),formatter:this._formatStore.getValue(_f,"format_id"),noresize:false,width:this._txtWidth.get("value")+"px",style:""};}return true;},onLoaded:function(){},postCreate:function(){this.inherited("postCreate",arguments);this._form=new dijit.form.Form({id:"columnForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblValueProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:96,style:"width:100%"},this.tableNode);this._cmbColumn=new bfree.widget.FilteringSelect({label:"Column",store:this._propertyStore,query:{},queryOptions:{cache:true},onChange:dojo.hitch(this,this._onColumnChange),searchAttr:"name",style:"width:100%"});this._tblProperties.addChild(this._cmbColumn);this._txtLabel=new bfree.widget.ValidationTextBox({label:"Label",selectOnClick:true,style:"width:100%",required:true,onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._txtLabel);this._txtWidth=new dijit.form.NumberSpinner({label:"Width",selectOnClick:true,style:"width:100%",required:true,constraints:{min:0},onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._txtWidth);this._cmbFormatType=new bfree.widget.FilteringSelect({store:this._formatStore,query:{},label:"Format Type",selectOnClick:true,style:"width:100%",required:true,onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._cmbFormatType);},startup:function(){this.inherited("startup",arguments);this._tblProperties.startup();if(this._first){this._cmbColumn.set("value",this._first.id);}}});bfree.widget.view.cell.Editor.show=function(_10){var dlg=new bfree.widget.Dialog({id:"dlgCells",title:"View Columns...",widgetConstructor:bfree.widget.view.cell.Editor,widgetParams:{propertyDefinitions:_10.propertyDefinitions,filter:_10.filter},noResize:true,height:220,width:360,zIndex:2048,buttons:bfree.widget.Dialog.buttons.ok|bfree.widget.Dialog.buttons.cancel,onClose:_10.onClose});dlg.startup();dlg.show();};}