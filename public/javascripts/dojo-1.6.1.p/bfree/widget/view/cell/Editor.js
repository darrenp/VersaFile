/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.view.cell.Editor"]){dojo._hasResource["bfree.widget.view.cell.Editor"]=true;dojo.provide("bfree.widget.view.cell.Editor");dojo.require("bfree.api.ItemFileWriteStore");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.FilteringSelect");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.view.cell.Editor",[dijit._Widget,dijit._Templated,bfree.widget._DialogWidget],{templateString:dojo.cache("bfree/widget/view/cell","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoType=\"dijit.layout.ContentPane\"\n        style=\"padding:8px;overflow:hidden;\">\n\n<div class=\"highlightPane\" style=\"padding:8px\">\n    <div dojoAttachPoint=\"formNode\">\n        <div dojoAttachPoint=\"tableNode\"></div>\n    </div>\n</div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,_cmbColumn:null,_form:null,_first:null,_formatStore:null,_propertyStore:null,_tblProperties:null,_txtLabel:null,propertyDefinitions:null,filter:[],__loadItem:function(){try{if(this._first){this._cmbColumn.set("value",this._first.id);}}finally{this.onWidgetLoaded();}},_buildFormatStore:function(){this._formatStore=bfree.api.Utilities.getFormatStore();},_buildPropertyStore:function(){var _1=[];this.propertyDefinitions.forEach(function(_2,_3){var _4=_2.getDbName();if(!dojo.has(this.filter,_4)){var _5={id:_4,name:_2.name,table_name:_2.table_name,column_name:_2.column_name,data_type_id:_2.data_type_id};if(!this._first){this._first=_5;}_1.push(_5);}},this);if(!dojo.has(this.filter,"document_types.name")){_1.push({id:"document_types.name",name:"Document Type",table_name:"document_types",column_name:"name",data_type_id:bfree.api.DataTypes.types.STRING});}if(!dojo.has(this.filter,"versions.version_number")){_1.push({id:"versions.version_number",name:"Version",table_name:"versions",column_name:"version_number",data_type_id:bfree.api.DataTypes.types.STRING});}if(!dojo.has(this.filter,"versions.binary_file_size")){_1.push({id:"versions.binary_file_size",name:"Size",table_name:"versions",column_name:"binary_file_size",data_type_id:bfree.api.DataTypes.types.INTEGER,formatter:bfree.api.CellDefinition.formats.size});}_1.sort(function(a,b){na=a.name.toLowerCase();nb=b.name.toLowerCase();return (na==nb)?0:((na<nb)?-1:1);});this._propertyStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:_1}});},_getDefaultWidth:function(_6){return bfree.api.CellDefinitions.getDefaultWidth(_6);},_onColumnChange:function(_7){var _8=this._cmbColumn.item;if(_8){var _9=this._propertyStore.getValue(_8,"name");var _a=this._propertyStore.getValue(_8,"data_type_id");this._txtLabel.set("value",_9);this._txtWidth.set("value",this._getDefaultWidth(_a));this._cmbFormatType.set("query",{data_type_id:_a});this._cmbFormatType.set("value",_a+":"+bfree.api.CellDefinition.formats.none);}else{this._txtName.reset();this._txtLabel.reset();}this.onValueChange();},constructor:function(_b){},destroy:function(){this.destroyDescendants();this.inherited("destroy",arguments);},focus:function(){},isValid:function(){return true;},onDialogClosing:function(_c){if(_c==bfree.widget.Dialog.dialogResult.cancel){this.returnValue=null;}else{if(isNaN(this._txtWidth.get("value"))){alert("Width must be a number");return false;}if(this._txtWidth.get("value")<=0){alert("Width must be greater than 0");return false;}var _d=this._cmbColumn.item;var _e=this._cmbFormatType.item;this.returnValue={id:this._propertyStore.getIdentity(_d),table_name:this._propertyStore.getValue(_d,"table_name"),column_name:this._propertyStore.getValue(_d,"column_name"),name:this._propertyStore.getValue(_d,"name"),label:this._txtLabel.get("value"),formatter:this._formatStore.getValue(_e,"format_id"),noresize:false,width:this._txtWidth.get("value")+"px",style:""};}return true;},onLoaded:function(){},postCreate:function(){this.inherited("postCreate",arguments);this._buildPropertyStore();this._buildFormatStore();this._form=new dijit.form.Form({id:"columnForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblValueProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:96,style:"width:100%"},this.tableNode);this._cmbColumn=new bfree.widget.FilteringSelect({label:"Column",store:this._propertyStore,query:{},queryOptions:{cache:true},onChange:dojo.hitch(this,this._onColumnChange),searchAttr:"name",style:"width:100%"});this._tblProperties.addChild(this._cmbColumn);this._txtLabel=new bfree.widget.ValidationTextBox({label:"Label",selectOnClick:true,style:"width:100%",required:true,onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._txtLabel);this._txtWidth=new dijit.form.NumberSpinner({label:"Width",selectOnClick:true,style:"width:100%",required:true,constraints:{min:0},onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._txtWidth);this._cmbFormatType=new bfree.widget.FilteringSelect({store:this._formatStore,query:{},label:"Format Type",selectOnClick:true,style:"width:100%",required:true,onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._cmbFormatType);},startup:function(){this.inherited("startup",arguments);this._tblProperties.startup();setTimeout(bfree.widget.view.cell.Editor._loadFnRef(this),10);}});bfree.widget.view.cell.Editor._loadFnRef=function(_f){return (function(){_f.__loadItem();});};bfree.widget.view.cell.Editor.show=function(_10){var dlg=new bfree.widget.Dialog({id:"dlgCells",title:"View Columns...",widgetConstructor:bfree.widget.view.cell.Editor,widgetParams:{propertyDefinitions:_10.propertyDefinitions,filter:_10.filter},noResize:true,height:220,width:360,zIndex:2048,buttons:bfree.widget.Dialog.buttons.ok|bfree.widget.Dialog.buttons.cancel,onClose:_10.onClose});dlg.startup();dlg.show();};}