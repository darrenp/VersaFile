/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.view.Editor"]){dojo._hasResource["bfree.widget.view.Editor"]=true;dojo.provide("bfree.widget.view.Editor");dojo.require("bfree.api.Application");dojo.require("bfree.api.DataTypes");dojo.require("bfree.api.ItemFileWriteStore");dojo.require("bfree.api.Utilities");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.view.CellBar");dojo.require("bfree.widget.view.Info");dojo.require("bfree.widget.view.cell.Editor");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.Form");dojo.require("dijit.form.SimpleTextarea");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.view.Editor",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/view","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoAttachPoint=\"mainNode\"\n        dojoType=\"dijit.layout.BorderContainer\"\n        design=\"headline\"\n        gutters=\"false\"\n        liveSplitters=\"true\"\n        style=\"width:100%;height:100%\">\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"top\"\n            style=\"overflow:hidden;padding:0;height: 104px;\">\n\n         <div dojoAttachPoint=\"formNode\">\n\n            <div dojoAttachPoint=\"tableNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.BorderContainer\"\n            splitter=\"false\"\n            region=\"center\"\n            design=\"sidebar\"\n            gutters=\"false\"\n            liveSplitters=\"true\"\n            style=\"width:100%;height:100%\">\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"center\"\n                style=\"\">\n\n            <div dojoAttachPoint=\"cellGridNode\"></div>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"right\"\n                style=\"overflow:hidden;padding:16px 0 0 0;width:24px\">\n\n            <div dojoAttachPoint=\"cellBarNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"bottom\"\n            style=\"padding:0 8px 0 8px;height: 96px;\">\n\n        <div dojoAttachPoint=\"infoNode\"></div>\n\n    </div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,activeItem:null,viewDefinitions:null,_handles:[],_cmbSort:null,_cmdBar:null,_cellStore:null,_form:null,_grdCells:null,_tblProperties:null,_txtDescription:null,_txtName:null,_wdgInfo:null,__onCellDlgClose:function(_1,_2){var _3=null;if(_1==bfree.widget.Dialog.dialogResult.ok){try{this._grdCells.beginUpdate();_3=this._cellStore.newItem({sort:(this._grdCells.rowCount),id:_2.id,name:_2.name,display:_2.label,table_name:_2.table_name,column_name:_2.column_name,formatter:_2.formatter,noresize:_2.noresize,width:_2.width,style:_2.style});}finally{this._grdCells.endUpdate();}if(_3){this._grdCells.selectItem(_3);}}return true;},_grdCells_onSelectedItems:function(_4){var _5=null;if(dojo.isArray(_4)&&_4.length>0){_5=_4[0];}this._cmdBar.set("activeCell",_5);},_onCellCommand:function(_6){switch(_6){case bfree.widget.Bfree.Commands.ADD:this._onCellAdd();break;case bfree.widget.Bfree.Commands.MOVE_UP:this._onCellUp();break;case bfree.widget.Bfree.Commands.MOVE_DOWN:this._onCellDown();break;case bfree.widget.Bfree.Commands.REMOVE:this._onCellRemove();break;}},_onCellAdd:function(){try{var _7=[];dojo.forEach(this.activeItem.cell_definitions,function(_8,_9){var _a=bfree.api.CellDefinition.getDbName(_8);_7.push(_a);},this);var _b=this.propertyDefinitions.fetch();if(_7.length>=(_b.length+5)){alert("No property definitions left to add");return;}bfree.widget.view.cell.Editor.show({filter:_7,propertyDefinitions:this.propertyDefinitions,onClose:dojo.hitch(this,this.__onCellDlgClose)});}catch(e){var _c=new bfree.api.Error("Failed to open 'Column Editor' dialog",e);bfree.widget.ErrorManager.handleError({error:_c});}},_onCellCreated:function(_d,_e){this.activeItem.cell_definitions.push({table_name:this._cellStore.getValue(_d,"table_name"),column_name:this._cellStore.getValue(_d,"column_name"),name:this._cellStore.getValue(_d,"name"),label:this._cellStore.getValue(_d,"display"),formatter:this._cellStore.getValue(_d,"formatter"),noresize:this._cellStore.getValue(_d,"noresize"),width:this._cellStore.getValue(_d,"width"),style:this._cellStore.getValue(_d,"style"),column_order:this._cellStore.getValue(_d,"sort")});this.onValueChange(this.activeItem,"cell_definitions",[],this.activeItem.cell_definitions);},_onCellDeleted:function(_f){var id=this._cellStore.getIdentity(_f);for(var idx=0;idx<this.activeItem.cell_definitions.length;idx++){var _10=bfree.api.CellDefinition.getDbName(this.activeItem.cell_definitions[idx]);if(_10==id){this.activeItem.cell_definitions.splice(idx,1);break;}}this.activeItem.cell_definitions.sort(bfree.api.CellDefinition.compare);for(var i=0;i<this.activeItem.cell_definitions.length;i++){this.activeItem.cell_definitions[i].sort_order=i;}this.onValueChange(this.activeItem,"cell_definitions",[],this.activeItem.cell_definitions);},_onCellDown:function(){var _11=this._grdCells.selection.getFirstSelected();if(_11){this._grdCells.moveItem(_11,bfree.widget.SortGrid.move.DOWN);}},_onCellUp:function(){var _12=this._grdCells.selection.getFirstSelected();if(_12){this._grdCells.moveItem(_12,bfree.widget.SortGrid.move.UP);}},_onCellRemove:function(){var idx=0;try{this._grdCells.beginUpdate();var _13=this._grdCells.selection.getFirstSelected();idx=this._grdCells.getItemIndex(_13);this._cellStore.deleteItem(_13);if(_13.id==this.activeItem.sort_by){this.activeItem.sort_by=null;this._cmbSort.reset();this._cmbSort.validate();}var _14=this._cellStore._arrayOfTopLevelItems;_14.sort(function(_15,_16){return _15.sort[0]-_16.sort[0];});for(var i=0;i<_14.length;i++){if(_14[i]){this._cellStore.setValue(_14[i],"sort",i);}}this._cellStore.save();}catch(e){var err=new bfree.api.Error("Failed to remove Cell Definition",e);bfree.widget.ErrorManager.handleError({error:err});}finally{this._grdCells.endUpdate();}this._grdCells.setSelectedIndex(idx);},_onCellUpdated:function(_17,_18,_19,_1a){_18=(_18=="sort")?"column_order":_18;var id=this._cellStore.getIdentity(_17);for(var idx=0;idx<this.activeItem.cell_definitions.length;idx++){var _1b=bfree.api.CellDefinition.getDbName(this.activeItem.cell_definitions[idx]);if(_1b==id){if(this.activeItem.cell_definitions[idx].hasOwnProperty(_18)){if(this.activeItem.cell_definitions[idx][_18]!=_1a){this.activeItem.cell_definitions[idx][_18]=_1a;}}}}this.onValueChange(this.activeItem,"cell_definitions",[],this.activeItem.cell_definitions);},_onValueChange:function(_1c,_1d){if(!this.activeItem){return;}if(!this.activeItem.hasOwnProperty(_1c)){return;}var _1e=this.viewDefinitions.getValue(this.activeItem,_1c);if(_1e!=_1d){this.viewDefinitions.store.setValue(this.activeItem,_1c,_1d);this.onValueChange(this.activeItem,_1c,_1e,_1d);}},_setActiveItemAttr:function(_1f){this.activeItem=_1f;this._setStore();this._txtName.set("value",this.activeItem.name);this._txtDescription.set("value",this.activeItem.description);this._cmbSort.set("value",this.activeItem.sort_by);this._cmdBar.set("activeView",this.activeItem);this._wdgInfo.set("activeItem",this.activeItem);this._setState();},_setState:function(){var _20=this.viewDefinitions.isDirty({item:this.activeItem});var _21=this.activeItem.isNew();this._txtName.set("disabled",!_20);this._txtDescription.set("disabled",!_20);this._cmbSort.set("disabled",!_20);this._grdCells.set("disabled",!_20);this._cmdBar.set("disabled",!_20);},_setStore:function(){var _22=[];if(this.activeItem){dojo.forEach(this.activeItem.cell_definitions,function(_23,idx){_22.push({sort:_23.column_order,id:bfree.api.CellDefinition.getDbName(_23),name:_23.name,display:_23.label,table_name:_23.table_name,column_name:_23.column_name,formatter:_23.formatter,noresize:_23.noresize,width:_23.width,style:_23.style});},this);}dojo.forEach(this._handles,function(_24,idx){dojo.disconnect(_24);delete this._handles[idx];},this);this._cellStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"display",items:_22}});this._handles[0]=dojo.connect(this._cellStore,"onNew",this,this._onCellCreated);this._handles[1]=dojo.connect(this._cellStore,"onDelete",this,this._onCellDeleted);this._handles[2]=dojo.connect(this._cellStore,"onSet",this,this._onCellUpdated);this._cmbSort.set("store",this._cellStore);this._grdCells.setStore(this._cellStore);this._grdCells.resize();this._grdCells.setSelectedIndex(0);},constructor:function(_25){this._cellStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"display",items:[]}});},destroy:function(){this.destroyDescendants();if(this._tblProperties){this._tblProperties.destroyDescendants();this._tblProperties.destroy();this._tblProperties=null;}if(this._form){this._form.destroy();this._form=null;}this.inherited("destroy",arguments);},focus:function(){this._txtName.setFocus(true);},onValueChange:function(_26,_27,_28,_29){},postCreate:function(){this.inherited("postCreate",arguments);this._form=new dijit.form.Form({id:"propDefForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:112,style:"width:100%"},this.tableNode);this._txtName=new bfree.widget.ValidationTextBox({label:"Name",intermediateChanges:true,selectOnClick:true,style:"width:100%",required:true,trim:true,validator:dojo.hitch(this,this._txtNameValidator),onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._txtName);this._txtDescription=new dijit.form.SimpleTextarea({label:"Description","class":"bfree",rows:2,style:"resize:none;width:100%",onChange:dojo.hitch(this,this._onValueChange,"description")});this._tblProperties.addChild(this._txtDescription);this._cmbSort=new bfree.widget.FilteringSelect({label:"Sort By Column",store:this._cellStore,query:{},queryOptions:{cache:true},onChange:dojo.hitch(this,this._onValueChange,"sort_by"),searchAttr:"name"});this._tblProperties.addChild(this._cmbSort);this._grdCells=new bfree.widget.SortGrid({"class":"versaGridOutlineNoPad",query:{},noDataMessage:"No Columns Defined",store:this._cellStore,sort_field:"sort",structure:bfree.widget.view.Editor.view1,formatterScope:this,rowsPerPage:1000,style:"width:100%;height:100%",onSelectedItems:dojo.hitch(this,this._grdCells_onSelectedItems)},this.cellGridNode);this._cmdBar=new bfree.widget.view.CellBar({id:"wdgCellBar","class":"versaSidebar",grid:this._grdCells,onCommand:dojo.hitch(this,this._onCellCommand)},this.cellBarNode);this._wdgInfo=new bfree.widget.view.Info({id:"wdgInfo1"},this.infoNode);this._grdCells.startup();},_txtNameValidator:function(_2a){if(this._txtName){if(_2a.trim()==""){this._txtName.set("invalidMessage","View definition name cannot be blank");return false;}var _2b=this.viewDefinitions.fetch();for(var i=0;i<_2b.length;i++){if(_2b[i].name&&_2b[i].name.toLowerCase().trim()==_2a.toLowerCase().trim()&&_2b[i].__id!=this.activeItem.__id){this._txtName.set("invalidMessage","Duplicate view definition");return false;}}}return true;},resize:function(){this.inherited("resize",arguments);this.mainNode.resize();},startup:function(){this.inherited("startup",arguments);this._tblProperties.startup();}});bfree.widget.view.Editor.getFormatFn=function(idx,_2c){var _2d="None";if(!_2c){return _2d;}var _2e=this.grid.store.getValue(_2c,"formatter");switch(_2e){case bfree.api.CellDefinition.formats.icon:_2d="Icon";break;case bfree.api.CellDefinition.formats.size:_2d="Size";break;case bfree.api.CellDefinition.formats.status:_2d="Status";break;case bfree.api.CellDefinition.formats.datetime:_2d="Date";break;case bfree.api.CellDefinition.formats.date:_2d="Date";break;case bfree.api.CellDefinition.formats.time:_2d="Time";break;}return _2d;};bfree.widget.view.Editor.view1=[{cells:[{field:"sort",name:"&nbsp",width:"16px",hidden:true},{field:"name",name:"Name",width:"128px"},{field:"display",name:"Label",width:"auto"},{field:"width",name:"Width",width:"64px"},{field:"formatter",name:"Format",width:"64px",get:bfree.widget.view.Editor.getFormatFn}],width:"auto"}];}