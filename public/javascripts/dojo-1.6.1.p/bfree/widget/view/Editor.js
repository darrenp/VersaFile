/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.view.Editor"]){dojo._hasResource["bfree.widget.view.Editor"]=true;dojo.provide("bfree.widget.view.Editor");dojo.require("bfree.api.Application");dojo.require("bfree.api.DataTypes");dojo.require("bfree.api.ItemFileWriteStore");dojo.require("bfree.api.Utilities");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.view.CellBar");dojo.require("bfree.widget.view.Info");dojo.require("bfree.widget.view.cell.Editor");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.Form");dojo.require("dijit.form.SimpleTextarea");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.view.Editor",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/view","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoAttachPoint=\"mainNode\"\n        dojoType=\"dijit.layout.BorderContainer\"\n        design=\"headline\"\n        gutters=\"false\"\n        liveSplitters=\"true\"\n        style=\"width:100%;height:100%\">\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"top\"\n            style=\"overflow:hidden;padding:0;height: 104px;\">\n\n         <div dojoAttachPoint=\"formNode\">\n\n            <div dojoAttachPoint=\"tableNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.BorderContainer\"\n            splitter=\"false\"\n            region=\"center\"\n            design=\"sidebar\"\n            gutters=\"false\"\n            liveSplitters=\"true\"\n            style=\"width:100%;height:100%\">\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"center\"\n                style=\"\">\n\n            <div dojoAttachPoint=\"cellGridNode\"></div>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"right\"\n                style=\"overflow:hidden;padding:16px 0 0 0;width:24px\">\n\n            <div dojoAttachPoint=\"cellBarNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"bottom\"\n            style=\"padding:0 8px 0 8px;height: 96px;\">\n\n        <div dojoAttachPoint=\"infoNode\"></div>\n\n    </div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,activeItem:null,viewDefinitions:null,_handles:[],_cmbSort:null,_cmdBar:null,_cellStore:null,_form:null,_grdCells:null,_tblProperties:null,_txtDescription:null,_txtName:null,_wdgInfo:null,__onCellDlgClose:function(_1,_2){var _3=null;if(_1==bfree.widget.Dialog.dialogResult.ok){try{this._grdCells.beginUpdate();_3=this._cellStore.newItem({sort:(this._grdCells.rowCount),id:_2.id,name:_2.name,display:_2.label,table_name:_2.table_name,column_name:_2.column_name,formatter:_2.formatter,noresize:_2.noresize,width:_2.width,style:_2.style});}finally{this._grdCells.endUpdate();}if(_3){this._grdCells.selectItem(_3);}}return true;},_grdCells_onSelectedItem:function(_4){this._cmdBar.set("activeCell",_4);},_onCellCommand:function(_5){switch(_5){case bfree.widget.Bfree.Commands.ADD:this._onCellAdd();break;case bfree.widget.Bfree.Commands.MOVE_UP:this._onCellUp();break;case bfree.widget.Bfree.Commands.MOVE_DOWN:this._onCellDown();break;case bfree.widget.Bfree.Commands.REMOVE:this._onCellRemove();break;}},_onCellAdd:function(){try{var _6=[];dojo.forEach(this.activeItem.cell_definitions,function(_7,_8){var _9=bfree.api.CellDefinition.getDbName(_7);_6.push(_9);},this);bfree.widget.view.cell.Editor.show({filter:_6,propertyDefinitions:this.propertyDefinitions,onClose:dojo.hitch(this,this.__onCellDlgClose)});}catch(e){var _a=new bfree.api.Error("Failed to open 'Column Editor' dialog",e);bfree.widget.ErrorManager.handleError({error:_a});}},_onCellCreated:function(_b,_c){this.activeItem.cell_definitions.push({table_name:this._cellStore.getValue(_b,"table_name"),column_name:this._cellStore.getValue(_b,"column_name"),name:this._cellStore.getValue(_b,"name"),label:this._cellStore.getValue(_b,"display"),formatter:this._cellStore.getValue(_b,"formatter"),noresize:this._cellStore.getValue(_b,"noresize"),width:this._cellStore.getValue(_b,"width"),style:this._cellStore.getValue(_b,"style"),column_order:this._cellStore.getValue(_b,"sort")});this.onValueChange(this.activeItem,"cell_definitions",[],this.activeItem.cell_definitions);},_onCellDeleted:function(_d){var id=this._cellStore.getIdentity(_d);for(var _e=0;_e<this.activeItem.cell_definitions.length;_e++){var _f=bfree.api.CellDefinition.getDbName(this.activeItem.cell_definitions[_e]);if(_f==id){this.activeItem.cell_definitions.splice(_e,1);break;}}this.onValueChange(this.activeItem,"cell_definitions",[],this.activeItem.cell_definitions);},_onCellDown:function(){var _10=this._grdCells.selection.getFirstSelected();if(_10){this._grdCells.moveItem(_10,bfree.widget.SortGrid.move.DOWN);}},_onCellUp:function(){var _11=this._grdCells.selection.getFirstSelected();if(_11){this._grdCells.moveItem(_11,bfree.widget.SortGrid.move.UP);}},_onCellRemove:function(){var idx=0;try{this._grdCells.beginUpdate();var _12=this._grdCells.selection.getFirstSelected();idx=this._grdCells.getItemIndex(_12);this._cellStore.deleteItem(_12);if(_12.id==this.activeItem.sort_by){this.activeItem.sort_by=null;this._cmbSort.reset();this._cmbSort.validate();}}catch(e){var err=new bfree.api.Error("Failed to remove Cell Definition",e);bfree.widget.ErrorManager.handleError({error:err});}finally{this._grdCells.endUpdate();}this._grdCells.setSelectedIndex(idx);},_onCellUpdated:function(_13,_14,_15,_16){_14=(_14=="sort")?"column_order":_14;var id=this._cellStore.getIdentity(_13);for(var idx=0;idx<this.activeItem.cell_definitions.length;idx++){var _17=bfree.api.CellDefinition.getDbName(this.activeItem.cell_definitions[idx]);if(_17==id){if(this.activeItem.cell_definitions[idx].hasOwnProperty(_14)){if(this.activeItem.cell_definitions[idx][_14]!=_16){this.activeItem.cell_definitions[idx][_14]=_16;}}}}this.onValueChange(this.activeItem,"cell_definitions",[],this.activeItem.cell_definitions);},_onValueChange:function(_18,_19){if(!this.activeItem){return;}if(!this.activeItem.hasOwnProperty(_18)){return;}var _1a=this.viewDefinitions.getValue(this.activeItem,_18);if(_1a!=_19){this.viewDefinitions.store.setValue(this.activeItem,_18,_19);this.onValueChange(this.activeItem,_18,_1a,_19);}},_setActiveItemAttr:function(_1b){this.activeItem=_1b;this._setStore();this._txtName.set("value",this.activeItem.name);this._txtDescription.set("value",this.activeItem.description);this._cmbSort.set("value",this.activeItem.sort_by);this._cmdBar.set("activeView",this.activeItem);this._wdgInfo.set("activeItem",this.activeItem);this._setState();},_setState:function(){var _1c=this.viewDefinitions.isDirty({item:this.activeItem});var _1d=this.activeItem.isNew();this._txtName.set("disabled",!_1c);this._txtDescription.set("disabled",!_1c);this._cmbSort.set("disabled",!_1c);this._grdCells.set("disabled",!_1c);this._cmdBar.set("disabled",!_1c);},_setStore:function(){var _1e=[];if(this.activeItem){dojo.forEach(this.activeItem.cell_definitions,function(_1f,idx){_1e.push({sort:_1f.column_order,id:bfree.api.CellDefinition.getDbName(_1f),name:_1f.name,display:_1f.label,table_name:_1f.table_name,column_name:_1f.column_name,formatter:_1f.formatter,noresize:_1f.noresize,width:_1f.width,style:_1f.style});},this);}dojo.forEach(this._handles,function(_20,idx){dojo.disconnect(_20);delete this._handles[idx];},this);this._cellStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"display",items:_1e}});this._handles[0]=dojo.connect(this._cellStore,"onNew",this,this._onCellCreated);this._handles[1]=dojo.connect(this._cellStore,"onDelete",this,this._onCellDeleted);this._handles[2]=dojo.connect(this._cellStore,"onSet",this,this._onCellUpdated);this._cmbSort.set("store",this._cellStore);this._grdCells.setStore(this._cellStore);this._grdCells.resize();},constructor:function(_21){this._cellStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"display",items:[]}});},destroy:function(){this.destroyDescendants();if(this._tblProperties){this._tblProperties.destroyDescendants();this._tblProperties.destroy();this._tblProperties=null;}if(this._form){this._form.destroy();this._form=null;}this.inherited("destroy",arguments);},focus:function(){this._txtName.setFocus(true);},onValueChange:function(_22,_23,_24,_25){},postCreate:function(){this.inherited("postCreate",arguments);this._form=new dijit.form.Form({id:"propDefForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:112,style:"width:100%"},this.tableNode);this._txtName=new bfree.widget.ValidationTextBox({label:"Name",intermediateChanges:true,selectOnClick:true,style:"width:100%",required:true,onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._txtName);this._txtDescription=new dijit.form.SimpleTextarea({label:"Description","class":"bfree",rows:2,style:"resize:none;width:100%",onChange:dojo.hitch(this,this._onValueChange,"description")});this._tblProperties.addChild(this._txtDescription);this._cmbSort=new bfree.widget.FilteringSelect({label:"Sort By Column",store:this._cellStore,query:{},queryOptions:{cache:true},onChange:dojo.hitch(this,this._onValueChange,"sort_by"),searchAttr:"name"});this._tblProperties.addChild(this._cmbSort);this._grdCells=new bfree.widget.SortGrid({"class":"versaGridOutlineNoPad",query:{},noDataMessage:"No Columns Defined",store:this._cellStore,sort_field:"sort",structure:bfree.widget.view.Editor.view1,formatterScope:this,rowHeight:24,style:"width:100%;height:100%",onSelectedItem:dojo.hitch(this,this._grdCells_onSelectedItem)},this.cellGridNode);this._cmdBar=new bfree.widget.view.CellBar({id:"wdgCellBar","class":"versaSidebar",grid:this._grdCells,onCommand:dojo.hitch(this,this._onCellCommand)},this.cellBarNode);this._wdgInfo=new bfree.widget.view.Info({id:"wdgInfo1"},this.infoNode);this._grdCells.startup();},resize:function(){this.inherited("resize",arguments);this.mainNode.resize();},startup:function(){this.inherited("startup",arguments);this._tblProperties.startup();}});bfree.widget.view.Editor.getFormatFn=function(idx,_26){var _27="None";if(!_26){return _27;}var _28=this.grid.store.getValue(_26,"formatter");switch(_28){case bfree.api.CellDefinition.formats.icon:_27="Icon";break;case bfree.api.CellDefinition.formats.size:_27="Size";break;case bfree.api.CellDefinition.formats.status:_27="Status";break;case bfree.api.CellDefinition.formats.datetime:_27="Date";break;case bfree.api.CellDefinition.formats.date:_27="Date";break;case bfree.api.CellDefinition.formats.time:_27="Time";break;}return _27;};bfree.widget.view.Editor.view1=[{cells:[{field:"sort",name:"&nbsp",width:"16px",hidden:true},{field:"name",name:"Name",width:"128px"},{field:"display",name:"Label",width:"auto"},{field:"width",name:"Width",width:"64px"},{field:"formatter",name:"Format",width:"64px",get:bfree.widget.view.Editor.getFormatFn}],width:"auto"}];}