/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.acl.Editor"]){dojo._hasResource["bfree.widget.acl.Editor"]=true;dojo.provide("bfree.widget.acl.Editor");dojo.require("bfree.widget.Button");dojo.require("bfree.widget._DialogWidget");dojo.require("bfree.widget.acl.Grid");dojo.require("bfree.widget.acl.grantee.List");dojo.require("bfree.widget.FilteringSelect");dojo.require("dojox.data.KeyValueStore");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.CheckBox");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.declare("bfree.widget.acl.Editor",[dijit._Widget,dijit._Templated,bfree.widget._DialogWidget],{templateString:dojo.cache("bfree/widget/acl","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n    <div    dojoType=\"dijit.layout.BorderContainer\"\n            design=\"headline\"\n            gutters=\"false\"\n            style=\"height:100%;width:100%;\">\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                dojoAttachPoint=\"inheritNode\"\n                region=\"top\"\n                splitter=\"false\"\n                style=\"overflow:hidden;height:16px;\">\n\n            <div id=\"chkInherit\" dojoAttachPoint=\"chkInherit\"></div>\n            <span class=\"bfree dijitDarkLabel boldLabel\" style=\"vertical-align:middle\">\n                <label for=\"chkInherit\" dojoAttachPoint=\"lblInheritNode\"></label>\n            </span>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.BorderContainer\"\n                design=\"headline\"\n                gutters=\"false\"\n                region=\"center\"\n                splitter=\"false\"\n                style=\"\">\n\n            <div    dojoType=\"dijit.layout.ContentPane\"\n                    region=\"top\"\n                    splitter=\"false\"\n                    style=\"overflow: hidden;height:16px\">\n\n                <span class=\"bfree dijitDarkLabel boldLabel\" style=\"padding-right:8px;vertical-align:middle\">Everyone:</span><div dojoAttachPoint=\"cmbEveryone\"></div>\n\n            </div>\n\n            <div    dojoType=\"dijit.layout.ContentPane\"\n                    region=\"center\"\n                    splitter=\"false\"\n                    style=\"\">\n\n                <div dojoAttachPoint=\"gridNode\"></div>\n\n            </div>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                region=\"bottom\"\n                splitter=\"false\"\n                style=\"height:36px;padding-top:0\">\n\n            <div dojoAttachPoint=\"btnAddNode\"></div>\n            <div dojoAttachPoint=\"btnRemoveNode\"></div>\n\n        </div>\n\n    </div>\n\n</div>\n"),widgetsInTemplate:true,_acl:null,_parentAcl:null,_btnAdd:null,_btnRemove:null,_chkInherit:null,_cmbEveryone:null,_grdAcl:null,_groups:{},_roles:{},activeUser:null,activeGroup:null,item:null,library:null,zone:null,type:null,__doCancel:function(){var _1=false;try{_1=true;}catch(e){}return _1;},__doSave:function(){var _2=false;try{this._acl.inherits=this._chkInherit.checked;this._acl.acl_entries=[];if(!this._acl.inherits){this._acl.acl_entries.push({grantee_id:this._groups.admin.id,grantee_type:"group",role_id:this._roles.admin.id});var _3=this.zone.getRoles().fetchById({id:this._cmbEveryone.value});this._acl.acl_entries.push({grantee_id:this._groups.everyone.id,grantee_type:"group",role_id:_3.id});for(var i=0;i<this._grdAcl.rowCount;i++){var _4=this._grdAcl.getItem(i);var _5=this._grdAcl.store.getValue(_4,"grantee_id");var _6=this._grdAcl.store.getValue(_4,"grantee_type");var _7=this._grdAcl.store.getValue(_4,"role_id");this._acl.acl_entries.push({grantee_id:_5,grantee_type:_6,role_id:_7});}}var _8=(this._acl.inherits)?this._parentAcl.hasAccess(this.zone,this.activeUser,this.activeGroup):this._acl.hasAccess(this.zone,this.activeUser,this.activeGroup);if(!_8){var _9="Cannot update permissions: The current permissions are set so that you will no longer have access to the item.";throw new Error(_9);}this.item.setAcl(this.zone,this._acl);_2=true;}catch(e){var _a=new bfree.api.Error("Failed to save permissions",e);bfree.widget.ErrorManager.handleError({error:_a});}return _2;},__loadItem:function(){var _b=null;try{if(this.item.isInstanceOf(bfree.api.Reference)){_b=(this.item.folder_id)?this.library.getFolders().fetchById({id:this.item.folder_id}):this.library;}else{if(this.item.isInstanceOf(bfree.api.Folder)){_b=(this.item.parent_id)?this.library.getFolders().fetchById({id:this.item.parent_id}):this.library;}}this._acl=this.item.getAcl(this.zone);this._parentAcl=(_b)?_b.getAcl(this.zone):null;this._roles["admin"]=this.zone.getRoles().fetchByName("Admin");this._groups["admin"]=this.zone.getGroups().getAdmin();this._groups["everyone"]=this.zone.getGroups().getEveryone();this._chkInherit.set("checked",this._acl.inherits);this._cmbEveryone.set("value",this._acl.getEveryone(this.zone).role_id);this._grdAcl.set("activeItem",this._acl);}finally{this.onWidgetLoaded();this._isLoaded=true;this._setState();}},_btnAdd_onClick:function(_c){try{function _d(_e,_f){if(_e==bfree.widget.Dialog.dialogResult.ok){dojo.forEach(_f,function(_10){this._grdAcl.newItem(_10.id,_10.name,_10.type);},this);this._grdAcl.resize();this.set("isDirty",true);this.onValueChange();}return true;};var _11=[];var _12=[];for(var i=0;i<this._grdAcl.rowCount;i++){var _13=this._grdAcl.getItem(i);var _14=this._grdAcl.store.getValue(_13,"grantee_id");var _15=this._grdAcl.store.getValue(_13,"grantee_type");if(_15=="Group"){_12.push(_14);}else{_11.push(_14);}}var dlg=new bfree.widget.Dialog({id:"dlgGrantees",title:"Add Users/Groups",widgetConstructor:bfree.widget.acl.grantee.List,widgetParams:{zone:this.zone,groupFilter:_12,userFilter:_11},noResize:true,height:320,width:320,zIndex:2048,buttons:bfree.widget.Dialog.buttons.ok|bfree.widget.Dialog.buttons.cancel,onClose:dojo.hitch(this,_d)});dlg.startup();dlg.show();}catch(e){var err=new bfree.api.Error("Failed to open 'Edit Permissions' dialog",e);bfree.widget.ErrorManager.handleError({error:err});}},_btnRemove_onClick:function(evt){dojo.forEach(this._grdAcl.selection.getSelected(),function(_16){this._grdAcl.removeItem(_16);},this);},_chkInherit_onChange:function(_17){if(!this._grdAcl){return;}if(_17){this._cmbEveryone.set("value",this._parentAcl.getEveryone(this.zone).role_id);this._grdAcl.set("activeItem",this._parentAcl);this._grdAcl.selection.clear();}else{this._grdAcl.set("activeItem",this._acl);this._grdAcl.setSelectedIndex(0);}if(this._acl.inherits!=_17){this.set("isDirty",true);}this.onValueChange();this._setState();},_cmbEveryone_onChange:function(_18){if(this._acl.getEveryone(this.zone).role_id!=_18){this.set("isDirty",true);}this.onValueChange();},_grdAcl_onChange:function(_19,_1a,_1b,_1c){if(this._isLoaded){this.set("isDirty",true);}this.onValueChange();},_grdAcl_onSelectedItems:function(_1d){var _1e=null;if((dojo.isArray(_1d))&&(_1d.length>0)){_1e=_1d[0];}this._setState();},_setState:function(){var _1f=this._grdAcl.selection.getSelectedCount();this._cmbEveryone.set("disabled",this._chkInherit.checked);this._btnAdd.set("disabled",this._chkInherit.checked);this._btnRemove.set("disabled",(this._chkInherit.checked||(_1f<1)));this._grdAcl.set("disabled",this._chkInherit.checked);},constructor:function(_20){},destroy:function(){if(this._btnRemove!=null){this._btnRemove.destroyRecursive(false);this._btnRemove=null;}if(this._btnAdd!=null){this._btnAdd.destroyRecursive(false);this._btnAdd=null;}if(this._grdAcl!=null){this._grdAcl.destroyRecursive(false);this._grdAcl=null;}if(this._cmbEveryone!=null){this._cmbEveryone.destroyRecursive(false);this._cmbEveryone=null;}if(this._chkInherit!=null){this._chkInherit.destroyRecursive(false);this._chkInherit=null;}},isValid:function(){return (this.isDirty);},onDialogClosing:function(_21){var _22=false;try{this.returnValue=[this.item];_22=(_21==bfree.widget.Dialog.dialogResult.ok)?this.__doSave():this.__doCancel();}catch(e){var err=new bfree.api.Error("Failed to save permissions",e);bfree.widget.ErrorManager.handleError({error:err});}return _22;},postCreate:function(){this.inherited("postCreate",arguments);if(this.item.isInstanceOf(bfree.api.Folder)){this.type="Folder";this.lblInheritNode.innerHTML="Inherit from Parent";if(this.item.isRoot()||this.item.isShareRoot()){dojo.style(this.inheritNode.domNode,{display:"none"});}}else{if(this.item.isInstanceOf(bfree.api.Reference)){this.type="Reference";this.lblInheritNode.innerHTML=(this.item.isShare())?"Inherit for Share":"Inherit from Folder";}}this._chkInherit=new dijit.form.CheckBox({id:"chkInherit",checked:false,scrollOnFocus:false,onChange:dojo.hitch(this,this._chkInherit_onChange)},this.chkInherit);var _23=this.zone.getRoles().query({query:"?type="+this.type});var _24=new Array();for(var i=0;i<_23.length;i++){var _25=new Object();_25[_23[i].id]=_23[i].name;_24.push(_25);}var _26=new dojox.data.KeyValueStore({dataVar:_24});this._cmbEveryone=new bfree.widget.FilteringSelect({store:_26,searchAttr:"name",value:_23[0].id,onChange:dojo.hitch(this,this._cmbEveryone_onChange)},this.cmbEveryone);this._grdAcl=new bfree.widget.acl.Grid({"class":"versaGridOutlineNoPad",zone:this.zone,autoSelect:false,onChange:dojo.hitch(this,this._grdAcl_onChange),onSelectedItems:dojo.hitch(this,this._grdAcl_onSelectedItems)},this.gridNode);this._btnAdd=new bfree.widget.Button({"class":"versaButton",iconClass:"buttonIcon bfreeIconAdd",disabledIconClass:"buttonIcon bfreeIconAddD",label:"Add...",disabled:true,onClick:dojo.hitch(this,this._btnAdd_onClick)},this.btnAddNode);this._btnRemove=new bfree.widget.Button({"class":"versaButtonLarge",iconClass:"buttonIcon bfreeIconRemove",disabledIconClass:"buttonIcon bfreeIconRemoveD",label:"Remove",disabled:true,onClick:dojo.hitch(this,this._btnRemove_onClick)},this.btnRemoveNode);},startup:function(){this.inherited("startup",arguments);setTimeout(bfree.widget.acl.Editor._loadFnRef(this),10);}});bfree.widget.acl.Editor._loadFnRef=function(_27){return (function(){_27.__loadItem();});};bfree.widget.acl.Editor.show=function(_28){var _29=(_28.item)?_28.item:((_28.items)&&dojo.isArray(_28.items))?_28.items[0]:_28.items;var dlg=new bfree.widget.Dialog({id:"dlgEditPermissions",title:dojo.replace("Edit Permissions - {name}",_29),widgetConstructor:bfree.widget.acl.Editor,widgetParams:{activeUser:_28.user,activeGroup:_28.group,library:_28.library,zone:_28.zone,item:_29},noResize:true,height:360,width:480,zIndex:1024,buttons:bfree.widget.Dialog.buttons.ok|bfree.widget.Dialog.buttons.cancel,onClose:_28.onClose});dlg.startup();dlg.show();};}