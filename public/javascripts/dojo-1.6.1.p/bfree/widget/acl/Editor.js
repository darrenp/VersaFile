/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.acl.Editor"]){dojo._hasResource["bfree.widget.acl.Editor"]=true;dojo.provide("bfree.widget.acl.Editor");dojo.require("bfree.widget.Button");dojo.require("bfree.widget._DialogWidget");dojo.require("bfree.widget.acl.Grid");dojo.require("bfree.widget.acl.grantee.List");dojo.require("bfree.widget.FilteringSelect");dojo.require("dojox.data.KeyValueStore");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.CheckBox");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.declare("bfree.widget.acl.Editor",[dijit._Widget,dijit._Templated,bfree.widget._DialogWidget],{templateString:dojo.cache("bfree/widget/acl","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n    <div    dojoType=\"dijit.layout.BorderContainer\"\n            design=\"headline\"\n            gutters=\"false\"\n            style=\"height:100%;width:100%;\">\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                region=\"top\"\n                splitter=\"false\"\n                style=\"overflow:hidden;height:16px;\">\n\n            <div id=\"chkInherit\" dojoAttachPoint=\"chkInherit\"></div>\n            <span class=\"bfree dijitDarkLabel boldLabel\" style=\"vertical-align:middle\">\n                <label for=\"chkInherit\" dojoAttachPoint=\"lblInheritNode\"></label>\n            </span>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.BorderContainer\"\n                design=\"headline\"\n                gutters=\"false\"\n                region=\"center\"\n                splitter=\"false\"\n                style=\"\">\n\n            <div    dojoType=\"dijit.layout.ContentPane\"\n                    region=\"top\"\n                    splitter=\"false\"\n                    style=\"overflow: hidden;height:16px\">\n\n                <span class=\"bfree dijitDarkLabel boldLabel\" style=\"padding-right:8px;vertical-align:middle\">Everyone:</span><div dojoAttachPoint=\"cmbEveryone\"></div>\n\n            </div>\n\n            <div    dojoType=\"dijit.layout.ContentPane\"\n                    region=\"center\"\n                    splitter=\"false\"\n                    style=\"\">\n\n                <div dojoAttachPoint=\"gridNode\"></div>\n\n            </div>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                region=\"bottom\"\n                splitter=\"false\"\n                style=\"height:36px;padding-top:0\">\n\n            <div dojoAttachPoint=\"btnAddNode\"></div>\n            <div dojoAttachPoint=\"btnRemoveNode\"></div>\n\n        </div>\n\n    </div>\n\n</div>\n"),widgetsInTemplate:true,_acl:null,_btnAdd:null,_btnRemove:null,_chkInherit:null,_cmbEveryone:null,_grdAcl:null,activeUser:null,activeGroup:null,item:null,zone:null,type:null,_btnAdd_onClick:function(_1){try{function _2(_3,_4){if(_3==bfree.widget.Dialog.dialogResult.ok){dojo.forEach(_4,function(_5){this._grdAcl.newItem(_5.id,_5.name,_5.type);},this);}return true;};var _6=new bfree.widget.Dialog({id:"dlgGrantees",title:"Add Users/Groups",widgetConstructor:bfree.widget.acl.grantee.List,widgetParams:{zone:this.zone},noResize:true,height:320,width:320,zIndex:2048,buttons:bfree.widget.Dialog.buttons.ok|bfree.widget.Dialog.buttons.cancel,onClose:dojo.hitch(this,_2)});_6.startup();_6.show();}catch(e){var _7=new bfree.api.Error("Failed to open 'Edit Permissions' dialog",e);bfree.widget.ErrorManager.handleError({error:_7});}},_btnRemove_onClick:function(_8){dojo.forEach(this._grdAcl.selection.getSelected(),function(_9){this._grdAcl.removeItem(_9);},this);},_chkInherit_onChange:function(_a){if(_a!=this._acl.inherits){this._acl.inherits=_a;this.set("isDirty",true);this.onValueChange();}this._setState();},_cmbEveryone_onChange:function(_b){this.set("isDirty",true);this.onValueChange();},_grdAcl_onChange:function(_c,_d,_e,_f){this.set("isDirty",true);this.onValueChange();},_grdAcl_onSelectedItem:function(_10){if(this._btnRemove!=null){this._btnRemove.set("disabled",(_10==null));}},_setState:function(){var _11=this._grdAcl.selection.getSelectedCount();this._cmbEveryone.set("disabled",this._chkInherit.checked);this._btnAdd.set("disabled",this._chkInherit.checked);this._btnRemove.set("disabled",(this._chkInherit.checked||(_11<1)));},constructor:function(_12){this._acl=_12.acl;},destroy:function(){if(this._btnRemove!=null){this._btnRemove.destroyRecursive(false);this._btnRemove=null;}if(this._btnAdd!=null){this._btnAdd.destroyRecursive(false);this._btnAdd=null;}if(this._grdAcl!=null){this._grdAcl.destroyRecursive(false);this._grdAcl=null;}if(this._cmbEveryone!=null){this._cmbEveryone.destroyRecursive(false);this._cmbEveryone=null;}if(this._chkInherit!=null){this._chkInherit.destroyRecursive(false);this._chkInherit=null;}},isValid:function(){return (this.isDirty||this._grdAcl.store.isDirty());},onDialogClosing:function(_13){var _14=false;try{if(_13==bfree.widget.Dialog.dialogResult.ok){var _15=this.zone.getRoles().fetchByName("Admin");var _16=this.zone.getRoles().fetchById({id:this._cmbEveryone.value});var _17=this._acl.getAdministrator();var _18=this._acl.getEveryone();this._acl.acl_entries.length=0;this._acl.acl_entries.push({grantee_id:_17.grantee_id,grantee_type:_17.grantee_type,grantee:{id:_17.grantee.id,name:_17.grantee.name},role_id:_15.id,role:{id:_15.id,name:_15.name,permissions:_15.permissions}});this._acl.acl_entries.push({grantee_id:_18.grantee_id,grantee_type:_18.grantee_type,grantee:{id:_18.grantee.id,name:_18.grantee.name},role_id:_16.id,role:{id:_16.id,name:_16.name,permissions:_16.permissions}});for(var i=0;i<this._grdAcl.rowCount;i++){var _19=this._grdAcl.getItem(i);var _1a=this._grdAcl.store.getValue(_19,"role_id");var _1b=this.zone.getRoles().fetchById({id:_1a});var _1c=this._grdAcl.store.getValue(_19,"grantee_id");var _1d=this._grdAcl.store.getValue(_19,"grantee_name");this._acl.acl_entries.push({grantee_id:_1c,grantee_type:this._grdAcl.store.getValue(_19,"grantee_type"),grantee:{id:_1c,name:_1d},role_id:_1b.id,role:{id:_1b.id,name:_1b.name,permissions:_1b.permissions}});}if(this._acl.hasAccess(this.activeUser,this.activeGroup)){this.returnValue=this.item.setAcl(this.zone,this._acl);_14=true;}else{var msg="Cannot update permissions: The current permissions are set so that you will no longer have access to the item.";alert(msg);}}else{_14=true;}}catch(e){var err=new bfree.api.Error("Failed to save permissions",e);bfree.widget.ErrorManager.handleError({error:err});}return _14;},postCreate:function(){this.inherited("postCreate",arguments);if(this.item.isInstanceOf(bfree.api.Library)){this.type="Library";}else{if(this.item.isInstanceOf(bfree.api.Document)){this.type="Document";this.lblInheritNode.innerHTML="Inherit from Folder";}else{if(this.item.isInstanceOf(bfree.api.Folder)){this.type="Folder";this.lblInheritNode.innerHTML="Inherit from Parent";}}}var e=this._acl.getEveryone();var _1e=this.zone.getRoles().query({query:"?type="+this.type});var _1f=new Array();for(var i=0;i<_1e.length;i++){_1f[i]=new Object();_1f[i][_1e[i].id]=_1e[i].name;}var _20=new dojox.data.KeyValueStore({dataVar:_1f});if(!this.item.isInstanceOf(bfree.api.Library)){this._chkInherit=new dijit.form.CheckBox({id:"chkInherit",checked:false,scrollOnFocus:false,onChange:dojo.hitch(this,this._chkInherit_onChange)},this.chkInherit);}this._cmbEveryone=new bfree.widget.FilteringSelect({store:_20,searchAttr:"name",value:this._acl.getEveryone().role_id,onChange:dojo.hitch(this,this._cmbEveryone_onChange)},this.cmbEveryone);this._grdAcl=new bfree.widget.acl.Grid({"class":"versaGridOutlineNoPad",acl:this._acl,zone:this.zone,autoSelect:false,onChange:dojo.hitch(this,this._grdAcl_onChange),onSelectedItem:dojo.hitch(this,this._grdAcl_onSelectedItem)},this.gridNode);this._btnAdd=new bfree.widget.Button({"class":"versaButton",iconClass:"buttonIcon bfreeIconAdd",disabledIconClass:"buttonIcon bfreeIconAddD",label:"Add...",disabled:false,onClick:dojo.hitch(this,this._btnAdd_onClick)},this.btnAddNode);this._btnRemove=new bfree.widget.Button({"class":"versaButton",iconClass:"buttonIcon bfreeIconRemove",disabledIconClass:"buttonIcon bfreeIconRemoveD",label:"Remove",disabled:true,onClick:dojo.hitch(this,this._btnRemove_onClick)},this.btnRemoveNode);},startup:function(){this.inherited("startup",arguments);if(!this.item.isInstanceOf(bfree.api.Library)){this._chkInherit.set("checked",this._acl.inherits);}this._grdAcl.resize();this._grdAcl.setSelectedIndex(0);}});bfree.widget.acl.Editor.show=function(_21){var acl=_21.item.getAcl(_21.zone);if(acl.acl_entries==0){bfree.widget.acl.Editor.refresh();return;}var dlg=new bfree.widget.Dialog({id:"dlgEditPermissions",title:dojo.replace("Edit Permissions - {name}",_21.item),widgetConstructor:bfree.widget.acl.Editor,widgetParams:{activeUser:_21.user,activeGroup:_21.group,zone:_21.zone,item:_21.item,acl:acl},noResize:true,height:360,width:480,zIndex:1024,buttons:bfree.widget.Dialog.buttons.ok|bfree.widget.Dialog.buttons.cancel,onClose:_21.onClose});dlg.startup();dlg.show();};}