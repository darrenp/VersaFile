/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.acl.Grid"]){dojo._hasResource["bfree.widget.acl.Grid"]=true;dojo.provide("bfree.widget.acl.Grid");dojo.require("bfree.widget._Grid");dojo.require("dijit.form.FilteringSelect");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dojox.grid.cells.dijit");dojo.declare("bfree.widget.acl.Grid",[bfree.widget._Grid],{_defaultRole:null,_hndls:[],activeItem:null,disabled:false,zone:null,_canEdit:function(_1,_2){if(this.disabled){return false;}var _3=this.getItem(_2);var _4=this.store.getValue(_3,"grantee_name");return ((_4!="Administrators")&&(_4!="Admin"));},_canSort:function(_5){return (_5<3);},_formatRole:function(_6,_7){var _8=this.zone.getRoles().fetchById({id:_6});return _8.name;},_generateIcon:function(_9,_a){return dojo.replace("<img src=\"/images/icons/16/{0}.png\" height=\"16\" width=\"16\" />",[_9.toLowerCase()]);},_generateStore:function(){for(var i=0;i<this._hndls.length;i++){dojo.disconnect(this._hndls[i]);this._hndls[i]=null;}var _b=[];dojo.forEach(this.activeItem.acl_entries,function(_c){var _d=(_c.grantee_type.toLowerCase()=="group")?this.zone.getGroups().fetchById({id:_c.grantee_id}):this.zone.getUsers().fetchById({id:_c.grantee_id});var _e=this.zone.getRoles().fetchById({id:_c.role_id});if((_d.isInstanceOf(bfree.api.Group))&&(_d.is_admin||_d.is_everyone)){return;}var _f=_d.isInstanceOf(bfree.api.User)?_d.getFullName():_d.name;_b.push({grantee_id:_c.grantee_id,grantee_type:_c.grantee_type,grantee_name:_f,role_id:_c.role_id,permissions:_e.permissions});},this);var _10={items:_b};var _11=new dojo.data.ItemFileWriteStore({data:_10});this._hndls[0]=dojo.connect(_11,"onSet",this,this._onStoreChange);this._hndls[1]=dojo.connect(_11,"onNew",this,this._onStoreChange);this._hndls[2]=dojo.connect(_11,"onDelete",this,this._onStoreChange);return _11;},_generateView:function(){var _12=[];this.zone.getRoles().forEach(function(itm,idx){_12.push(itm.name);});return [{cells:[{field:"grantee_type",name:"&nbsp;",width:"16px",formatter:this._generateIcon},{field:"grantee_name",name:"Grantee",width:"auto"},{field:"role_id",name:"Role",width:"128px",editable:true,cellType:dojox.grid.cells._Widget,widgetClass:dijit.form.FilteringSelect,widgetProps:{scrollOnFocus:false,store:this.zone.getRoles().store,searchAttr:"name",onChange:dojo.hitch(this,this._onRoleChange)},formatter:this._formatRole}],width:"auto"}];},_onRoleChange:function(_13){if((this.selection.getSelectedCount()<1)||String.isBlank(_13)){return;}var _14=this.selection.getFirstSelected();var _15=this.store.getValue(_14,"role_id");if(_13==_15){return;}var _16=this.getItemIndex(_14);this.doApplyCellEdit(_13,_16,"role_id");this.onChange();},_onStoreChange:function(){this.onChange();},_setActiveItemAttr:function(_17){this.activeItem=_17;this.setStore(this._generateStore());},_setDisabledAttr:function(_18){this.disabled=_18;},constructor:function(_19){this.updateDelay=0;this.rowsPerPage=25;this.formatterScope=this;this.editable=true;this.singleClickEdit=true;this.query=0;this.queryOptions={cache:false};this.selectionMode="single";this.clientSort=true;this.canEdit=this._canEdit;this.canSort=this._canSort;this.noDataMessage="No Permission entries found";this.rowHeight=24;},clear:function(){while(this.rowCount>0){var _1a=this.getItem(0);this.store.deleteItem(_1a);}},newItem:function(id,_1b,_1c){var _1d=false;var _1e=this.store.fetch({query:{grantee_id:id,grantee_type:_1c},queryOptions:{cache:false},onComplete:function(_1f){_1d=(_1f.length>0);}});if(_1d){return;}var _20=this.store.newItem({grantee_id:id,grantee_name:_1b,grantee_type:_1c,role_id:this._defaultRole.id});this.refresh();this.selectItem(_20);},removeItem:function(_21){var idx=this.getItemIndex(_21);this.store.deleteItem(_21);this.setSelectedIndex(idx);},onApplyCellEdit:function(_22,_23,_24){this.inherited("onApplyCellEdit",arguments);var _25=this.getItem(_23);var _26=this.store.getValue(_25,"role_id");var _27=this.zone.getRoles().fetchById({id:_26});this.store.setValue(_25,"permissions",_27.permissions);this.updateRow(_23);},onBlur:function(){var _28=this.selection.getFirstSelected();var idx=this.getItemIndex(_28);this.focus.setFocusCell(this.getCell(1),idx);this.inherited("onBlur",arguments);},onChange:function(){},onCommand:function(_29,_2a){},onSelectedItem:function(_2b){var idx=this.getItemIndex(_2b);this.focus.setFocusCell(this.getCell(2),idx);},postCreate:function(){this.inherited("postCreate",arguments);var _2c=this.zone.getRoles();_2c.fetch();this._defaultRole=_2c.fetchByName("Viewer");this.set("structure",this._generateView());this.set("sortInfo",1);this.startup();}});}