/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.acl.Grid"]){dojo._hasResource["bfree.widget.acl.Grid"]=true;dojo.provide("bfree.widget.acl.Grid");dojo.require("bfree.widget._Grid");dojo.require("dijit.form.FilteringSelect");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dojox.grid.cells.dijit");dojo.declare("bfree.widget.acl.Grid",[bfree.widget._Grid],{_defaultRole:null,activeItem:null,zone:null,_canEdit:function(_1,_2){var _3=this.getItem(_2);var _4=this.store.getValue(_3,"grantee_name");return ((_4!="Administrators")&&(_4!="Admin"));},_canSort:function(_5){return (_5<3);},_formatRole:function(_6,_7){var _8=this.zone.getRoles().fetchById({id:_6});return _8.name;},_generateIcon:function(_9,_a){return dojo.replace("<img src=\"/images/icons/16/{0}.png\" height=\"16\" width=\"16\" />",[_9.toLowerCase()]);},_generateStore:function(){var _b=[];dojo.forEach(this.activeItem.acl_entries,function(_c){var _d=(_c.grantee_type.toLowerCase()=="group")?this.zone.getGroups().fetchById({id:_c.grantee_id}):this.zone.getUsers().fetchById({id:_c.grantee_id});var _e=this.zone.getRoles().fetchById({id:_c.role_id});if((_d.isInstanceOf(bfree.api.Group))&&(_d.is_admin||_d.is_everyone)){return;}var _f=_d.isInstanceOf(bfree.api.User)?_d.getFullName():_d.name;_b.push({grantee_id:_c.grantee_id,grantee_type:_c.grantee_type,grantee_name:_f,role_id:_c.role_id,permissions:_e.permissions});},this);var _10={items:_b};return new dojo.data.ItemFileWriteStore({data:_10});},_generateView:function(){var _11=[];this.zone.getRoles().forEach(function(itm,idx){_11.push(itm.name);});return [{cells:[{field:"grantee_type",name:"&nbsp;",width:"16px",formatter:this._generateIcon},{field:"grantee_name",name:"Grantee",width:"auto"},{field:"role_id",name:"Role",width:"128px",editable:true,cellType:dojox.grid.cells._Widget,widgetClass:dijit.form.FilteringSelect,widgetProps:{scrollOnFocus:false,store:this.zone.getRoles().store,searchAttr:"name",onChange:dojo.hitch(this,this._onRoleChange)},formatter:this._formatRole}],width:"auto"}];},_onRoleChange:function(_12){if(this.selection.getSelectedCount()<1){return;}var _13=this.selection.getFirstSelected();var _14=this.store.getValue(_13,"role_id");if(_12==_14){return;}var _15=this.getItemIndex(_13);this.doApplyCellEdit(_12,_15,"role_id");},_onStoreChange:function(){this.onChange();},_setActiveItemAttr:function(_16){this.activeItem=_16;this.setStore(this._generateStore());},constructor:function(_17){this.updateDelay=0;this.rowsPerPage=25;this.formatterScope=this;this.editable=true;this.singleClickEdit=true;this.query=0;this.queryOptions={cache:false};this.selectionMode="single";this.clientSort=true;this.canEdit=this._canEdit;this.canSort=this._canSort;this.noDataMessage="No Permission entries found";this.rowHeight=24;},clear:function(){while(this.rowCount>0){var _18=this.getItem(0);this.store.deleteItem(_18);}},newItem:function(id,_19,_1a){var _1b=false;var _1c=this.store.fetch({query:{grantee_id:id,grantee_type:_1a},queryOptions:{cache:false},onComplete:function(_1d){_1b=(_1d.length>0);}});if(_1b){return;}var _1e=this.store.newItem({grantee_id:id,grantee_name:_19,grantee_type:_1a,role_id:this._defaultRole.id});this.refresh();this.selectItem(_1e);},removeItem:function(_1f){var idx=this.getItemIndex(_1f);this.store.deleteItem(_1f);this.setSelectedIndex(idx);},onApplyCellEdit:function(_20,_21,_22){this.inherited("onApplyCellEdit",arguments);var _23=this.getItem(_21);var _24=this.store.getValue(_23,"role_id");if(_20==_24){return;}var _25=this.zone.getRoles().fetchById({id:_24});this.store.setValue(_23,"permissions",_25.permissions);this.updateRow(_21);},onChange:function(){},onCommand:function(_26,_27){},onSelectedItem:function(_28){var idx=this.getItemIndex(_28);this.focus.setFocusCell(this.getCell(2),idx);},postCreate:function(){this.inherited("postCreate",arguments);var _29=this.zone.getRoles();_29.fetch();this._defaultRole=_29.fetchByName("Viewer");this.set("structure",this._generateView());this.set("sortInfo",1);this.startup();dojo.connect(this.store,"onSet",this,this._onStoreChange);dojo.connect(this.store,"onNew",this,this._onStoreChange);dojo.connect(this.store,"onDelete",this,this._onStoreChange);}});}