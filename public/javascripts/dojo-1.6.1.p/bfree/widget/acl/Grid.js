/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.acl.Grid"]){dojo._hasResource["bfree.widget.acl.Grid"]=true;dojo.provide("bfree.widget.acl.Grid");dojo.require("bfree.widget._Grid");dojo.require("dijit.form.FilteringSelect");dojo.require("dojo.data.ItemFileWriteStore");dojo.require("dojox.grid.cells.dijit");dojo.declare("bfree.widget.acl.Grid",[bfree.widget._Grid],{_defaultRole:null,acl:null,zone:null,_canEdit:function(_1,_2){var _3=this.getItem(_2);var _4=this.store.getValue(_3,"grantee_name");return ((_4!="Administrators")&&(_4!="Admin"));},_canSort:function(_5){return (_5<3);},_formatRole:function(_6,_7){var _8=this.zone.getRoles().fetchById({id:_6});return _8.name;},_generateIcon:function(_9,_a){return dojo.replace("<img src=\"/images/icons/16/{0}.png\" height=\"16\" width=\"16\" />",[_9]);},_generateStore:function(){var _b=[];dojo.forEach(this.acl.acl_entries,function(_c){if((_c.grantee_type.toLowerCase()=="group")&&((_c.grantee.name.toLowerCase()=="administrators")||(_c.grantee.name.toLowerCase()=="everyone"))){return;}var _d=_c.grantee.name;if(_c.grantee_type.toLowerCase()=="user"){var _e=this.zone.getUsers().fetchById({id:_c.grantee.id});if(_e!=null){_d=_e.getFullName();}}_b.push({grantee_id:_c.grantee.id,grantee_name:_d,grantee_type:_c.grantee_type.toLowerCase(),role_id:_c.role.id,permissions:_c.role.permissions});},this);var _f={items:_b};return new dojo.data.ItemFileWriteStore({data:_f});},_generateView:function(){var _10=[];this.zone.getRoles().forEach(function(itm,idx){_10.push(itm.name);});return [{cells:[{field:"grantee_type",name:"&nbsp;",width:"16px",formatter:this._generateIcon},{field:"grantee_name",name:"Grantee",width:"auto"},{field:"role_id",name:"Role",width:"128px",editable:true,cellType:dojox.grid.cells._Widget,widgetClass:dijit.form.FilteringSelect,widgetProps:{scrollOnFocus:false,store:this.zone.getRoles().store,searchAttr:"name",onChange:dojo.hitch(this,this._onRoleChange)},formatter:this._formatRole}],width:"auto"}];},_onRoleChange:function(_11){if(this.selection.getSelectedCount()<1){return;}var _12=this.selection.getFirstSelected();var _13=this.store.getValue(_12,"role_id");if(_11==_13){return;}var _14=this.getItemIndex(_12);this.doApplyCellEdit(_11,_14,"role_id");},_onStoreChange:function(){this.onChange();},constructor:function(_15){this.updateDelay=0;this.rowsPerPage=25;this.formatterScope=this;this.editable=true;this.singleClickEdit=true;this.query=0;this.queryOptions={cache:false};this.selectionMode="single";this.clientSort=true;this.canEdit=this._canEdit;this.canSort=this._canSort;this.noDataMessage="No Permission entries found";this.rowHeight=24;},newItem:function(id,_16,_17){var _18=false;var _19=this.store.fetch({query:{grantee_id:id,grantee_type:_17},queryOptions:{cache:false},onComplete:function(_1a){_18=(_1a.length>0);}});if(_18){return;}var _1b=this.store.newItem({grantee_id:id,grantee_name:_16,grantee_type:_17,role_id:this._defaultRole.id});this.refresh();this.selectItem(_1b);},removeItem:function(_1c){var idx=this.getItemIndex(_1c);this.store.deleteItem(_1c);this.setSelectedIndex(idx);},onApplyCellEdit:function(_1d,_1e,_1f){this.inherited("onApplyCellEdit",arguments);var _20=this.getItem(_1e);var _21=this.store.getValue(_20,"role_id");if(_1d==_21){return;}var _22=this.zone.getRoles().fetchById({id:_21});this.store.setValue(_20,"permissions",_22.permissions);this.updateRow(_1e);},onChange:function(){},onCommand:function(_23,_24){},onSelectedItem:function(_25){var idx=this.getItemIndex(_25);this.focus.setFocusCell(this.getCell(2),idx);},postCreate:function(){this.inherited("postCreate",arguments);var _26=this.zone.getRoles();_26.fetch();this._defaultRole=_26.fetchByName("Viewer");this.set("structure",this._generateView());this.set("sortInfo",1);this.startup();this.setStore(this._generateStore());dojo.connect(this.store,"onSet",this,this._onStoreChange);dojo.connect(this.store,"onNew",this,this._onStoreChange);dojo.connect(this.store,"onDelete",this,this._onStoreChange);}});}