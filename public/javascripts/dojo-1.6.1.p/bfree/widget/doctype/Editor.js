/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.doctype.Editor"]){dojo._hasResource["bfree.widget.doctype.Editor"]=true;dojo.provide("bfree.widget.doctype.Editor");dojo.require("bfree.api.Application");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.SortGrid");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.doctype.Info");dojo.require("bfree.widget.doctype.PropMapBar");dojo.require("bfree.widget.propdef.List");dojo.require("bfree.widget.propdef.Widget");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.Form");dojo.require("dijit.form.SimpleTextarea");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.doctype.Editor",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/doctype","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoAttachPoint=\"mainNode\"\n        dojoType=\"dijit.layout.BorderContainer\"\n        design=\"headline\"\n        gutters=\"false\"\n        liveSplitters=\"true\"\n        style=\"width:100%;height:100%\">\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"top\"\n            style=\"overflow:hidden;padding:0;height: 76px;\">\n\n         <div dojoAttachPoint=\"formNode\">\n\n            <div dojoAttachPoint=\"tableNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.BorderContainer\"\n            splitter=\"false\"\n            region=\"center\"\n            design=\"sidebar\"\n            gutters=\"false\"\n            liveSplitters=\"true\"\n            style=\"width:100%;height:100%\">\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"center\"\n                style=\"overflow:hidden;padding:16px 8px 8px 0;position:relative\">\n\n            <span class=\"dijitMediumLabel dijitDarkLabel\" style=\"position:absolute;top:0;left:0\">Properties</span>\n            <div dojoAttachPoint=\"propertyMappingsNode\" style=\"height:100%\"></div>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"right\"\n                style=\"overflow:hidden;padding:16px 0 0 0;width:24px\">\n\n            <div dojoAttachPoint=\"propMapBarNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"bottom\"\n            style=\"padding:0 8px 0 8px;height: 104px;\">\n\n        <div dojoAttachPoint=\"infoNode\"></div>\n\n    </div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,activeItem:null,choiceLists:null,documentTypes:null,propertyDefinitions:null,_onNewHandle:null,_onDeleteHandle:null,_onSetHandle:null,_dataTypes:null,_form:null,_propMapStore:null,_cmdBar:null,_grdPropertyMappings:null,_tblProperties:null,_txtDescription:null,_txtName:null,__onPropMapDlgClose:function(_1,_2){if(_1==bfree.widget.Dialog.dialogResult.ok){var _3=null;try{var _4=this._grdPropertyMappings.rowCount;this._grdPropertyMappings.beginUpdate();dojo.forEach(_2,function(id,_5){var _6=this.propertyDefinitions.fetchById({id:id});var _7=this._dataTypes.fetchById({id:_6.data_type_id});var _8;if(_7.isDateTime()){_8=new Date();}else{_8="";}_3=this._propMapStore.newItem({sort:_4,id:_6.id,name:_6.name,data_type:_7,is_required:false,choice_list_id:null,default_value:_8,is_system:_6.is_system,is_name:_6.is_name});_4++;},this);}finally{this._grdPropertyMappings.endUpdate();}if(_3){this._grdPropertyMappings.selectItem(_3);}}return true;},_setActiveItemAttr:function(_9){this.activeItem=_9;this._grdPropertyMappings.selection.clear();if(this.activeItem){this._txtName.set("value",this.activeItem.name);this._txtDescription.set("value",this.activeItem.description);}else{this._txtName.reset();this._txtDescription.reset();}this._cmdBar.set("activeDocType",this.activeItem);this._wdgInfo.set("activeItem",this.activeItem);this._setStore();this._setState();this._grdPropertyMappings.resize();},_setState:function(){var _a=false;var _b=false;if(this.activeItem){_a=this.documentTypes.isDirty({item:this.activeItem});_b=this.activeItem.isNew();}this._txtName.set("disabled",!_a);this._txtDescription.set("disabled",!_a);this._cmdBar.set("disabled",!_a);},_setStore:function(){var _c=[];if(this.activeItem){dojo.forEach(this.activeItem.property_mappings,function(_d,_e){var _f=this.propertyDefinitions.fetchById({id:_d.property_definition_id});var _10=this._dataTypes.fetchById({id:_f.data_type_id});_c.push({sort:_d.sort_order,id:_f.id,name:_f.name,data_type:_10,is_required:_d.is_required,default_value:_d.default_value,choice_list_id:_d.choice_list_id,is_system:_f.is_system,is_name:_f.is_name});},this);}if(this._onNewHandle){dojo.disconnect(this._onNewHandle);this._onNewHandle=null;}if(this._onDeleteHandle){dojo.disconnect(this._onDeleteHandle);this._onDeleteHandle=null;}if(this._onSetHandle){dojo.disconnect(this._onSetHandle);this._onSetHandle=null;}this._propMapStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:_c}});this._onNewHandle=dojo.connect(this._propMapStore,"onNew",this,this._onPropertyMapCreated);this._onDeleteHandle=dojo.connect(this._propMapStore,"onDelete",this,this._onPropertyMapDeleted);this.__onSetHandle=dojo.connect(this._propMapStore,"onSet",this,this._onPropertyMapUpdated);this._grdPropertyMappings.setStore(this._propMapStore);},_chkIsRequired_onChange:function(id,_11){this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_12){this._propMapStore.setValue(_12,"is_required",_11);})});},_cmbChoiceList_onChange:function(id,_13){this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_14){if(_13==-1){_13=null;}this._propMapStore.setValue(_14,"choice_list_id",_13);})});},_grdPropMap_onSelectedItem:function(_15){this._cmdBar.set("activePropMap",_15);},_onPropMapCommand:function(_16){switch(_16){case bfree.widget.Bfree.Commands.ADD:this._onPropertyMapAdd();break;case bfree.widget.Bfree.Commands.MOVE_UP:this._onPropertyMapUp();break;case bfree.widget.Bfree.Commands.MOVE_DOWN:this._onPropertyMapDown();break;case bfree.widget.Bfree.Commands.REMOVE:this._onPropertyMapRemove();break;}},_onPropertyMapAdd:function(){try{var _17=[];dojo.forEach(this.activeItem.property_mappings,function(_18,idx){_17.push(_18.property_definition_id);},this);bfree.widget.propdef.List.show({filter:_17,propertyDefinitions:this.library.getPropertyDefinitions(),onClose:dojo.hitch(this,this.__onPropMapDlgClose)});}catch(e){var err=new bfree.api.Error("Failed to open 'Property Definitions' dialog",e);bfree.widget.ErrorManager.handleError({error:err});}},_onPropertyMapCreated:function(_19,_1a){this.activeItem.property_mappings.push({sort_order:this._propMapStore.getValue(_19,"sort"),property_definition_id:this._propMapStore.getIdentity(_19),is_required:false,choice_list_id:null});this.onValueChange(this.activeItem,"property_mappings",[],this.activeItem.property_mappings);},_onPropertyMapDeleted:function(_1b){var id=this._propMapStore.getIdentity(_1b);for(var idx=0;idx<this.activeItem.property_mappings.length;idx++){if(this.activeItem.property_mappings[idx].property_definition_id==id){this.activeItem.property_mappings.splice(idx,1);break;}}this.onValueChange(this.activeItem,"property_mappings",[],this.activeItem.property_mappings);},_onPropertyMapDown:function(){var _1c=this._grdPropertyMappings.selection.getFirstSelected();if(_1c){this._grdPropertyMappings.moveItem(_1c,bfree.widget.SortGrid.move.DOWN);}var _1d=this._grdPropertyMappings.getItemIndex(_1c);var _1e=_1d-1;var _1f=this._grdPropertyMappings.getItem(_1e);var _20=this._propMapStore.getValue(_1c,"sort");var _21=this._propMapStore.getValue(_1f,"sort");for(var i in this.activeItem.property_mappings){if(_1c.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_20;}if(_1f.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_21;}}this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);},_onPropertyMapUp:function(){var _22=this._grdPropertyMappings.selection.getFirstSelected();if(_22){this._grdPropertyMappings.moveItem(_22,bfree.widget.SortGrid.move.UP);}var _23=this._grdPropertyMappings.getItemIndex(_22);var _24=_23+1;var _25=this._grdPropertyMappings.getItem(_24);var _26=this._propMapStore.getValue(_22,"sort");var _27=this._propMapStore.getValue(_25,"sort");for(var i in this.activeItem.property_mappings){if(_22.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_26;}if(_25.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_27;}}this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);},_onPropertyMapRemove:function(){var idx=0;try{this._grdPropertyMappings.beginUpdate();var _28=this._grdPropertyMappings.selection.getFirstSelected();idx=this._grdPropertyMappings.getItemIndex(_28);this._propMapStore.deleteItem(_28);}catch(e){var err=new bfree.api.Error("Failed to remove Property Mapping",e);bfree.widget.ErrorManager.handleError({error:err});}finally{this._grdPropertyMappings.endUpdate();}this._grdPropertyMappings.setSelectedIndex(idx);},_onPropertyMapUpdated:function(_29,_2a,_2b,_2c){var id=this._propMapStore.getIdentity(_29);for(var i=0;i<this.activeItem.property_mappings.length;i++){if(this.activeItem.property_mappings[i].property_definition_id==id){if(this.activeItem.property_mappings[i].hasOwnProperty(_2a)){if(this.activeItem.property_mappings[i][_2a]!=_2c){this.activeItem.property_mappings[i][_2a]=_2c;}}}}this.onValueChange(this.activeItem,"property_mappings",[],this.activeItem.property_mappings);},_txtDescription_onChange:function(_2d){if(!this.activeItem){return;}if(this.activeItem.description!=_2d){this.documentTypes.store.setValue(this.activeItem,"description",_2d);}},_txtName_onChange:function(_2e){if(!this.activeItem){return;}if(this.activeItem.name!=_2e){this.propertyDefinitions.store.setValue(this.activeItem,"name",_2e);}},_wdgDefault_onChange:function(id,_2f){var _30=null;for(var i in this.activeItem.property_mappings){if(this.activeItem.property_mappings[i].property_definition_id==id){if(this.activeItem.property_mappings[i].default_value!=_2f){this.activeItem.property_mappings[i].default_value=_2f;this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);}}}},constructor:function(_31){this._propMapStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:[]}});},destroy:function(){if(this._txtName){this._txtName.destroy();this._txtName=null;}if(this._txtDescription){this._txtDescription.destroy();this._txtDescription=null;}if(this._grdPropertyMappings){this._grdPropertyMappings.destroyDescendants();this._grdPropertyMappings.destroy();this._grdPropertyMappings=null;}if(this._tblProperties){this._tblProperties.destroyDescendants();this._tblProperties.destroy();this._tblProperties=null;}if(this._form){this._form.destroy();this._form=null;}this.inherited("destroy",arguments);},focus:function(){this._txtName.setFocus(true);},onValueChange:function(_32,_33,_34,_35){},postCreate:function(){this.inherited("postCreate",arguments);this._dataTypes=bfree.api.Application.getDataTypes();this._form=new dijit.form.Form({id:"docTypeForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:96,style:"width:100%"},this.tableNode);this._txtName=new bfree.widget.ValidationTextBox({label:"Name",required:true,selectOnClick:true,style:"width:100%",validator:dojo.hitch(this,this._txtNameValidator),onChange:dojo.hitch(this,this._txtName_onChange)});this._tblProperties.addChild(this._txtName);this._txtDescription=new dijit.form.SimpleTextarea({label:"Description","class":"bfree",rows:2,style:"resize:none;width:100%",onChange:dojo.hitch(this,this._txtDescription_onChange)});this._tblProperties.addChild(this._txtDescription);this._grdPropertyMappings=new bfree.widget.SortGrid({"class":"versaGridOutlineNoPad",query:{},noDataMessage:"No Properties Defined",store:this._propMapStore,sort_field:"sort",structure:bfree.widget.doctype.Editor.view1,formatterScope:this,style:"width:100%;height:100%",onSelectedItem:dojo.hitch(this,this._grdPropMap_onSelectedItem)},this.propertyMappingsNode);this._cmdBar=new bfree.widget.doctype.PropMapBar({id:"wdgPropDefBar","class":"versaSidebar",grid:this._grdPropertyMappings,onCommand:dojo.hitch(this,this._onPropMapCommand)},this.propMapBarNode);this._wdgInfo=new bfree.widget.doctype.Info({id:"wdgGroupInfo1"},this.infoNode);this._grdPropertyMappings.startup();},_txtNameValidator:function(_36){var _37=this.documentTypes.fetch();for(var i=0;i<_37.length;i++){if(_37[i].name&&_37[i].name.toLowerCase().trim()==_36.toLowerCase().trim()&&_37[i].__id!=this.activeItem.__id){this._txtName.set("invalidMessage","Duplicate document type");return false;}}return true;},resize:function(){this.inherited("resize",arguments);this.mainNode.resize();},startup:function(){this.inherited("startup",arguments);}});bfree.widget.doctype.Editor.generateChoiceListWidget=function(_38,_39){var wdg=null;var _3a=this._grdPropertyMappings.getItem(_39);var _3b=this._propMapStore.getValue(_3a,"data_type");var _3c=this.documentTypes.isDirty({item:this.activeItem});if((_3c)&&(_3b.allow_choice_list)){var _3d=this.choiceLists.store.fetch({query:{data_type_id:_3b.id},queryOptions:{cache:true,clientFetch:true}}).results;var _3e=new Array();var _3f=new Object();_3f[-1]="None";_3e.push(_3f);for(var i=0;i<_3d.length;i++){_3f=new Object();_3f[_3d[i].id]=_3d[i].name;_3e.push(_3f);}var _40=new dojox.data.KeyValueStore({dataVar:_3e});wdg=new bfree.widget.FilteringSelect({store:_40,searchAttr:"name",required:false,value:_38,style:"width:128px",scrollOnFocus:false,onChange:dojo.hitch(this,this._cmbChoiceList_onChange,this._propMapStore.getIdentity(_3a))});}else{if(_38){var _41=this.choiceLists.fetchById({id:_38});wdg=_41.name;}else{wdg="";}}return wdg;};bfree.widget.doctype.Editor.generateDefaultWidget=function(_42,_43){var wdg=null;var _44=this._grdPropertyMappings.getItem(_43);var _45=this.documentTypes.isDirty({item:this.activeItem});var _46=this._propMapStore.getValue(_44,"data_type");if(_45){if(_44.choice_list_id[0]!=null){var _47=this.choiceLists.fetchById({id:_44.choice_list_id[0]});wdg=bfree.widget.propdef.Widget.getChoiceListWidget(null,"",_47,true);wdg.onChange=dojo.hitch(this,this._wdgDefault_onChange,this._propMapStore.getIdentity(_44));wdg.set("style",{width:"128px"});wdg.set("required",false);}else{wdg=bfree.widget.propdef.Widget.getWidget(_46,null,"",bfree.widget.propdef.Widget.formats.SHORT,_42);wdg.set("intermediateChanges",false);wdg.onChange=dojo.hitch(this,this._wdgDefault_onChange,this._propMapStore.getIdentity(_44));}}else{wdg=(!_42)?"":_42;}return wdg;};bfree.widget.doctype.Editor.generateRequiredWidget=function(_48,_49){var _4a=this._grdPropertyMappings.getItem(_49);var _4b=this.documentTypes.isDirty({item:this.activeItem});var _4c=this._propMapStore.getValue(_4a,"data_type");return new dijit.form.CheckBox({checked:_48,scrollOnFocus:false,disabled:!_4b||_4c.isText()||_4c.isBoolean(),onChange:dojo.hitch(this,this._chkIsRequired_onChange,this._propMapStore.getIdentity(_4a))});};bfree.widget.doctype.Editor.formatDataType=function(_4d,_4e){return _4d.name;};bfree.widget.doctype.Editor.view1=[{cells:[{field:"sort",name:"&nbsp",width:"16px",hidden:true},{field:"name",name:"Property",width:"auto"},{field:"data_type",name:"Data Type",width:"96px",hidden:true,formatter:bfree.widget.doctype.Editor.formatDataType},{field:"choice_list_id",name:"Choice List",width:"132px",noresize:true,formatter:bfree.widget.doctype.Editor.generateChoiceListWidget},{field:"default_value",name:"Default",width:"128px",noresize:true,formatter:bfree.widget.doctype.Editor.generateDefaultWidget,styles:"padding:0 2px 0 2px;"},{field:"is_required",name:"Required?",width:"64px",formatter:bfree.widget.doctype.Editor.generateRequiredWidget,styles:"text-align:center;"}],width:"auto"}];}