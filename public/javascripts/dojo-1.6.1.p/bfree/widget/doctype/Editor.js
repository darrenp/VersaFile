/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.doctype.Editor"]){dojo._hasResource["bfree.widget.doctype.Editor"]=true;dojo.provide("bfree.widget.doctype.Editor");dojo.require("bfree.api.Application");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.SortGrid");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.doctype.Info");dojo.require("bfree.widget.doctype.PropMapBar");dojo.require("bfree.widget.propdef.List");dojo.require("bfree.widget.propdef.Widget");dojo.require("bfree.widget.Calendar");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.Form");dojo.require("dijit.form.SimpleTextarea");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.doctype.Editor",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/doctype","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoAttachPoint=\"mainNode\"\n        dojoType=\"dijit.layout.BorderContainer\"\n        design=\"headline\"\n        gutters=\"false\"\n        liveSplitters=\"true\"\n        style=\"width:100%;height:100%\">\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"top\"\n            style=\"overflow:hidden;padding:0;height: 76px;\">\n\n         <div dojoAttachPoint=\"formNode\">\n\n            <div dojoAttachPoint=\"tableNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.BorderContainer\"\n            splitter=\"false\"\n            region=\"center\"\n            design=\"sidebar\"\n            gutters=\"false\"\n            liveSplitters=\"true\"\n            style=\"width:100%;height:100%\">\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"center\"\n                style=\"overflow:hidden;padding:16px 8px 8px 0;position:relative\">\n\n            <span class=\"dijitMediumLabel dijitDarkLabel\" style=\"position:absolute;top:0;left:0\">Properties</span>\n            <div dojoAttachPoint=\"propertyMappingsNode\" style=\"height:100%\"></div>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"right\"\n                style=\"overflow:hidden;padding:16px 0 0 0;width:24px\">\n\n            <div dojoAttachPoint=\"propMapBarNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"bottom\"\n            style=\"padding:0 8px 0 8px;height: 104px;\">\n\n        <div dojoAttachPoint=\"infoNode\"></div>\n\n    </div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,activeItem:null,choiceLists:null,documentTypes:null,propertyDefinitions:null,_onNewHandle:null,_onDeleteHandle:null,_onSetHandle:null,_dataTypes:null,_form:null,_propMapStore:null,_cmdBar:null,_grdPropertyMappings:null,_tblProperties:null,_txtDescription:null,_txtName:null,__onPropMapDlgClose:function(_1,_2){if(_1==bfree.widget.Dialog.dialogResult.ok){var _3=null;try{var _4=this._grdPropertyMappings.rowCount;this._grdPropertyMappings.beginUpdate();dojo.forEach(_2,function(id,_5){var _6=this.propertyDefinitions.fetchById({id:id});var _7=this._dataTypes.fetchById({id:_6.data_type_id});var _8;if(_7.isDateTime()){_8=null;}else{if(_7.isBoolean()){_8=false;}else{_8="";}}_3=this._propMapStore.newItem({sort:_4,id:_6.id,name:_6.name,data_type:_7,is_required:false,choice_list_id:null,default_value:_8,default_type:0,max_length:_6.max_length,is_system:_6.is_system,is_name:_6.is_name});_4++;},this);}finally{this._grdPropertyMappings.endUpdate();}if(_3){this._grdPropertyMappings.selectItem(_3);}}return true;},_setActiveItemAttr:function(_9){this.activeItem=_9;this._grdPropertyMappings.selection.clear();if(this.activeItem){this._txtName.set("value",this.activeItem.name);this._txtDescription.set("value",this.activeItem.description);}else{this._txtName.reset();this._txtDescription.reset();}this._cmdBar.set("activeDocType",this.activeItem);this._wdgInfo.set("activeItem",this.activeItem);this._setStore();this._setState();this._grdPropertyMappings.resize();},_setState:function(){var _a=false;var _b=false;if(this.activeItem){_a=this.documentTypes.isDirty({item:this.activeItem});_b=this.activeItem.isNew();}this._txtName.set("disabled",!_a);this._txtDescription.set("disabled",!_a);this._cmdBar.set("disabled",!_a);},_setStore:function(){var _c=[];if(this.activeItem){dojo.forEach(this.activeItem.property_mappings,function(_d,_e){var _f=this.propertyDefinitions.fetchById({id:_d.property_definition_id});var _10=this._dataTypes.fetchById({id:_f.data_type_id});_c.push({sort:_d.sort_order,id:_f.id,name:_f.name,data_type:_10,is_required:_d.is_required,default_value:_d.default_value,default_type:_d.default_type,choice_list_id:_d.choice_list_id,max_length:_f.max_length,is_system:_f.is_system,is_name:_f.is_name});},this);}if(this._onNewHandle){dojo.disconnect(this._onNewHandle);this._onNewHandle=null;}if(this._onDeleteHandle){dojo.disconnect(this._onDeleteHandle);this._onDeleteHandle=null;}if(this._onSetHandle){dojo.disconnect(this._onSetHandle);this._onSetHandle=null;}this._propMapStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:_c}});this._onNewHandle=dojo.connect(this._propMapStore,"onNew",this,this._onPropertyMapCreated);this._onDeleteHandle=dojo.connect(this._propMapStore,"onDelete",this,this._onPropertyMapDeleted);this.__onSetHandle=dojo.connect(this._propMapStore,"onSet",this,this._onPropertyMapUpdated);this._grdPropertyMappings.setStore(this._propMapStore);},_chkIsRequired_onChange:function(id,_11){this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_12){this._propMapStore.setValue(_12,"is_required",_11);})});},_cmbChoiceList_onChange:function(id,_13){this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_14){if(_13==-1){_13=null;}this._propMapStore.setValue(_14,"choice_list_id",_13);this._propMapStore.setValue(_14,"default_type",0);this._propMapStore.setValue(_14,"default_value",null);})});},_grdPropMap_onSelectedItems:function(_15){var _16=null;if(dojo.isArray(_15)&&_15.length>0){_16=_15[0];}this._cmdBar.set("activePropMap",_16);},_onPropMapCommand:function(_17){switch(_17){case bfree.widget.Bfree.Commands.ADD:this._onPropertyMapAdd();break;case bfree.widget.Bfree.Commands.MOVE_UP:this._onPropertyMapUp();break;case bfree.widget.Bfree.Commands.MOVE_DOWN:this._onPropertyMapDown();break;case bfree.widget.Bfree.Commands.REMOVE:this._onPropertyMapRemove();break;}},_onPropertyMapAdd:function(){try{var _18=[];dojo.forEach(this.activeItem.property_mappings,function(_19,idx){_18.push(_19.property_definition_id);},this);bfree.widget.propdef.List.show({filter:_18,propertyDefinitions:this.library.getPropertyDefinitions(),onClose:dojo.hitch(this,this.__onPropMapDlgClose)});}catch(e){var err=new bfree.api.Error("Failed to open 'Property Definitions' dialog",e);bfree.widget.ErrorManager.handleError({error:err});}},_onPropertyMapCreated:function(_1a,_1b){var _1c=this._propMapStore.getValue(_1a,"data_type");this.activeItem.property_mappings.push({sort_order:this._propMapStore.getValue(_1a,"sort"),property_definition_id:this._propMapStore.getIdentity(_1a),is_required:false,choice_list_id:null,default_value:_1c.isBoolean()?false:null,default_type:0});this.onValueChange(this.activeItem,"property_mappings",[],this.activeItem.property_mappings);},_onPropertyMapDeleted:function(_1d){var id=this._propMapStore.getIdentity(_1d);for(var idx=0;idx<this.activeItem.property_mappings.length;idx++){if(this.activeItem.property_mappings[idx].property_definition_id==id){this.activeItem.property_mappings.splice(idx,1);break;}}this.activeItem.property_mappings.sort(bfree.api.PropertyMapping.compare);for(var i=0;i<this.activeItem.property_mappings.length;i++){this.activeItem.property_mappings[i].sort_order=i;}this.onValueChange(this.activeItem,"property_mappings",[],this.activeItem.property_mappings);},_onPropertyMapDown:function(){var _1e=this._grdPropertyMappings.selection.getFirstSelected();if(_1e){this._grdPropertyMappings.moveItem(_1e,bfree.widget.SortGrid.move.DOWN);}var _1f=this._grdPropertyMappings.getItemIndex(_1e);var _20=_1f-1;var _21=this._grdPropertyMappings.getItem(_20);var _22=this._propMapStore.getValue(_1e,"sort");var _23=this._propMapStore.getValue(_21,"sort");for(var i in this.activeItem.property_mappings){if(_1e.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_22;}if(_21.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_23;}}this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);},_onPropertyMapUp:function(){var _24=this._grdPropertyMappings.selection.getFirstSelected();if(_24){this._grdPropertyMappings.moveItem(_24,bfree.widget.SortGrid.move.UP);}var _25=this._grdPropertyMappings.getItemIndex(_24);var _26=_25+1;var _27=this._grdPropertyMappings.getItem(_26);var _28=this._propMapStore.getValue(_24,"sort");var _29=this._propMapStore.getValue(_27,"sort");for(var i in this.activeItem.property_mappings){if(_24.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_28;}if(_27.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_29;}}this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);},_onPropertyMapRemove:function(){if(!confirm("WARNING: There may be data associated with this document property. "+"If you delete this property all data associated with this property will be deleted. "+"Do you wish to continue?")){return;}var idx=0;try{this._grdPropertyMappings.beginUpdate();var _2a=this._grdPropertyMappings.selection.getFirstSelected();idx=this._grdPropertyMappings.getItemIndex(_2a);this._propMapStore.deleteItem(_2a);var _2b=this._propMapStore._arrayOfTopLevelItems;_2b.sort(function(_2c,_2d){return _2c.sort[0]-_2d.sort[0];});for(var i=0;i<_2b.length;i++){if(_2b[i]){this._propMapStore.setValue(_2b[i],"sort",i);}}this._propMapStore.save();}catch(e){var err=new bfree.api.Error("Failed to remove Property Mapping",e);bfree.widget.ErrorManager.handleError({error:err});}finally{this._grdPropertyMappings.endUpdate();}this._grdPropertyMappings.setSelectedIndex(idx);},_onPropertyMapUpdated:function(_2e,_2f,_30,_31){var id=this._propMapStore.getIdentity(_2e);for(var i=0;i<this.activeItem.property_mappings.length;i++){if(this.activeItem.property_mappings[i].property_definition_id==id){if(this.activeItem.property_mappings[i].hasOwnProperty(_2f)){if(this.activeItem.property_mappings[i][_2f]!=_31){this.activeItem.property_mappings[i][_2f]=_31;}}}}this.onValueChange(this.activeItem,"property_mappings",[],this.activeItem.property_mappings);},_txtDescription_onChange:function(_32){if(!this.activeItem){return;}if(this.activeItem.description!=_32){this.documentTypes.store.setValue(this.activeItem,"description",_32);}},_txtName_onChange:function(_33){if(!this.activeItem){return;}if(this.activeItem.name!=_33){this.propertyDefinitions.store.setValue(this.activeItem,"name",_33);}},_wdgDefault_onChange:function(id,_34){var _35=null;this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_36){this._propMapStore.setValue(_36,"default_value",_34);})});for(var i in this.activeItem.property_mappings){if(this.activeItem.property_mappings[i].property_definition_id==id){if(this.activeItem.property_mappings[i].default_value!=_34){this.activeItem.property_mappings[i].default_value=_34;this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);}}}},_wdgDefaultDate_onChange:function(id,_37){var _38=null;for(var i in this.activeItem.property_mappings){if(this.activeItem.property_mappings[i].property_definition_id==id){this.activeItem.property_mappings[i].default_type=_37;if(_37==bfree.api.PropertyMapping.types.date.fixed){this.activeItem.property_mappings[i].default_type=bfree.api.PropertyMapping.types.date.fixed;bfree.widget.Calendar.show({onDateSelected:dojo.hitch(this,function(_39){this.activeItem.property_mappings[i].default_value=_39;this._setStore();this._grdPropertyMappings.refresh();this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_3a){this._propMapStore.setValue(_3a,"default_value",_39);this._propMapStore.setValue(_3a,"default_type",bfree.api.PropertyMapping.types.date.fixed);})});})});}else{if(_37==bfree.api.PropertyMapping.types.date.floating){this.activeItem.property_mappings[i].default_value=0;this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_3b){this._propMapStore.setValue(_3b,"default_value",0);this._propMapStore.setValue(_3b,"default_type",_37);})});}else{if(_37==-1){this.activeItem.property_mappings[i].default_type=bfree.api.PropertyMapping.types.date.fixed;this.activeItem.property_mappings[i].default_value=null;this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_3c){this._propMapStore.setValue(_3c,"default_value",null);this._propMapStore.setValue(_3c,"default_type",bfree.api.PropertyMapping.types.date.fixed);})});}else{return;}}}this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);return;}}},constructor:function(_3d){this._propMapStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:[]}});},destroy:function(){if(this._txtName){this._txtName.destroy();this._txtName=null;}if(this._txtDescription){this._txtDescription.destroy();this._txtDescription=null;}if(this._grdPropertyMappings){this._grdPropertyMappings.destroyDescendants();this._grdPropertyMappings.destroy();this._grdPropertyMappings=null;}if(this._tblProperties){this._tblProperties.destroyDescendants();this._tblProperties.destroy();this._tblProperties=null;}if(this._form){this._form.destroy();this._form=null;}this.inherited("destroy",arguments);},focus:function(){this._txtName.setFocus(true);},onValueChange:function(_3e,_3f,_40,_41){},postCreate:function(){this.inherited("postCreate",arguments);this._dataTypes=bfree.api.Application.getDataTypes();this._form=new dijit.form.Form({id:"docTypeForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:96,style:"width:100%"},this.tableNode);this._txtName=new bfree.widget.ValidationTextBox({label:"Name",required:true,selectOnClick:true,style:"width:100%",trim:true,validator:dojo.hitch(this,this._txtNameValidator),onChange:dojo.hitch(this,this._txtName_onChange)});this._tblProperties.addChild(this._txtName);this._txtDescription=new dijit.form.SimpleTextarea({label:"Description","class":"bfree",rows:2,style:"resize:none;width:100%",onChange:dojo.hitch(this,this._txtDescription_onChange)});this._tblProperties.addChild(this._txtDescription);this._grdPropertyMappings=new bfree.widget.SortGrid({"class":"versaGridOutlineNoPad",query:{},noDataMessage:"No Properties Defined",store:this._propMapStore,sort_field:"sort",structure:bfree.widget.doctype.Editor.view1,formatterScope:this,rowsPerPage:1000,style:"width:100%;height:100%",onSelectedItems:dojo.hitch(this,this._grdPropMap_onSelectedItems)},this.propertyMappingsNode);this._cmdBar=new bfree.widget.doctype.PropMapBar({id:"wdgPropDefBar","class":"versaSidebar",grid:this._grdPropertyMappings,onCommand:dojo.hitch(this,this._onPropMapCommand)},this.propMapBarNode);this._wdgInfo=new bfree.widget.doctype.Info({id:"wdgGroupInfo1"},this.infoNode);this._grdPropertyMappings.startup();},_txtNameValidator:function(_42){if(this._txtName){if(_42.trim()==""){this._txtName.set("invalidMessage","Document type name cannot be blank");return false;}var _43=this.documentTypes.fetch();for(var i=0;i<_43.length;i++){if(_43[i].name&&_43[i].name.toLowerCase().trim()==_42.toLowerCase().trim()&&_43[i].__id!=this.activeItem.__id){this._txtName.set("invalidMessage","Duplicate document type");return false;}}}return true;},resize:function(){this.inherited("resize",arguments);this.mainNode.resize();},startup:function(){this.inherited("startup",arguments);}});bfree.widget.doctype.Editor.generateChoiceListWidget=function(_44,_45){var wdg=null;var _46=this._grdPropertyMappings.getItem(_45);var _47=this._propMapStore.getValue(_46,"data_type");var _48=this.documentTypes.isDirty({item:this.activeItem});if((_48)&&(_47.allow_choice_list)){var _49=this.choiceLists.store.fetch({query:{data_type_id:_47.id},queryOptions:{cache:true,clientFetch:true}}).results;var _4a=new Array();var _4b=new Object();_4b[-1]="None";_4a.push(_4b);for(var i=0;i<_49.length;i++){_4b=new Object();_4b[_49[i].id]=_49[i].name;_4a.push(_4b);}var _4c=new dojox.data.KeyValueStore({dataVar:_4a});wdg=new bfree.widget.FilteringSelect({store:_4c,searchAttr:"name",required:false,value:_44,style:"width:128px",scrollOnFocus:false,onChange:dojo.hitch(this,this._cmbChoiceList_onChange,this._propMapStore.getIdentity(_46))});}else{if(_44){var _4d=this.choiceLists.fetchById({id:_44});wdg=_4d.name;}else{wdg="";}}return wdg;};bfree.widget.doctype.Editor.generateDefaultWidget=function(_4e,_4f){var wdg=null;var _50=this._grdPropertyMappings.getItem(_4f);var _51=this.documentTypes.isDirty({item:this.activeItem});var _52=this._propMapStore.getValue(_50,"data_type");var _53=this._propMapStore.getValue(_50,"default_type");var _54=this._propMapStore.getValue(_50,"max_length");if(_51){if(_50.choice_list_id[0]!=null){var _55=this.choiceLists.fetchById({id:_50.choice_list_id[0]});wdg=bfree.widget.propdef.Widget.getChoiceListWidget(null,"",_55,true,_4e);wdg.onChange=dojo.hitch(this,this._wdgDefault_onChange,this._propMapStore.getIdentity(_50));wdg.set("style",{width:"128px"});wdg.set("required",false);}else{if(_52.isDateTime()){wdg=bfree.widget.doctype.Editor.generateDateTimeDefaultWidget(_4e,_53);wdg.onChange=dojo.hitch(this,this._wdgDefaultDate_onChange,this._propMapStore.getIdentity(_50));}else{wdg=bfree.widget.propdef.Widget.getWidget(_52,null,"",bfree.widget.propdef.Widget.formats.SHORT,_4e,_54);wdg.set("intermediateChanges",false);wdg.set("trim",true);wdg.onChange=dojo.hitch(this,this._wdgDefault_onChange,this._propMapStore.getIdentity(_50));}}}else{if(_52.isDateTime()&&_4e){if(_53==bfree.api.PropertyMapping.types.date.floating){wdg="Current Date";}else{_4e=_4e.split("T");_4e=dojo.date.locale.parse(_4e[0],{datePattern:"yyyy-MM-dd",selector:"date"});wdg=versa.api.Formatter.formatDateTime(_4e);}}else{if(_52.isBoolean()){wdg=bfree.widget.propdef.Widget.getWidget(_52,null,"",bfree.widget.propdef.Widget.formats.SHORT,_4e);wdg.set("disabled",true);}else{wdg=(!_4e)?"":_4e;}}}return wdg;};bfree.widget.doctype.Editor.generateDateTimeDefaultWidget=function(_56,_57){var _58=[];_58.push({id:-1,display:"None"});_58.push({id:0,display:"Fixed Date"});_58.push({id:1,display:"Current Date"});if(_56&&_57==bfree.api.PropertyMapping.types.date.fixed){_58.push({id:_56,display:versa.api.Formatter.formatDateTime(_56)});}var _59=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"display",items:_58}});var def;if(_57==bfree.api.PropertyMapping.types.date.fixed){def=_56?_56:-1;}else{def=bfree.api.PropertyMapping.types.date.floating;}var wdg=new bfree.widget.FilteringSelect({query:{},store:_59,value:def,scrollOnFocus:false,searchAttr:"display",style:"width:100%"});return wdg;};bfree.widget.doctype.Editor.generateRequiredWidget=function(_5a,_5b){var _5c=this._grdPropertyMappings.getItem(_5b);var _5d=this.documentTypes.isDirty({item:this.activeItem});var _5e=this._propMapStore.getValue(_5c,"data_type");return new dijit.form.CheckBox({checked:_5a,scrollOnFocus:false,disabled:!_5d||_5e.isText()||_5e.isBoolean(),onChange:dojo.hitch(this,this._chkIsRequired_onChange,this._propMapStore.getIdentity(_5c))});};bfree.widget.doctype.Editor.formatDataType=function(_5f,_60){return _5f.name;};bfree.widget.doctype.Editor.view1=[{cells:[{field:"sort",name:"&nbsp",width:"16px",hidden:true},{field:"name",name:"Property",width:"auto"},{field:"data_type",name:"Data Type",width:"96px",hidden:true,formatter:bfree.widget.doctype.Editor.formatDataType},{field:"choice_list_id",name:"Choice List",width:"132px",noresize:true,formatter:bfree.widget.doctype.Editor.generateChoiceListWidget},{field:"default_value",name:"Default",width:"128px",noresize:true,formatter:bfree.widget.doctype.Editor.generateDefaultWidget,styles:"padding:0 2px 0 2px;"},{field:"is_required",name:"Required?",width:"64px",formatter:bfree.widget.doctype.Editor.generateRequiredWidget,styles:"text-align:center;"}],width:"auto"}];}