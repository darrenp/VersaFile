/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.doctype.Editor"]){dojo._hasResource["bfree.widget.doctype.Editor"]=true;dojo.provide("bfree.widget.doctype.Editor");dojo.require("bfree.api.Application");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.SortGrid");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.doctype.Info");dojo.require("bfree.widget.doctype.PropMapBar");dojo.require("bfree.widget.propdef.List");dojo.require("bfree.widget.propdef.Widget");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.Form");dojo.require("dijit.form.SimpleTextarea");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.doctype.Editor",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/doctype","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoAttachPoint=\"mainNode\"\n        dojoType=\"dijit.layout.BorderContainer\"\n        design=\"headline\"\n        gutters=\"false\"\n        liveSplitters=\"true\"\n        style=\"width:100%;height:100%\">\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"top\"\n            style=\"overflow:hidden;padding:0;height: 76px;\">\n\n         <div dojoAttachPoint=\"formNode\">\n\n            <div dojoAttachPoint=\"tableNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.BorderContainer\"\n            splitter=\"false\"\n            region=\"center\"\n            design=\"sidebar\"\n            gutters=\"false\"\n            liveSplitters=\"true\"\n            style=\"width:100%;height:100%\">\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"center\"\n                style=\"overflow:hidden;padding:16px 8px 8px 0;position:relative\">\n\n            <span class=\"dijitMediumLabel dijitDarkLabel\" style=\"position:absolute;top:0;left:0\">Properties</span>\n            <div dojoAttachPoint=\"propertyMappingsNode\" style=\"height:100%\"></div>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"right\"\n                style=\"overflow:hidden;padding:16px 0 0 0;width:24px\">\n\n            <div dojoAttachPoint=\"propMapBarNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"bottom\"\n            style=\"padding:0 8px 0 8px;height: 104px;\">\n\n        <div dojoAttachPoint=\"infoNode\"></div>\n\n    </div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,activeItem:null,choiceLists:null,documentTypes:null,propertyDefinitions:null,_onNewHandle:null,_onDeleteHandle:null,_onSetHandle:null,_dataTypes:null,_form:null,_propMapStore:null,_cmdBar:null,_grdPropertyMappings:null,_tblProperties:null,_txtDescription:null,_txtName:null,__onPropMapDlgClose:function(_1,_2){if(_1==bfree.widget.Dialog.dialogResult.ok){var _3=null;try{var _4=this._grdPropertyMappings.rowCount;this._grdPropertyMappings.beginUpdate();dojo.forEach(_2,function(id,_5){var _6=this.propertyDefinitions.fetchById({id:id});var _7=this._dataTypes.fetchById({id:_6.data_type_id});var _8;if(_7.isDateTime()){_8=new Date();}else{_8="";}_3=this._propMapStore.newItem({sort:_4,id:_6.id,name:_6.name,data_type:_7,is_required:false,choice_list_id:null,default_value:_8,is_system:_6.is_system,is_name:_6.is_name});_4++;},this);}finally{this._grdPropertyMappings.endUpdate();}if(_3){this._grdPropertyMappings.selectItem(_3);}}return true;},_setActiveItemAttr:function(_9){this.activeItem=_9;this._grdPropertyMappings.selection.clear();if(this.activeItem){this._txtName.set("value",this.activeItem.name);this._txtDescription.set("value",this.activeItem.description);}else{this._txtName.reset();this._txtDescription.reset();}this._cmdBar.set("activeDocType",this.activeItem);this._wdgInfo.set("activeItem",this.activeItem);this._setStore();this._setState();this._grdPropertyMappings.resize();},_setState:function(){var _a=false;var _b=false;if(this.activeItem){_a=this.documentTypes.isDirty({item:this.activeItem});_b=this.activeItem.isNew();}this._txtName.set("disabled",!_a);this._txtDescription.set("disabled",!_a);this._cmdBar.set("disabled",!_a);},_setStore:function(){var _c=[];if(this.activeItem){dojo.forEach(this.activeItem.property_mappings,function(_d,_e){var _f=this.propertyDefinitions.fetchById({id:_d.property_definition_id});var _10=this._dataTypes.fetchById({id:_f.data_type_id});_c.push({sort:_d.sort_order,id:_f.id,name:_f.name,data_type:_10,is_required:_d.is_required,default_value:_d.default_value,choice_list_id:_d.choice_list_id,is_system:_f.is_system,is_name:_f.is_name});},this);}if(this._onNewHandle){dojo.disconnect(this._onNewHandle);this._onNewHandle=null;}if(this._onDeleteHandle){dojo.disconnect(this._onDeleteHandle);this._onDeleteHandle=null;}if(this._onSetHandle){dojo.disconnect(this._onSetHandle);this._onSetHandle=null;}this._propMapStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:_c}});this._onNewHandle=dojo.connect(this._propMapStore,"onNew",this,this._onPropertyMapCreated);this._onDeleteHandle=dojo.connect(this._propMapStore,"onDelete",this,this._onPropertyMapDeleted);this.__onSetHandle=dojo.connect(this._propMapStore,"onSet",this,this._onPropertyMapUpdated);this._grdPropertyMappings.setStore(this._propMapStore);},_chkIsRequired_onChange:function(id,_11){this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_12){this._propMapStore.setValue(_12,"is_required",_11);})});},_cmbChoiceList_onChange:function(id,_13){this._propMapStore.fetchItemByIdentity({identity:id,onItem:dojo.hitch(this,function(_14){if(_13==-1){_13=null;}this._propMapStore.setValue(_14,"choice_list_id",_13);})});},_grdPropMap_onSelectedItems:function(_15){var _16=null;if(dojo.isArray(_15)&&_15.length>0){_16=_15[0];}this._cmdBar.set("activePropMap",_16);},_onPropMapCommand:function(_17){switch(_17){case bfree.widget.Bfree.Commands.ADD:this._onPropertyMapAdd();break;case bfree.widget.Bfree.Commands.MOVE_UP:this._onPropertyMapUp();break;case bfree.widget.Bfree.Commands.MOVE_DOWN:this._onPropertyMapDown();break;case bfree.widget.Bfree.Commands.REMOVE:this._onPropertyMapRemove();break;}},_onPropertyMapAdd:function(){try{var _18=[];dojo.forEach(this.activeItem.property_mappings,function(_19,idx){_18.push(_19.property_definition_id);},this);bfree.widget.propdef.List.show({filter:_18,propertyDefinitions:this.library.getPropertyDefinitions(),onClose:dojo.hitch(this,this.__onPropMapDlgClose)});}catch(e){var err=new bfree.api.Error("Failed to open 'Property Definitions' dialog",e);bfree.widget.ErrorManager.handleError({error:err});}},_onPropertyMapCreated:function(_1a,_1b){this.activeItem.property_mappings.push({sort_order:this._propMapStore.getValue(_1a,"sort"),property_definition_id:this._propMapStore.getIdentity(_1a),is_required:false,choice_list_id:null});this.onValueChange(this.activeItem,"property_mappings",[],this.activeItem.property_mappings);},_onPropertyMapDeleted:function(_1c){var id=this._propMapStore.getIdentity(_1c);for(var idx=0;idx<this.activeItem.property_mappings.length;idx++){if(this.activeItem.property_mappings[idx].property_definition_id==id){this.activeItem.property_mappings.splice(idx,1);break;}}this.onValueChange(this.activeItem,"property_mappings",[],this.activeItem.property_mappings);},_onPropertyMapDown:function(){var _1d=this._grdPropertyMappings.selection.getFirstSelected();if(_1d){this._grdPropertyMappings.moveItem(_1d,bfree.widget.SortGrid.move.DOWN);}var _1e=this._grdPropertyMappings.getItemIndex(_1d);var _1f=_1e-1;var _20=this._grdPropertyMappings.getItem(_1f);var _21=this._propMapStore.getValue(_1d,"sort");var _22=this._propMapStore.getValue(_20,"sort");for(var i in this.activeItem.property_mappings){if(_1d.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_21;}if(_20.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_22;}}this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);},_onPropertyMapUp:function(){var _23=this._grdPropertyMappings.selection.getFirstSelected();if(_23){this._grdPropertyMappings.moveItem(_23,bfree.widget.SortGrid.move.UP);}var _24=this._grdPropertyMappings.getItemIndex(_23);var _25=_24+1;var _26=this._grdPropertyMappings.getItem(_25);var _27=this._propMapStore.getValue(_23,"sort");var _28=this._propMapStore.getValue(_26,"sort");for(var i in this.activeItem.property_mappings){if(_23.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_27;}if(_26.id[0]==this.activeItem.property_mappings[i].property_definition_id){this.activeItem.property_mappings[i].sort_order=_28;}}this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);},_onPropertyMapRemove:function(){var idx=0;try{this._grdPropertyMappings.beginUpdate();var _29=this._grdPropertyMappings.selection.getFirstSelected();idx=this._grdPropertyMappings.getItemIndex(_29);this._propMapStore.deleteItem(_29);this._propMapStore.save();}catch(e){var err=new bfree.api.Error("Failed to remove Property Mapping",e);bfree.widget.ErrorManager.handleError({error:err});}finally{this._grdPropertyMappings.endUpdate();}this._grdPropertyMappings.setSelectedIndex(idx);},_onPropertyMapUpdated:function(_2a,_2b,_2c,_2d){var id=this._propMapStore.getIdentity(_2a);for(var i=0;i<this.activeItem.property_mappings.length;i++){if(this.activeItem.property_mappings[i].property_definition_id==id){if(this.activeItem.property_mappings[i].hasOwnProperty(_2b)){if(this.activeItem.property_mappings[i][_2b]!=_2d){this.activeItem.property_mappings[i][_2b]=_2d;}}}}this.onValueChange(this.activeItem,"property_mappings",[],this.activeItem.property_mappings);},_txtDescription_onChange:function(_2e){if(!this.activeItem){return;}if(this.activeItem.description!=_2e){this.documentTypes.store.setValue(this.activeItem,"description",_2e);}},_txtName_onChange:function(_2f){if(!this.activeItem){return;}if(this.activeItem.name!=_2f){this.propertyDefinitions.store.setValue(this.activeItem,"name",_2f);}},_wdgDefault_onChange:function(id,_30){var _31=null;for(var i in this.activeItem.property_mappings){if(this.activeItem.property_mappings[i].property_definition_id==id){if(this.activeItem.property_mappings[i].default_value!=_30){this.activeItem.property_mappings[i].default_value=_30;this.documentTypes.setValue(this.activeItem,"property_mappings",this.activeItem.property_mappings);}}}},constructor:function(_32){this._propMapStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:[]}});},destroy:function(){if(this._txtName){this._txtName.destroy();this._txtName=null;}if(this._txtDescription){this._txtDescription.destroy();this._txtDescription=null;}if(this._grdPropertyMappings){this._grdPropertyMappings.destroyDescendants();this._grdPropertyMappings.destroy();this._grdPropertyMappings=null;}if(this._tblProperties){this._tblProperties.destroyDescendants();this._tblProperties.destroy();this._tblProperties=null;}if(this._form){this._form.destroy();this._form=null;}this.inherited("destroy",arguments);},focus:function(){this._txtName.setFocus(true);},onValueChange:function(_33,_34,_35,_36){},postCreate:function(){this.inherited("postCreate",arguments);this._dataTypes=bfree.api.Application.getDataTypes();this._form=new dijit.form.Form({id:"docTypeForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:96,style:"width:100%"},this.tableNode);this._txtName=new bfree.widget.ValidationTextBox({label:"Name",required:true,selectOnClick:true,style:"width:100%",trim:true,validator:dojo.hitch(this,this._txtNameValidator),onChange:dojo.hitch(this,this._txtName_onChange)});this._tblProperties.addChild(this._txtName);this._txtDescription=new dijit.form.SimpleTextarea({label:"Description","class":"bfree",rows:2,style:"resize:none;width:100%",onChange:dojo.hitch(this,this._txtDescription_onChange)});this._tblProperties.addChild(this._txtDescription);this._grdPropertyMappings=new bfree.widget.SortGrid({"class":"versaGridOutlineNoPad",query:{},noDataMessage:"No Properties Defined",store:this._propMapStore,sort_field:"sort",structure:bfree.widget.doctype.Editor.view1,formatterScope:this,rowsPerPage:1000,style:"width:100%;height:100%",onSelectedItems:dojo.hitch(this,this._grdPropMap_onSelectedItems)},this.propertyMappingsNode);this._cmdBar=new bfree.widget.doctype.PropMapBar({id:"wdgPropDefBar","class":"versaSidebar",grid:this._grdPropertyMappings,onCommand:dojo.hitch(this,this._onPropMapCommand)},this.propMapBarNode);this._wdgInfo=new bfree.widget.doctype.Info({id:"wdgGroupInfo1"},this.infoNode);this._grdPropertyMappings.startup();},_txtNameValidator:function(_37){if(this._txtName){if(_37.trim()==""){this._txtName.set("invalidMessage","Document type name cannot be blank");return false;}var _38=this.documentTypes.fetch();for(var i=0;i<_38.length;i++){if(_38[i].name&&_38[i].name.toLowerCase().trim()==_37.toLowerCase().trim()&&_38[i].__id!=this.activeItem.__id){this._txtName.set("invalidMessage","Duplicate document type");return false;}}}return true;},resize:function(){this.inherited("resize",arguments);this.mainNode.resize();},startup:function(){this.inherited("startup",arguments);}});bfree.widget.doctype.Editor.generateChoiceListWidget=function(_39,_3a){var wdg=null;var _3b=this._grdPropertyMappings.getItem(_3a);var _3c=this._propMapStore.getValue(_3b,"data_type");var _3d=this.documentTypes.isDirty({item:this.activeItem});if((_3d)&&(_3c.allow_choice_list)){var _3e=this.choiceLists.store.fetch({query:{data_type_id:_3c.id},queryOptions:{cache:true,clientFetch:true}}).results;var _3f=new Array();var _40=new Object();_40[-1]="None";_3f.push(_40);for(var i=0;i<_3e.length;i++){_40=new Object();_40[_3e[i].id]=_3e[i].name;_3f.push(_40);}var _41=new dojox.data.KeyValueStore({dataVar:_3f});wdg=new bfree.widget.FilteringSelect({store:_41,searchAttr:"name",required:false,value:_39,style:"width:128px",scrollOnFocus:false,onChange:dojo.hitch(this,this._cmbChoiceList_onChange,this._propMapStore.getIdentity(_3b))});}else{if(_39){var _42=this.choiceLists.fetchById({id:_39});wdg=_42.name;}else{wdg="";}}return wdg;};bfree.widget.doctype.Editor.generateDefaultWidget=function(_43,_44){var wdg=null;var _45=this._grdPropertyMappings.getItem(_44);var _46=this.documentTypes.isDirty({item:this.activeItem});var _47=this._propMapStore.getValue(_45,"data_type");if(_46){if(_45.choice_list_id[0]!=null){var _48=this.choiceLists.fetchById({id:_45.choice_list_id[0]});wdg=bfree.widget.propdef.Widget.getChoiceListWidget(null,"",_48,true);wdg.onChange=dojo.hitch(this,this._wdgDefault_onChange,this._propMapStore.getIdentity(_45));wdg.set("style",{width:"128px"});wdg.set("required",false);}else{wdg=bfree.widget.propdef.Widget.getWidget(_47,null,"",bfree.widget.propdef.Widget.formats.SHORT,_43);wdg.set("intermediateChanges",false);wdg.onChange=dojo.hitch(this,this._wdgDefault_onChange,this._propMapStore.getIdentity(_45));}}else{wdg=(!_43)?"":_43;}return wdg;};bfree.widget.doctype.Editor.generateRequiredWidget=function(_49,_4a){var _4b=this._grdPropertyMappings.getItem(_4a);var _4c=this.documentTypes.isDirty({item:this.activeItem});var _4d=this._propMapStore.getValue(_4b,"data_type");return new dijit.form.CheckBox({checked:_49,scrollOnFocus:false,disabled:!_4c||_4d.isText()||_4d.isBoolean(),onChange:dojo.hitch(this,this._chkIsRequired_onChange,this._propMapStore.getIdentity(_4b))});};bfree.widget.doctype.Editor.formatDataType=function(_4e,_4f){return _4e.name;};bfree.widget.doctype.Editor.view1=[{cells:[{field:"sort",name:"&nbsp",width:"16px",hidden:true},{field:"name",name:"Property",width:"auto"},{field:"data_type",name:"Data Type",width:"96px",hidden:true,formatter:bfree.widget.doctype.Editor.formatDataType},{field:"choice_list_id",name:"Choice List",width:"132px",noresize:true,formatter:bfree.widget.doctype.Editor.generateChoiceListWidget},{field:"default_value",name:"Default",width:"128px",noresize:true,formatter:bfree.widget.doctype.Editor.generateDefaultWidget,styles:"padding:0 2px 0 2px;"},{field:"is_required",name:"Required?",width:"64px",formatter:bfree.widget.doctype.Editor.generateRequiredWidget,styles:"text-align:center;"}],width:"auto"}];}