/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.Uploader"]){dojo._hasResource["bfree.widget.Uploader"]=true;dojo.provide("bfree.widget.Uploader");dojo.require("bfree.api.Uploader");dojo.require("bfree.api.Utilities");dojo.require("dojox.form.Uploader");if(!dojo.isIE||bfree.api.Uploader.useFlash()){dojo["require"]("dojox.form.uploader.plugins.Flash");}else{dojo["require"]("bfree.widget.IFrame");dojox.form.addUploaderPlugin(bfree.widget.IFrame);}dojo.declare("bfree.widget.Uploader",dojox.form.Uploader,{documents:0,maxDocuments:100,size:0,maxSize:314572800,devMode:false,isDebug:false,serverTimeout:60000,_createFlashUploader:function(){var _1=this.getUrl();if(_1){if(_1.toLowerCase().indexOf("http")<0&&_1.indexOf("/")!=0){var _2=window.location.href.split("/");_2.pop();_2=_2.join("/")+"/";_1=_2+_1;}}else{console.warn("Warning: no uploadUrl provided.");}this.inputNode=dojo.create("div",{className:"dojoxFlashNode"},this.domNode,"first");dojo.style(this.inputNode,{position:"absolute",top:"-2px",width:this.btnSize.w+"px",height:this.btnSize.h+"px",opacity:0});var w=this.btnSize.w+8;var h=this.btnSize.h+8;var _3={expressInstall:true,path:(this.swfPath.uri||this.swfPath)+"?cb_"+(new Date().getTime()),width:w,height:h,allowScriptAccess:"always",allowNetworking:"all",vars:{uploadDataFieldName:this.flashFieldName||this.name+"Flash",uploadUrl:_1,uploadOnSelect:this.uploadOnSelect,deferredUploading:this.deferredUploading||0,selectMultipleFiles:this.multiple,id:this.id,devMode:this.devMode,isDebug:this.isDebug,serverTimeout:this.serverTimeout},params:{scale:"noscale",wmode:"transparent",wmode:"opaque",allowScriptAccess:"always",allowNetworking:"all"}};this.flashObject=new dojox.embed.Flash(_3,this.inputNode);this.flashObject.onError=dojo.hitch(function(_4){console.error("Flash Error: "+_4);});this.flashObject.onReady=dojo.hitch(this,function(){this.onReady(this);});this.flashObject.onLoad=dojo.hitch(this,function(_5){this.flashMovie=_5;this.flashReady=true;this.onLoad(this);});this._connectFlash();},_upload:function(_6){var _7=this.checkFiles(_6);if(_7<0){return;}this.onBeforeUpload(_6);if(this.uploadType=="iframe"){this.upload({preventDefault:function(){},stopPropagation:function(){}});}else{this.upload({authenticity_token:bfree.api.XhrHelper.authenticity_token,upload_type:this.uploadType});}},checkFiles:function(_8){if((this.documents+_8.length)>this.maxDocuments){alert(dojo.replace("You can only upload {0} documents at once.",[this.maxDocuments]));this.reset();if(this.flashObject){this.flashObject.movie.reset();this._files=[];this._fileMap={};}return -1;}this.documents+=_8.length;var _9=0;var _a=false;dojo.forEach(_8,function(_b){_9+=_b.size;if(_b.name.indexOf("+")>0||_b.name.indexOf("%")>0){_a=true;}},this);if(_a){alert("Files containing the + or % characters are not allowed.");this.reset();if(this.flashObject){this.flashObject.movie.reset();this._files=[];this._fileMap={};}return -1;}if(this.size+_9>this.maxSize){alert(dojo.replace("You can only upload {0} at once.",[bfree.api.Utilities.readablizeBytes({bytes:this.maxSize})]));this.reset();if(this.flashObject){this.flashObject.movie.reset();this._files=[];this._fileMap={};}return -1;}return 1;},uploadExternal:function(_c){var _d=this.checkFiles(_c);if(_d<0){return;}var fd=new FormData();var _e=[];fd.append("upload_type","html5");fd.append("authenticity_token",bfree.api.XhrHelper.authenticity_token);dojo.forEach(_c,function(f,i){fd.append("uploadedfiles[]",f);_e.push({index:i,name:f.name,size:f.size,type:f.type});},this);this.onBeforeUpload(_c);this.onBegin(_e);var _f=this.createXhr();_f.send(fd);},onAfterUpload:function(_10){},onBeforeUpload:function(_11){},constructor:function(_12){this.documents=0;this.uploadOnSelect=false;if(dojo.isOpera){this.force="iframe";}if(dojo.isIE&&!bfree.api.Uploader.useFlash()){this.onError=dojo.hitch(this,function(err){this.reset();this.onErrorUpload(err);});}},onErrorUpload:function(err){},onChange:function(evt){var _13=bfree.widget.Uploader.buildUploadFnRef(this,evt);setTimeout(_13,1000);},onComplete:function(evt){var _14=[];try{this.reset();if(evt.hasOwnProperty("uploadedfiles")){_14=evt.uploadedfiles;}else{if(bfree.api.Utilities.isArray(evt)){for(var i=0;i<evt.length;i++){_14.push({name:decodeURI(evt[i].name),content_type:evt[i].type,size:evt[i].size,error:evt[i].error});}}else{_14.push({name:decodeURI(evt.name),content_type:evt.type,size:evt.size,error:evt.error});}}}catch(e){}this.onAfterUpload(_14);},onProgress:function(evt){},beforeUpload:function(){},onUploadComplete:function(_15){},postCreate:function(){if(this.uploadType=="html5"){var _16=this.uploadOnSelect;this.connectForm();this.inherited("postCreate",arguments);this.uploadOnSelect=_16;if(this.uploadOnSelect){dojo.connect(this,"onChange",function(_17){this.upload(_17[0]);});}}else{this.inherited("postCreate",arguments);}},uploadFlash:function(_18){this.onBegin(this.getFileList());this.flashMovie.doUpload(_18);}});bfree.widget.Uploader.buildUploadFnRef=function(_19,evt){return (function(){_19._upload(evt);});};}