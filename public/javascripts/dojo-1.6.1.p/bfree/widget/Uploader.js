/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.Uploader"]){dojo._hasResource["bfree.widget.Uploader"]=true;dojo.provide("bfree.widget.Uploader");dojo.require("bfree.api.Uploader");dojo.require("bfree.api.Utilities");dojo.require("dojox.form.Uploader");if(bfree.api.Uploader.useFlash()){dojo["require"]("dojox.form.uploader.plugins.Flash");}else{dojo["require"]("dojox.form.uploader.plugins.IFrame");}dojo.declare("bfree.widget.Uploader",dojox.form.Uploader,{documents:0,maxDocuments:50,_createFlashUploader:function(){var _1=this.getUrl();if(_1){if(_1.toLowerCase().indexOf("http")<0&&_1.indexOf("/")!=0){var _2=window.location.href.split("/");_2.pop();_2=_2.join("/")+"/";_1=_2+_1;}}else{}this.inputNode=dojo.create("div",{className:"dojoxFlashNode"},this.domNode,"first");dojo.style(this.inputNode,{position:"absolute",top:"-2px",width:this.btnSize.w+"px",height:this.btnSize.h+"px",opacity:0});var w=this.btnSize.w+8;var h=this.btnSize.h+8;var _3={expressInstall:true,path:(this.swfPath.uri||this.swfPath)+"?cb_"+(new Date().getTime()),width:w,height:h,allowScriptAccess:"always",allowNetworking:"all",vars:{uploadDataFieldName:this.flashFieldName||this.name+"Flash",uploadUrl:_1,uploadOnSelect:this.uploadOnSelect,deferredUploading:this.deferredUploading||0,selectMultipleFiles:this.multiple,id:this.id,isDebug:this.isDebug,noReturnCheck:this.skipServerCheck,serverTimeout:this.serverTimeout},params:{scale:"noscale",wmode:"transparent",wmode:"opaque",allowScriptAccess:"always",allowNetworking:"all"}};this.flashObject=new dojox.embed.Flash(_3,this.inputNode);this.flashObject.onError=dojo.hitch(function(_4){});this.flashObject.onReady=dojo.hitch(this,function(){this.onReady(this);});this.flashObject.onLoad=dojo.hitch(this,function(_5){this.flashMovie=_5;this.flashReady=true;this.onLoad(this);});this._connectFlash();},_upload:function(_6){if((this.documents+_6.length)>this.maxDocuments){alert(dojo.replace("You can only upload {0} documents at once.",[this.maxDocuments]));return;}this.documents+=_6.length;this.onBeforeUpload(_6);if(this.uploadType=="iframe"){this.upload({preventDefault:function(){},stopPropagation:function(){}});}else{this.upload({authenticity_token:bfree.api.XhrHelper.authenticity_token,upload_type:this.uploadType});}},onAfterUpload:function(_7){},onBeforeUpload:function(_8){},constructor:function(_9){this.documents=0;this.uploadOnSelect=false;if(dojo.isOpera){this.force="iframe";}},onChange:function(_a){var _b=bfree.widget.Uploader.buildUploadFnRef(this,_a);setTimeout(_b,1000);},onComplete:function(_c){var _d=[];try{this.reset();if(_c.hasOwnProperty("uploadedfiles")){_d=_c.uploadedfiles;}else{if(bfree.api.Utilities.isArray(_c)){for(var i=0;i<_c.length;i++){_d.push({file:decodeURIComponent(_c[i].file),name:decodeURIComponent(_c[i].name),content_type:_c[i].type,size:_c[i].size});}}else{_d.push({file:decodeURIComponent(_c.file),name:decodeURIComponent(_c.name),content_type:_c.type,size:_c.size});}}}catch(e){}this.onAfterUpload(_d);},onProgress:function(_e){},beforeUpload:function(){},onUploadComplete:function(_f){},postCreate:function(){if(this.uploadType=="html5"){var _10=this.uploadOnSelect;this.connectForm();this.inherited("postCreate",arguments);this.uploadOnSelect=_10;if(this.uploadOnSelect){dojo.connect(this,"onChange",function(_11){this.upload(_11[0]);});}}else{this.inherited("postCreate",arguments);}},uploadFlash:function(_12){this.onBegin(this.getFileList());this.flashMovie.doUpload(_12);}});bfree.widget.Uploader.buildUploadFnRef=function(_13,evt){return (function(){_13._upload(evt);});};}