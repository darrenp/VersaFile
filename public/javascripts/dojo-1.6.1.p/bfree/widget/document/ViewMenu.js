/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.document.ViewMenu"]){dojo._hasResource["bfree.widget.document.ViewMenu"]=true;dojo.provide("bfree.widget.document.ViewMenu");dojo.require("bfree.widget.HeaderMenu");dojo.declare("bfree.widget.document.ViewMenu",bfree.widget.HeaderMenu,{templateString:"<div style=\"height: 400px; overflow-y: auto; overflow-x: hidden;\">"+dojo.cache("dijit","templates/Menu.html","<table class=\"dijit dijitMenu dijitMenuPassive dijitReset dijitMenuTable\" role=\"menu\" tabIndex=\"${tabIndex}\" dojoAttachEvent=\"onkeypress:_onKeyPress\" cellspacing=\"0\">\n\t<tbody class=\"dijitReset\" dojoAttachPoint=\"containerNode\"></tbody>\n</table>\n")+"</div>",menuLabel:"Views",user:null,library:null,activeView:null,activeFolder:null,rowHit:false,viewDefinitions:null,viewMappings:null,propertyDefinitions:null,parentMenu:null,cancelRefresh:false,_mnuTemplate:null,_mnuTemplatePopup:null,_buildViewMenus:function(){var _1=this.viewDefinitions.fetch();_1=_1.sort(bfree.api.ViewDefinition.compare);dojo.forEach(_1,function(_2){if(!_2.name){return;}if(_2.is_template){var _3="menuIcon menuViewIcon";var _4=new dijit.MenuItem({iconClass:_3,label:_2.name,onClick:dojo.hitch(this,this._onChange,_4,_2)});_4.set("viewDefinition",_2);this._mnuTemplate.addChild(_4);}},this);},_buildColumnMenus:function(){var _5=this.propertyDefinitions.fetch();var _6=function(){return this.table_name+"."+this.column_name;};_5.push({id:"document_types.name",name:"Document Type",table_name:"document_types",column_name:"name",data_type_id:bfree.api.DataTypes.types.STRING,getDbName:_6});_5.push({id:"versions.version_number",name:"Version",table_name:"versions",column_name:"version_number",data_type_id:bfree.api.DataTypes.types.STRING,getDbName:_6});_5.push({id:"versions.binary_file_size",name:"Size",table_name:"versions",column_name:"binary_file_size",data_type_id:bfree.api.DataTypes.types.INTEGER,format_id:bfree.api.CellDefinition.formats.size,getDbName:_6});_5.sort(bfree.api.PropertyDefinition.compare);dojo.forEach(_5,function(_7){if(_7.data_type_id!=bfree.api.DataTypes.types.TEXT){if(!_7.name){return;}var _8="menuIcon menuViewIcon";var _9=new dijit.MenuItem({propertyDefinition:_7,iconClass:_8,label:_7.name,onClick:dojo.hitch(this,this._onColumnToggle,_7)});this.addChild(_9);}},this);},_onColumnToggle:function(_a){var _b=this.library.getViewDefinitions().fetchById({id:this.activeView.id});var _c=_b.getCellByField(_a.getDbName());this.onColumnToggle(_a,!_c);},_onCommand:function(_d,_e,_f){this.onCommand(_d,_e,_f);},_openMyself:function(){this.inherited("_openMyself",arguments);var _10=this.domNode.children[0];if(this.domNode.offsetHeight<_10.offsetHeight){this.domNode.style.width=(_10.offsetWidth+15)+"px";this.domNode.style.height="400px";}else{this.domNode.style.width="";this.domNode.style.height=(_10.offsetHeight-1)+"px";}},clear:function(){dojo.forEach(this.getChildren(),function(_11,idx){},this);},onColumnToggle:function(_12,_13){},onCommand:function(_14,_15,_16){},_onChange:function(mni,_17,evt){var _18=_17.getView(this.library);this.set("activeView",_18);this.onChange(this.activeView);},_setActiveFolderAttr:function(_19){this.activeFolder=_19;},_setActiveViewAttr:function(_1a){this.activeView=_1a;if(this.activeView){this.updateMenu();}},constructor:function(_1b){this.parentMenu=_1b.parentMenu;},getSelectedId:function(){var _1c=this._mnuTemplate.getChildren();var id;for(var i=0;i<_1c.length;i++){if(_1c[i].set("iconClass")=="menuIcon bfreeIconOk"){id=_1c[i].viewDefId;}}return id||-1;},onChange:function(_1d,evt){},postCreate:function(){this.inherited("postCreate",arguments);this.propertyDefinitions=this.library.getPropertyDefinitions();this.viewDefinitions=this.library.getViewDefinitions();this._mnuTemplate=new dijit.Menu({});this._mnuTemplatePopup=new dijit.PopupMenuItem({label:"Predefined Views",popup:this._mnuTemplate,iconClass:"menuIcon"});this.addChild(this._mnuTemplatePopup);this._buildViewMenus();this._seperator1=new dijit.MenuSeparator();this.addChild(this._seperator1);this._buildColumnMenus();},refresh:function(){this.clear();var _1e=this._mnuTemplate.getChildren();while(_1e.length>0){var _1f=_1e.pop();this._mnuTemplate.removeChild(_1f);}this._buildViewMenus();this._buildColumnMenus();this.set("activeView",this.activeView);},startup:function(){this.inherited("startup",arguments);},updateMenu:function(){var _20=false;dojo.forEach(this._mnuTemplate.getChildren(),function(_21,idx){if(_21.viewDefinition.id==this.activeView.id){_21.set("iconClass","menuIcon bfreeIconOk");_20=true;}else{_21.set("iconClass","menuIcon bfreeIconBlank");}},this);(_20)?this._mnuTemplatePopup.set("iconClass","menuIcon bfreeIconOk"):this._mnuTemplatePopup.set("iconClass","menuIcon bfreeIconBlank");var _22=this.library.getViewDefinitions().fetchById({id:this.activeView.id});dojo.forEach(this.getChildren(),function(_23,idx){var _24=_23.propertyDefinition;if(_24){var _25=_22.getCellByField(_24.getDbName());(_25)?_23.set("iconClass","menuIcon bfreeIconOk"):_23.set("iconClass","menuIcon bfreeIconBlank");}},this);}});}