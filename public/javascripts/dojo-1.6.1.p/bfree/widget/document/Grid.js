/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.document.Grid"]){dojo._hasResource["bfree.widget.document.Grid"]=true;dojo.provide("bfree.widget.document.Grid");dojo.require("dojo.date.locale");dojo.require("bfree.api.Search");dojo.require("bfree.widget._Grid");dojo.require("bfree.widget.Utils");dojo.require("bfree.widget.document.ContextMenu");dojo.require("bfree.widget.document.Move");dojo.require("bfree.widget.document.ViewMenu");dojo.declare("bfree.widget.document.Grid",bfree.widget._Grid,{_documents:null,library:null,activeView:null,activeFolder:null,zone:null,dndType:"Document",activeQuery:null,minWidth:256,_canSort:function(_1){if(_1==1||this._isLoading){return false;}else{return true;}},_setStructureAttr:function(_2){this.inherited("_setStructureAttr",arguments);if(this._isLoaded){this.auto();}},_onCommand:function(_3,_4,_5){this.onCommand(_3,_4,_5);},_onNew:function(_6,_7){if(!_6["declaredClass"]){_6=this._documents.refreshItem((_6.$ref?_6.$ref:_6.id));}this.inherited("_onNew",[_6,_7]);},_onRowContextMenu:function(_8){if((this._mnuDocument==null)||(_8.rowIndex<0)){this._mnuDocument.rowHit=false;_8.cancelBubble=true;}else{if(!this.selection.isSelected(_8.rowIndex)){this.selection.clear();this.selection.addToSelection(_8.rowIndex);}var _9=this.selection.getSelected();this._mnuDocument.rowHit=true;this._mnuDocument.set("activeItems",_9);}},_onViewChange:function(_a,_b){this.focus.findAndFocusGridCell();this.activeView=_a;if(this.query){this.query.view=this.activeView.id;}this.set("sortInfo",this.activeView.sort_column);this.set("structure",this.activeView);this.onViewChange(this.activeView);},auto:function(){var _c=this.getCell(2);var _d=_c.getHeaderNode();if(_d.offsetWidth<this.minWidth){if(this.structure.cells[2].width=="auto"){this.structure.cells[2].width=this.minWidth+"px";this.set("sortInfo",this.activeView.sort_column);this.set("structure",this.activeView);}}},_onViewNew:function(_e){this.onViewNew(_e);},_setActiveFolderAttr:function(_f){this.activeFolder=_f;this._mnuDocument.set("activeFolder",_f);},_setActiveQueryAttr:function(_10){_10["view"]=this.activeView.id;this.setQuery(_10,{cache:false});this.setSelectedIndex(0,true);},sort:function(){this.setQuery(this.query,{cache:false});},constructor:function(_11){this.updateDelay=0;this.rowsPerPage=25;this.queryOptions={cache:false};this.selectionMode="extended";this.clientSort=false;this.canSort=this._canSort;this.noDataMessage="No Documents Found";},export_results:function(_12){var box=bfree.api.Utilities.getBox({scale:0.75});var _13=this.getSortProps();this._documents.export_query({zone:this.zone,library:this.library,windowBox:box,type:_12,query:this.get("query"),sort:((_13)&&(_13.length>0))?_13[0]:null});},initialize:function(){this.setStore(this._documents.store,{type:bfree.api.Search.types.NONE});},postCreate:function(){this.inherited("postCreate",arguments);this._documents=this.library.getDocuments();var _14=this.library.getViewDefinitions().fetch()[0];this.activeView=_14.getView(this.library);this._mnuDocument=new bfree.widget.document.ContextMenu({onCommand:dojo.hitch(this,this._onCommand),activeLibrary:this.library,activeUser:this.user,documents:this._documents,refresh:dojo.hitch(this,this.refresh),targetNodeIds:[this.id]});this._mnuView=new bfree.widget.document.ViewMenu({library:this.library,viewDefinitions:this.library.getViewDefinitions(),parentMenu:this});this._mnuView.startup();this.onRowContextMenu=dojo.hitch(this,this._onRowContextMenu);this._mnuView.onChange=dojo.hitch(this,this._onViewChange);this.onHeaderContextMenu=dojo.hitch(this,this._onHeaderContextMenu);this._mnuView.set("activeView",this.activeView);this.set("headerMenu",this._mnuView);},onCommand:function(_15,_16,_17){},onRowDblClick:function(evt){if(evt.rowIndex<0){evt.cancelBubble=true;return;}var _18=this.getItem(evt.rowIndex);this._onCommand(bfree.widget.Bfree.Commands.VIEW,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{documents:[_18]});},onViewChange:function(_19,evt){},onViewNew:function(evt){},_onHeaderContextMenu:function(evt){this._mnuView.rowHit=true;},refreshViews:function(){this._mnuView.refresh();},print_results:function(){var box=bfree.api.Utilities.getBox({scale:0.75});var _1a=this.getSortProps();this._documents.print_query({zone:this.zone,library:this.library,windowBox:box,query:this.get("query"),sort:((_1a)&&(_1a.length>0))?_1a[0]:null});},setBusy:function(_1b,_1c){var idx=this.getItemIndex(_1b);if(idx<0){return;}if(_1c){var _1d=this.getRowNode(idx);var e=_1d.getElementsByTagName("img");dojo.forEach(e,function(_1e,idx){if(_1e.name=="statusIcon"){dojo.attr(_1e,"src","/images/loading/loading16.gif");}});}else{this.updateRow(idx);}},startup:function(){this.inherited("startup",arguments);}});}