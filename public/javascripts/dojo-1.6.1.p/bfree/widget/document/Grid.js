/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.document.Grid"]){dojo._hasResource["bfree.widget.document.Grid"]=true;dojo.provide("bfree.widget.document.Grid");dojo.require("dojo.date.locale");dojo.require("bfree.api.Search");dojo.require("bfree.widget._Grid");dojo.require("bfree.widget.Utils");dojo.require("bfree.widget.document.ContextMenu");dojo.require("bfree.widget.document.Move");dojo.require("bfree.widget.document.ViewMenu");dojo.require("dojo.dnd.Source");dojo.declare("bfree.widget.document.Grid",bfree.widget._Grid,{_dndSource:null,_documents:null,_formatStore:null,viewDefinitions:null,user:null,library:null,activeView:null,activeViewDefinition:null,activeFolder:null,zone:null,dndType:"Document",activeQuery:null,minWidth:256,deleting:false,cancelRefresh:false,_buildFormatStore:function(){this._formatStore=bfree.api.Utilities.getFormatStore();},_canSort:function(_1){if(_1==1||this._isLoading){return false;}else{return true;}},_dndCreator:function(_2,_3){},_setStructureAttr:function(_4){this.inherited("_setStructureAttr",arguments);},_onCommand:function(_5,_6,_7){this.onCommand(_5,_6,_7);},_onNew:function(_8,_9){if(!_8["declaredClass"]){_8=this._documents.refreshItem((_8.$ref?_8.$ref:_8.id));}this.inherited("_onNew",[_8,_9]);},_onSelectionChanged:function(){this.inherited("onSelectionChanged",arguments);},_onRowContextMenu:function(_a){if((this._mnuDocument==null)||(_a.rowIndex<0)){this._mnuDocument.rowHit=false;_a.cancelBubble=true;}else{var _b=this.selection.getSelected();if(this.selection.isSelected(_a.rowIndex)){this.onSelectedItems(_b);}else{this.setSelectedIndex(_a.rowIndex);_b=this.selection.getSelected();}this._mnuDocument.rowHit=true;this._mnuDocument.set("activeItems",_b);}},_onViewChange:function(_c,_d){this.focus.findAndFocusGridCell();this.activeView=_c;this.activeViewDefinition=this.viewDefinitions.fetchById({id:_c.id});if(this.query){this.query.view=this.activeView.id;}this.set("sortInfo",this.activeView.sort_column);this.set("structure",this.activeView);this.onViewChange(this.activeView);},_setActiveFolderAttr:function(_e){if(this._isLoaded){this.activeFolder=_e;var _f=this.viewMappings.getMapping(this.activeFolder.id,this.user.id);var _10;if(_f.view_definition_id){_10=this.library.getViewDefinitions().fetchById({id:_f.view_definition_id});}if(!_10){_10=this.library.getViewDefinitions().query({query:{is_system:true}})[0];}this.activeView=_10.getView(this.library);this.cancelRefresh=true;this.set("activeQuery",_e.getActiveQuery().getQuery());this.set("sortInfo",_f.sort_column?_f.sort_column:_10.sort_column);this.cancelRefresh=false;this._mnuView.set("activeView",this.activeView);this._mnuView.set("activeFolder",this.activeFolder);}},_refresh:function(_11){if(!this.cancelRefresh){this.inherited(arguments);}},_onViewChange:function(_12,evt){this.focus.findAndFocusGridCell();this.activeView=_12;this.activeViewDefinition=this.viewDefinitions.fetchById({id:_12.id});if(this.query){this.query["view"]=this.activeView.id;}this.set("structure",this.activeView);this.onViewChange(_12);},_onViewNew:function(evt){this.onViewNew(evt);},_setActiveQueryAttr:function(_13){_13["view"]=this.activeView.id;this.setQuery(_13,{cache:false});this.setSelectedIndex(0,true);},sort:function(){this.setQuery(this.query,{cache:false});var _14=this.viewMappings.getMapping(this.activeFolder.id,this.user.id);this.viewMappings.setValue(_14,"sort_column",this.sortInfo);this.viewMappings.save();},constructor:function(_15){this.updateDelay=0;this.rowsPerPage=25;this.queryOptions={cache:false};this.selectionMode="extended";this.clientSort=false;this.canSort=this._canSort;this.noDataMessage="No Documents Found";this.activeFolder=_15.folder;},export_results:function(_16){var box=bfree.api.Utilities.getBox({scale:0.75});var _17=this.getSortProps();this._documents.export_query({zone:this.zone,library:this.library,windowBox:box,type:_16,query:this.get("query"),sort:((_17)&&(_17.length>0))?_17[0]:null});},postCreate:function(){this.inherited("postCreate",arguments);this._documents=this.library.getDocuments();this.viewDefinitions=this.library.getViewDefinitions();this._buildFormatStore();this._mnuDocument=new bfree.widget.document.ContextMenu({onCommand:dojo.hitch(this,this._onCommand),activeLibrary:this.library,activeUser:this.user,documents:this._documents,refresh:dojo.hitch(this,this.refresh),targetNodeIds:[this.id]});this._mnuView=new bfree.widget.document.ViewMenu({user:this.user,library:this.library,viewDefinitions:this.library.getViewDefinitions(),viewMappings:this.library.getViewMappings(),propertyDefinitions:this.library.getPropertyDefinitions(),onCommand:dojo.hitch(this,this.onViewCommand),parentMenu:this,grid:this});this._mnuView.startup();this.onRowContextMenu=dojo.hitch(this,this._onRowContextMenu);this._mnuView.onChange=dojo.hitch(this,this._onViewChange);this.onHeaderContextMenu=dojo.hitch(this,this._onHeaderContextMenu);this.set("headerMenu",this._mnuView);},onCommand:function(_18,_19,_1a){},onViewCommand:function(_1b,_1c){switch(_1b){case bfree.widget.Bfree.Commands.COLUMN_TOGGLE:this._toggleColumn(_1c.menu,_1c.property);break;case bfree.widget.Bfree.Commands.COLUMN_RESIZE:this._resizeColumn(_1c.column);break;case bfree.widget.Bfree.Commands.COLUMN_REORDER:this._reorderColumn(_1c.source,_1c.destination);break;}},onRowDblClick:function(evt){if(evt.rowIndex<0){evt.cancelBubble=true;return;}var _1d=this.getItem(evt.rowIndex);this._onCommand(bfree.widget.Bfree.Commands.VIEW,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{documents:[_1d]});},_copyView:function(){if(this.activeViewDefinition.is_template){var _1e=this.activeViewDefinition.cell_definitions;this.activeViewDefinition=this.viewDefinitions.create({cell_definitions:[],created_by:this.user.name,is_system:false,is_template:false,library_id:this.activeViewDefinition.library_id,name:this.activeViewDefinition.name,scope:this.activeViewDefinition.scope,sort_by:this.activeViewDefinition.sort_by,updated_by:this.user.name});dojo.forEach(_1e,function(_1f){this.activeViewDefinition.cell_definitions.push({column_name:_1f.column_name,column_order:_1f.column_order,date_format:_1f.date_format,formatter:_1f.formatter,label:_1f.label,name:_1f.name,noresize:_1f.noresize,style:_1f.style,table_name:_1f.table_name,width:_1f.width});},this);this.viewDefinitions.save();var _20=this.viewMappings.getMapping(this.activeFolder.id,this.user.id);this.viewMappings.setValue(_20,"view_definition_id",this.activeViewDefinition.id);this.viewMappings.save();if(this.query){this.query["view"]=this.activeViewDefinition.id;}this._mnuView.activeViewDefinition=this.activeViewDefinition;this.activeViewDefinition._view=null;this._mnuView.activeView=this.activeViewDefinition.getView(this.library);this._mnuView.updateMenu();}},_toggleColumn:function(mni,_21){this._copyView();for(var i=0;i<this.activeViewDefinition.cell_definitions.length;i++){if(this.activeViewDefinition.cell_definitions[i].table_name&&this.activeViewDefinition.cell_definitions[i].column_name&&_21.table_name==this.activeViewDefinition.cell_definitions[i].table_name&&_21.column_name==this.activeViewDefinition.cell_definitions[i].column_name){this.activeViewDefinition.cell_definitions.removeByValue(this.activeViewDefinition.cell_definitions[i]);this.viewDefinitions.setValue(this.activeViewDefinition,"cell_definitions",this.activeViewDefinition.cell_definitions);this.viewDefinitions.save();this.activeViewDefinition._view=null;this._mnuView.set("activeView",this.activeViewDefinition.getView(this.library));mni.set("iconClass","menuIcon menuViewIcon");this.viewDefinitions.save();return;}}var _22={id:_21.getDbName(),table_name:_21.table_name,column_name:_21.column_name,name:_21.name,label:_21.name,formatter:_21.format_id?_21.format_id:bfree.api.CellDefinition.formats.none,noresize:false,width:bfree.api.CellDefinitions.getDefaultWidth(_21.data_type_id)+"px",style:"",column_order:this.activeViewDefinition.cell_definitions.length};this.activeViewDefinition.cell_definitions.push(_22);this.viewDefinitions.setValue(this.activeViewDefinition,"cell_definitions",this.activeViewDefinition.cell_definitions);this.viewDefinitions.save();this.activeViewDefinition._view=null;this._mnuView.set("activeView",this.activeViewDefinition.getView(this.library));mni.set("iconClass","menuIcon bfreeIconOk");return;},_reorderColumn:function(_23,_24){this._copyView();var _25=this.activeViewDefinition.cell_definitions[_23];var _26=this.activeViewDefinition.cell_definitions[_24];var _27=_26.column_order;_25.column_order=_27;if(_23>_24){_23--;for(var i=_23;i>=_24;i--){this.activeViewDefinition.cell_definitions[i].column_order++;}}else{_23++;for(var i=_23;i<=_24;i++){this.activeViewDefinition.cell_definitions[i].column_order--;}}this.activeViewDefinition.cell_definitions.sort(bfree.api.CellDefinition.compare);this.viewDefinitions.setValue(this.activeViewDefinition,"cell_definitions",this.activeViewDefinition.cell_definitions);this.viewDefinitions.save();this.set("structure",this.activeViewDefinition.getView(this.library));},_resizeColumn:function(_28){this._copyView();this.activeViewDefinition.cell_definitions[_28].width=this.layout.cells[_28].unitWidth;this.viewDefinitions.setValue(this.activeViewDefinition,"cell_definitions",this.activeViewDefinition.cell_definitions);this.viewDefinitions.save();},initialize:function(){this.setStore(this._documents.store,{type:bfree.api.Search.types.NONE});},onResizeColumn:function(_29){this.onViewCommand(bfree.widget.Bfree.Commands.COLUMN_RESIZE,{column:_29});},onMoveColumn:function(one,two,_2a,_2b,_2c){this._copyView();if(_2a>_2b){if(!_2c){_2b++;}}else{if(_2c){_2b--;}}this.onViewCommand(bfree.widget.Bfree.Commands.COLUMN_REORDER,{source:_2a,destination:_2b});},onViewChange:function(_2d,evt){},onViewNew:function(evt){},_onHeaderContextMenu:function(evt){this._mnuView.rowHit=true;},refreshViews:function(){this._mnuView.refresh();},print_results:function(){var box=bfree.api.Utilities.getBox({scale:0.75});var _2e=this.getSortProps();this._documents.print_query({zone:this.zone,library:this.library,windowBox:box,query:this.get("query"),sort:((_2e)&&(_2e.length>0))?_2e[0]:null});},setBusy:function(_2f,_30){var idx=this.getItemIndex(_2f);if(idx<0){return;}if(_30){var _31=this.getRowNode(idx);var e=_31.getElementsByTagName("img");dojo.forEach(e,function(_32,idx){if(_32.name=="statusIcon"){dojo.attr(_32,"src","/images/loading/loading16.gif");}});}else{this.updateRow(idx);}},startup:function(){this.inherited("startup",arguments);}});}