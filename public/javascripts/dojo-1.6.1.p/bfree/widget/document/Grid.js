/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.document.Grid"]){dojo._hasResource["bfree.widget.document.Grid"]=true;dojo.provide("bfree.widget.document.Grid");dojo.require("dojo.date.locale");dojo.require("bfree.api.Search");dojo.require("bfree.widget._Grid");dojo.require("bfree.widget.Utils");dojo.require("bfree.widget.document.ContextMenu");dojo.require("bfree.widget.document.Move");dojo.require("bfree.widget.document.ViewMenu");dojo.declare("bfree.widget.document.Grid",bfree.widget._Grid,{_documents:null,library:null,activeView:null,activeFolder:null,zone:null,dndType:"Document",activeQuery:null,minWidth:256,deleting:false,_canSort:function(_1){if(_1==1||this._isLoading){return false;}else{return true;}},_setStructureAttr:function(_2){this.inherited("_setStructureAttr",arguments);if(this._isLoaded){this.auto();}},_onCommand:function(_3,_4,_5){this.onCommand(_3,_4,_5);},selectItem:function(_6){},_onRowContextMenu:function(_7){if((this._mnuDocument==null)||(_7.rowIndex<0)){this.rowHit=false;_7.cancelBubble=true;}else{var _8=this.selection.selected[_7.rowIndex];var _9;if(_8){if(this.selection.getSelectedCount()==1){_9=this.getItem(_7.rowIndex);}else{_9=this.selection.getSelected();}this.setSelectedIndex(_7.rowIndex);}else{this.selection.clear();_9=this.getItem(_7.rowIndex);this.selection.select(_7.rowIndex);this._mnuDocument.rowHit=true;this._mnuDocument.activeItem=_9;this._mnuDocument.activeFolder=this.activeFolder;}this._mnuDocument.rowHit=true;this._mnuDocument.activeItem=_9;this._mnuDocument.activeFolder=this.activeFolder;}},_onViewChange:function(_a,_b){this.focus.findAndFocusGridCell();this.activeView=_a;this.set("structure",_a);this.set("sortInfo",_a.sort_column);if(this.query){this.query.view=this.activeView.id;}this.onViewChange(_a);},render:function(){this.inherited("render",arguments);},auto:function(){var _c=this.getCell(2);var _d=_c.getHeaderNode();if(_d.offsetWidth<this.minWidth){if(this.structure.cells[2].width=="auto"){this.structure.cells[2].width=this.minWidth+"px";this.set("structure",this.structure);}}},_onViewNew:function(_e){this.onViewNew(_e);},_setActiveQueryAttr:function(_f){_f["view"]=this.activeView.id;this.setQuery(_f,{cache:false});},sort:function(){this.setQuery(this.query,{cache:false});},constructor:function(_10){_10=(!_10)?{}:_10;dojo.safeMixin(this,_10);this.updateDelay=0;this.rowsPerPage=25;this.queryOptions={cache:false};this.selectionMode="extended";this.clientSort=false;this.canSort=this._canSort;this.noDataMessage="No Documents Found";},export_results:function(_11){var box=bfree.api.Utilities.getBox({scale:0.75});var _12=this.getSortProps();this._documents.export_query({zone:this.zone,library:this.library,windowBox:box,type:_11,query:this.get("query"),sort:((_12)&&(_12.length>0))?_12[0]:null});},postCreate:function(){this.inherited("postCreate",arguments);this._documents=this.library.getDocuments();var _13=this.library.getViewDefinitions().fetch()[0];this.activeView=_13.getView(this.library);this._mnuDocument=new bfree.widget.document.ContextMenu({onCommand:dojo.hitch(this,this._onCommand),activeLibrary:this.library,activeUser:this.user,documents:this._documents,refresh:dojo.hitch(this,this.refresh),targetNodeIds:[this.id]});this._mnuView=new bfree.widget.document.ViewMenu({library:this.library,viewDefinitions:this.library.getViewDefinitions(),parentMenu:this});this._mnuView.startup();this.onRowContextMenu=dojo.hitch(this,this._onRowContextMenu);this._mnuView.onChange=dojo.hitch(this,this._onViewChange);this.onHeaderContextMenu=dojo.hitch(this,this._onHeaderContextMenu);this._mnuView.set("activeView",this.activeView);this.set("headerMenu",this._mnuView);},onCommand:function(_14,_15,_16){},onRowDblClick:function(evt){if(evt.rowIndex<0){evt.cancelBubble=true;return;}var _17=this.getItem(evt.rowIndex);this._onCommand(bfree.widget.Bfree.Commands.VIEW,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{document:_17});},onViewChange:function(_18,evt){},onViewNew:function(evt){},_onHeaderContextMenu:function(evt){this._mnuView.rowHit=true;},refreshViews:function(){this._mnuView.refresh();},print_results:function(){var box=bfree.api.Utilities.getBox({scale:0.75});var _19=this.getSortProps();this._documents.print_query({zone:this.zone,library:this.library,windowBox:box,query:this.get("query"),sort:((_19)&&(_19.length>0))?_19[0]:null});},setBusy:function(_1a){var idx=this.getItemIndex(_1a);var _1b=this.getRowNode(idx);var e=_1b.getElementsByTagName("img");dojo.forEach(e,function(_1c,idx){if(_1c.name=="statusIcon"){dojo.attr(_1c,"src","/images/loading/loading16.gif");}});},startup:function(){this.inherited("startup",arguments);this.setStore(this._documents.store,{type:bfree.api.Search.types.NONE});}});}