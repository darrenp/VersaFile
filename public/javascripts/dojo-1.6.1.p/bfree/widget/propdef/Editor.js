/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.propdef.Editor"]){dojo._hasResource["bfree.widget.propdef.Editor"]=true;dojo.provide("bfree.widget.propdef.Editor");dojo.require("bfree.api.Application");dojo.require("bfree.api.DataTypes");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.FilteringSelect");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.propdef.Info");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.Form");dojo.require("dijit.form.SimpleTextarea");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.propdef.Editor",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/propdef","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoAttachPoint=\"mainNode\"\n        dojoType=\"dijit.layout.BorderContainer\"\n        design=\"headline\"\n        gutters=\"false\"\n        liveSplitters=\"true\"\n        style=\"width:100%;height:100%\">\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"center\"\n            style=\"overflow:hidden;padding:0\">\n\n         <div dojoAttachPoint=\"formNode\">\n\n            <div dojoAttachPoint=\"tableNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"bottom\"\n            style=\"overflow:hidden;height: 104px;\">\n\n        <div dojoAttachPoint=\"infoNode\"></div>\n\n    </div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,activeItem:null,propertyDefinitions:null,_dataTypes:null,_form:null,_cmbDataType:null,_tblProperties:null,_txtDescription:null,_txtMaxLength:null,_txtName:null,_wdgInfo:null,_resetMaxLength:function(_1,_2){var _3={min:0,max:0,places:0,pattern:"#"};if((_1.isString())||(_1.isText())){_3["min"]=1;_3["max"]=_1.defaultMaxLength();this._txtMaxLength.set("disabled",false);this._txtMaxLength.set("constraints",_3);}else{this._txtMaxLength.set("disabled",true);}this._txtMaxLength.set("value",_2);},_setActiveItemAttr:function(_4){this.activeItem=_4;this._txtName.set("value",this.activeItem.name);if(this.activeItem.data_type_id){this._cmbDataType.set("value",this.activeItem.data_type_id);}else{this._cmbDataType.reset();this._cmbDataType.validate();}this._txtMaxLength.set("value",this.activeItem.max_length);this._txtDescription.set("value",this.activeItem.description);this._wdgInfo.set("activeItem",this.activeItem);this._setState();},_setState:function(){var _5=this.propertyDefinitions.isDirty({item:this.activeItem});var _6=this.activeItem.isNew();var _7=(this.activeItem.data_type_id)?this._dataTypes.fetchById({id:this.activeItem.data_type_id}):null;var _8=((_5)&&(_7!=null)&&(_7.isString()));this._txtName.set("disabled",!_5);this._cmbDataType.set("disabled",!(_5&&_6));this._txtMaxLength.set("disabled",!(_8));this._txtDescription.set("disabled",!_5);},_cmbDataType_onChange:function(_9){if((_9==null)||_9==""){return;}var _a=(_9==null)?-1:parseInt(_9);if(this.activeItem.data_type_id!=_a){var _b=this._dataTypes.fetchById({id:_a});this.propertyDefinitions.store.setValue(this.activeItem,"data_type_id",_a);this.propertyDefinitions.store.setValue(this.activeItem,"max_length",_b.defaultMaxLength());this._resetMaxLength(_b,this.activeItem.max_length);}},_txtDescription_onChange:function(_c){if(!this.activeItem||(this.activeItem.description==null&&_c=="")){return;}if(this.activeItem.description!=_c){this.propertyDefinitions.store.setValue(this.activeItem,"description",_c);}},_txtMaxLength_onChange:function(_d){if(this._txtMaxLength.constraints["max"]<_d){_d=this._txtMaxLength.constraints["max"];this._txtMaxLength.set("value",_d);}if(this._txtMaxLength.constraints["min"]>_d){_d=this._txtMaxLength.constraints["min"];this._txtMaxLength.set("value",_d);}if(!this.activeItem){return;}if((!isNaN(_d))&&(this.activeItem.max_length!=_d)){this.propertyDefinitions.store.setValue(this.activeItem,"max_length",_d);}},_txtName_onChange:function(_e){if(!this.activeItem){return;}if(this.activeItem.name!=_e){this.propertyDefinitions.store.setValue(this.activeItem,"name",_e);}this._txtName.validate();},constructor:function(_f){},destroy:function(){if(this._txtName){this._txtName.destroy();this._txtName=null;}if(this._cmbDataType){this._cmbDataType.destroy();this._cmbDataType=null;}if(this._txtMaxLength){this._txtMaxLength.destroy();this._txtMaxLength=null;}if(this._txtDescription){this._txtDescription.destroy();this._txtDescription=null;}if(this._tblProperties){this._tblProperties.destroyRecursive();this._tblProperties=null;}if(this._form){this._form.destroy();this._form=null;}this.inherited("destroy",arguments);},focus:function(){this._txtName.setFocus(true);},onValueChange:function(_10,_11,_12,_13){},postCreate:function(){this.inherited("postCreate",arguments);this._dataTypes=bfree.api.Application.getDataTypes();this._form=new dijit.form.Form({id:"propDefForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:112,style:"width:100%"},this.tableNode);this._txtName=new bfree.widget.ValidationTextBox({label:"Name",intermediateChanges:true,selectOnClick:true,style:"width:100%",required:true,validator:dojo.hitch(this,this._txtNameValidator),onChange:dojo.hitch(this,this._txtName_onChange)});this._tblProperties.addChild(this._txtName);this._cmbDataType=new bfree.widget.FilteringSelect({label:"Data Type",store:this._dataTypes.store,searchAttr:"name",required:true,style:"width:100%",onChange:dojo.hitch(this,this._cmbDataType_onChange)});this._tblProperties.addChild(this._cmbDataType);this._txtMaxLength=new dijit.form.NumberSpinner({customClass:"bfree",label:"Maximum Length",constraints:{min:1,max:255,places:0,pattern:"#"},value:255,disabled:false,style:"width:100%",onChange:dojo.hitch(this,this._txtMaxLength_onChange)});this._tblProperties.addChild(this._txtMaxLength);this._txtDescription=new dijit.form.SimpleTextarea({label:"Description",intermediateChanges:true,"class":"bfree",style:"resize:none;width:100%",onChange:dojo.hitch(this,this._txtDescription_onChange)});this._tblProperties.addChild(this._txtDescription);this._wdgInfo=new bfree.widget.propdef.Info({id:"wdgInfo1"},this.infoNode);},_txtNameValidator:function(_14){if(this.activeItem){var _15=this.propertyDefinitions.fetch();for(var i=0;i<_15.length;i++){if(_15[i].name.toLowerCase().trim()==_14.toLowerCase().trim()&&_15[i].__id!=this.activeItem.__id){this._txtName.set("invalidMessage","Duplicate property definition name");return false;}}this._txtName.set("invalidMessage",null);return true;}},resize:function(){this.inherited("resize",arguments);this.mainNode.resize();},startup:function(){this.inherited("startup",arguments);this._tblProperties.startup();}});}