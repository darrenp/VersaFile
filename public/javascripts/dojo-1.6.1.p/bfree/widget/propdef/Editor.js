/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.propdef.Editor"]){dojo._hasResource["bfree.widget.propdef.Editor"]=true;dojo.provide("bfree.widget.propdef.Editor");dojo.require("bfree.api.Application");dojo.require("bfree.api.DataTypes");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.FilteringSelect");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.propdef.Info");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.Form");dojo.require("dijit.form.SimpleTextarea");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.propdef.Editor",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/propdef","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoAttachPoint=\"mainNode\"\n        dojoType=\"dijit.layout.BorderContainer\"\n        design=\"headline\"\n        gutters=\"false\"\n        liveSplitters=\"true\"\n        style=\"width:100%;height:100%\">\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"center\"\n            style=\"overflow:hidden;padding:0\">\n\n         <div dojoAttachPoint=\"formNode\">\n\n            <div dojoAttachPoint=\"tableNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"bottom\"\n            style=\"overflow:hidden;height: 104px;\">\n\n        <div dojoAttachPoint=\"infoNode\"></div>\n\n    </div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,activeItem:null,propertyDefinitions:null,_dataTypes:null,_form:null,_cmbDataType:null,_tblProperties:null,_txtDescription:null,_txtMaxLength:null,_txtName:null,_wdgInfo:null,_resetMaxLength:function(_1,_2,_3){var _4={min:0,max:0,places:0,pattern:"#"};if((_1.isString())||(_1.isText())){_4["min"]=1;_4["max"]=_1.defaultMaxLength();this._txtMaxLength.set("disabled",_3);this._txtMaxLength.set("constraints",_4);}else{this._txtMaxLength.set("disabled",true);}this._txtMaxLength.set("value",_2);},_setActiveItemAttr:function(_5){this.activeItem=_5;this._txtName.set("value",this.activeItem.name);if(this.activeItem.data_type_id){this._cmbDataType.set("value",this.activeItem.data_type_id);var _6=this._dataTypes.fetchById({id:this.activeItem.data_type_id});this._resetMaxLength(_6,this.activeItem.max_length,true);}else{this._cmbDataType.reset();this._cmbDataType.validate();}this._txtDescription.set("value",this.activeItem.description);this._wdgInfo.set("activeItem",this.activeItem);this._setState();},_setState:function(){var _7=this.propertyDefinitions.isDirty({item:this.activeItem});var _8=this.activeItem.isNew();var _9=(this.activeItem.data_type_id)?this._dataTypes.fetchById({id:this.activeItem.data_type_id}):null;var _a=((_7)&&(_9!=null)&&(_9.isString()));this._txtName.set("disabled",!_7);this._cmbDataType.set("disabled",!(_7&&_8));this._txtMaxLength.set("disabled",!(_a));this._txtDescription.set("disabled",!_7);},_cmbDataType_onChange:function(_b){if((_b==null)||_b==""){return;}var _c=(_b==null)?-1:parseInt(_b);if(this.activeItem.data_type_id!=_c){var _d=this._dataTypes.fetchById({id:_c});this.propertyDefinitions.store.setValue(this.activeItem,"data_type_id",_c);this.propertyDefinitions.store.setValue(this.activeItem,"max_length",_d.defaultMaxLength());this._resetMaxLength(_d,this.activeItem.max_length,false);}},_txtDescription_onChange:function(_e){if(!this.activeItem||(this.activeItem.description==null&&_e=="")){return;}if(this.activeItem.description!=_e){this.propertyDefinitions.store.setValue(this.activeItem,"description",_e);}},_txtMaxLength_onChange:function(_f){if(this._txtMaxLength.constraints["max"]<_f){_f=this._txtMaxLength.constraints["max"];this._txtMaxLength.set("value",_f);}if(this._txtMaxLength.constraints["min"]>_f){_f=this._txtMaxLength.constraints["min"];this._txtMaxLength.set("value",_f);}if(!this.activeItem){return;}if((!isNaN(_f))&&(this.activeItem.max_length!=_f)){this.propertyDefinitions.store.setValue(this.activeItem,"max_length",_f);}},_txtName_onChange:function(_10){if(!this.activeItem){return;}if(this.activeItem.name!=_10){this.propertyDefinitions.store.setValue(this.activeItem,"name",_10);}this._txtName.validate();},constructor:function(_11){},destroy:function(){if(this._txtName){this._txtName.destroy();this._txtName=null;}if(this._cmbDataType){this._cmbDataType.destroy();this._cmbDataType=null;}if(this._txtMaxLength){this._txtMaxLength.destroy();this._txtMaxLength=null;}if(this._txtDescription){this._txtDescription.destroy();this._txtDescription=null;}if(this._tblProperties){this._tblProperties.destroyRecursive();this._tblProperties=null;}if(this._form){this._form.destroy();this._form=null;}this.inherited("destroy",arguments);},focus:function(){this._txtName.setFocus(true);},onValueChange:function(_12,_13,_14,_15){},postCreate:function(){this.inherited("postCreate",arguments);this._dataTypes=bfree.api.Application.getDataTypes();this._form=new dijit.form.Form({id:"propDefForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:112,style:"width:100%"},this.tableNode);this._txtName=new bfree.widget.ValidationTextBox({label:"Name",intermediateChanges:true,selectOnClick:true,style:"width:100%",required:true,trim:true,validator:dojo.hitch(this,this._txtNameValidator),onChange:dojo.hitch(this,this._txtName_onChange)});this._tblProperties.addChild(this._txtName);this._cmbDataType=new bfree.widget.FilteringSelect({label:"Data Type",store:this._dataTypes.store,searchAttr:"name",required:true,style:"width:100%",onChange:dojo.hitch(this,this._cmbDataType_onChange)});this._tblProperties.addChild(this._cmbDataType);this._txtMaxLength=new dijit.form.NumberSpinner({customClass:"bfree",label:"Maximum Length",constraints:{min:1,max:255,places:0,pattern:"#"},value:255,disabled:false,style:"width:100%",onChange:dojo.hitch(this,this._txtMaxLength_onChange)});this._tblProperties.addChild(this._txtMaxLength);this._txtDescription=new dijit.form.SimpleTextarea({label:"Description",intermediateChanges:true,"class":"bfree",style:"resize:none;width:100%",onChange:dojo.hitch(this,this._txtDescription_onChange)});this._tblProperties.addChild(this._txtDescription);this._wdgInfo=new bfree.widget.propdef.Info({id:"wdgInfo1"},this.infoNode);},_txtNameValidator:function(_16){if(this._txtName){if(_16.trim()==""){this._txtName.set("invalidMessage","Property definition name cannot be blank");return false;}if(this.activeItem){var _17=this.propertyDefinitions.fetch();for(var i=0;i<_17.length;i++){if(_17[i].name&&_17[i].name.toLowerCase().trim()==_16.toLowerCase().trim()&&_17[i].__id!=this.activeItem.__id){this._txtName.set("invalidMessage","Duplicate property definition name");return false;}}this._txtName.set("invalidMessage",null);}}return true;},resize:function(){this.inherited("resize",arguments);this.mainNode.resize();},startup:function(){this.inherited("startup",arguments);this._tblProperties.startup();}});}