/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.group.Editor"]){dojo._hasResource["bfree.widget.group.Editor"]=true;dojo.provide("bfree.widget.group.Editor");dojo.require("bfree.widget.SortGrid");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.group.Info");dojo.require("bfree.widget.group.UserBar");dojo.require("bfree.widget.user.List");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.require("dojox.layout.TableContainer");dojo.declare("bfree.widget.group.Editor",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/group","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoAttachPoint=\"mainNode\"\n        dojoType=\"dijit.layout.BorderContainer\"\n        design=\"headline\"\n        gutters=\"false\"\n        liveSplitters=\"true\"\n        style=\"width:100%;height:100%\">\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"top\"\n            style=\"overflow:hidden;padding:0;height: 100px;\">\n\n         <div dojoAttachPoint=\"formNode\">\n\n            <div dojoAttachPoint=\"tableNode\"></div>\n\n        </div>\n\n        Users:\n    </div>\n\n    <div    dojoType=\"dijit.layout.BorderContainer\"\n            splitter=\"false\"\n            region=\"center\"\n            design=\"sidebar\"\n            gutters=\"false\"\n            liveSplitters=\"true\"\n            style=\"width:100%;height:100%\">\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"center\">\n\n            <div dojoAttachPoint=\"userGridNode\"></div>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"right\"\n                style=\"overflow:hidden;padding:16px 0 0 0;width:24px\">\n\n            <div dojoAttachPoint=\"userBarNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"bottom\"\n            style=\"padding:0 8px 0 8px;height: 112px;\">\n\n        <div dojoAttachPoint=\"infoNode\"></div>\n\n    </div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,_handles:[],_cmdBar:null,_form:null,_grdUsers:null,_tblProperties:null,_txtDescription:null,_txtName:null,_userStore:null,_wdgInfo:null,activeItem:null,groups:null,users:null,__onUserDlgClose:function(_1,_2){var _3=null;if(_1==bfree.widget.Dialog.dialogResult.ok){try{this._grdUsers.beginUpdate();dojo.forEach(_2,function(id){var _4=this.users.fetchById({id:id});var _5=this._userStore.newItem({id:_4.id,name:_4.getFullName(),is_admin:_4.is_admin});},this);}finally{this._grdUsers.endUpdate();}}if(_3){this._grdUsers.setSelectedItem(_3);}return true;},_grdUsers_onSelectedItem:function(_6){this._cmdBar.set("activeUser",_6);},_onUserCommand:function(_7){switch(_7){case bfree.widget.Bfree.Commands.ADD:this._onUserAdd();break;case bfree.widget.Bfree.Commands.REMOVE:this._onUserRemove();}},_onUserAdd:function(){try{var _8=[];var _9=this.users.getAdmin();_8.push(_9.id);dojo.forEach(this.activeItem.active_users,function(_a,_b){_8.push(_a.user_id);},this);bfree.widget.user.List.show({users:this.users,filter:_8,onClose:dojo.hitch(this,this.__onUserDlgClose)});}catch(e){var _c=new bfree.api.Error("Failed to open 'Users' dialog",e);bfree.widget.ErrorManager.handleError({error:_c});}},_onUserCreated:function(_d,_e){var _f=this.groups.fetch();dojo.forEach(_f,function(_10,idx){for(var i=0;i<_10.active_users.length;i++){if(!_10.is_everyone){if(_10.active_users[i].user_id==this._userStore.getIdentity(_d)){_10.active_users.removeByValue(_10.active_users[i]);break;}}}},this);this.activeItem.active_users.push({user_id:this._userStore.getIdentity(_d)});this.onValueChange(this.activeItem,"active_users",[],this.activeItem.active_users);},_onUserDeleted:function(_11){for(var idx=0;idx<this.activeItem.active_users.length;idx++){var id=this._userStore.getIdentity(_11);if(this.activeItem.active_users[idx].user_id==id){this.activeItem.active_users.splice(idx,1);break;}}this.onValueChange(this.activeItem,"active_users",[],this.activeItem.active_users);},_onUserRemove:function(_12){var idx=0;try{this._grdUsers.beginUpdate();var _12=this._grdUsers.selection.getFirstSelected();idx=this._grdUsers.getItemIndex(_12);this._userStore.deleteItem(_12);}catch(e){var err=new bfree.api.Error("Failed to remove User",e);bfree.widget.ErrorManager.handleError({error:err});}finally{this._grdUsers.endUpdate();}},_onValueChange:function(_13,_14){if(!this.activeItem){return;}var _15=this.users.getValue(this.activeItem,_13);if(_15!=_14){this.users.store.setValue(this.activeItem,_13,_14);this.onValueChange(this.activeItem,_13,_15,_14);}},_setActiveItemAttr:function(_16){this.activeItem=_16;this._txtName.set("value",this.activeItem.name);this._txtDescription.set("value",this.activeItem.description);this._setStore();this._cmdBar.set("activeGroup",this.activeItem);this._wdgInfo.set("activeItem",this.activeItem);this._setState();},_setState:function(){var _17=this.groups.isDirty({item:this.activeItem});this._txtName.set("disabled",!_17);this._txtDescription.set("disabled",!_17);this._grdUsers.set("disabled",!_17);this._cmdBar.set("disabled",!_17);},_setStore:function(){var _18=[];dojo.forEach(this.activeItem.active_users,function(_19,idx){var _1a=this.users.fetchById({id:_19.user_id});_18.push({id:_1a.id,name:_1a.getFullName(),is_admin:_1a.is_admin});},this);dojo.forEach(this._handles,function(_1b,idx){dojo.disconnect(_1b);delete this._handles[idx];},this);this._userStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:_18}});this._handles[0]=dojo.connect(this._userStore,"onNew",this,this._onUserCreated);this._handles[1]=dojo.connect(this._userStore,"onDelete",this,this._onUserDeleted);this._grdUsers.setStore(this._userStore);},constructor:function(_1c){this._userStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"name",items:[]}});},destroy:function(){this.destroyDescendants();if(this._tblProperties){this._tblProperties.destroyRecursive();this._tblProperties=null;}if(this._form){this._form.destroy();this._form=null;}if(this._wdgInfo){this._wdgInfo.destroy();this._wdgInfo=null;}this.inherited("destroy",arguments);},focus:function(){this._txtName.setFocus(true);},onValueChange:function(_1d,_1e,_1f,_20){},postCreate:function(){this.inherited("postCreate",arguments);this._form=new dijit.form.Form({id:"groupForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblGroup1",customClass:"versa",showLabels:true,cols:1,labelWidth:96,style:"width:100%"},this.tableNode);this._txtName=new bfree.widget.ValidationTextBox({id:"txtName",label:"Name",required:true,intermediateChanges:true,selectOnClick:true,style:"width:100%",trim:true,validator:dojo.hitch(this,this._txtNameValidator),onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._txtName);this._txtDescription=new dijit.form.SimpleTextarea({label:"Description","class":"bfree",style:"resize:none;width:100%",onChange:dojo.hitch(this,this._onValueChange,"description")});this._tblProperties.addChild(this._txtDescription);this._grdUsers=new bfree.widget._Grid({id:"grdGroupUsers","class":"versaGridOutline versaNoHeader",query:{},noDataMessage:"No Users in Group",store:this._userStore,structure:bfree.widget.group.Editor.view1,formatterScope:this,sortInfo:2,rowsPerPage:1000,style:"width:100%;height:100%",onSelectedItem:dojo.hitch(this,this._grdUsers_onSelectedItem)},this.userGridNode);this._cmdBar=new bfree.widget.group.UserBar({id:"user","class":"versaSidebar",activeStore:this._userStore,onCommand:dojo.hitch(this,this._onUserCommand)},this.userBarNode);this._wdgInfo=new bfree.widget.group.Info({id:"wdgGroupInfo1"},this.infoNode);this._grdUsers.startup();},_txtNameValidator:function(_21){if(this._txtName){if(_21.trim()==""){this._txtName.set("invalidMessage","Name cannot be blank");return false;}var _22=this.groups.fetch();for(var i=0;i<_22.length;i++){if(_22[i].name&&_22[i].name.toLowerCase().trim()==_21.toLowerCase().trim()&&_22[i].__id!=this.activeItem.__id){this._txtName.set("invalidMessage","Duplicate group name");return false;}}}return true;},resize:function(){this.inherited("resize",arguments);this.mainNode.resize();},startup:function(){this.inherited("startup",arguments);this._tblProperties.startup();}});bfree.widget.group.Editor.view1=[{cells:[{field:"id",name:"&nbsp",width:"16px",hidden:true},{field:"name",name:"Property",width:"auto"}],width:"auto"}];}