/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.admin.user.Administration"]){dojo._hasResource["bfree.widget.admin.user.Administration"]=true;dojo.provide("bfree.widget.admin.user.Administration");dojo.require("bfree.widget._DialogWidget");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit._Container");dojo.require("dijit.layout._LayoutWidget");dojo.require("dijit.Tooltip");dojo.require("dijit.form.Button");dojo.require("dijit.form.CheckBox");dojo.require("dijit.form.ValidationTextBox");dojo.require("dijit.form.FilteringSelect");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.require("dojox.grid.DataGrid");dojo.declare("bfree.widget.admin.user.Administration",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/admin/user","template/Administration.html","<div style=\"width: 100%; height: 100%;\">\n    <table>\n        <tr>\n            <td dojoAttachPoint=\"lblUserName\" class=\"dijitLabel dijitDarkLabel\" style=\"padding-right:8px;text-align:right;white-space:nowrap;\">\n                Username:\n            </td>\n            <td>\n                <input dojoAttachPoint=\"txtUserName\"/>\n            </td>\n        </tr><tr>\n            <td dojoAttachPoint=\"lblFirstName\" class=\"dijitLabel dijitDarkLabel\" style=\"padding-right:8px;text-align:right;white-space:nowrap;\">\n                First Name:\n            </td>\n            <td>\n                <input dojoAttachPoint=\"txtFirstName\"/>\n            </td>\n        </tr><tr>\n            <td dojoAttachPoint=\"lblLastName\" class=\"dijitLabel dijitDarkLabel\" style=\"padding-right:8px;text-align:right;white-space:nowrap;\">\n                Last Name:\n            </td>\n            <td>\n                <input dojoAttachPoint=\"txtLastName\"/>\n            </td>\n        </tr><tr>\n            <td dojoAttachPoint=\"lblEmail\" class=\"dijitLabel dijitDarkLabel\" style=\"padding-right:8px;text-align:right;white-space:nowrap;\">\n                Email:\n            </td>\n            <td>\n                <input dojoAttachPoint=\"txtEmail\"/>\n            </td>\n        </tr><tr dojoAttachPoint=\"trResetPass\">\n            <td dojoAttachPoint=\"lblResetPass\" class=\"dijitLabel dijitDarkLabel\" style=\"padding-right:8px;text-align:right;white-space:nowrap;\">\n                Password:\n            </td>\n            <td>\n                <input dojoAttachPoint=\"txtResetPass\"/>\n                <div dojoAttachPoint=\"btnResetPass\"></div>\n            </td>\n        </tr><tr dojoAttachPoint=\"trGeneratePass\" style=\"display: none;\">\n            <td dojoAttachPoint=\"lblGeneratePass\" class=\"dijitLabel dijitDarkLabel\" style=\"padding-right:8px;text-align:right;white-space:nowrap;\">\n                Password:\n            </td>\n            <td>\n                <input dojoAttachPoint=\"txtGeneratePass\"/>\n                <div dojoAttachPoint=\"btnGeneratePass\"></div>\n            </td>\n        </tr>\n    </table>\n</div>\n"),widgetsInTemplate:true,widgetType:"user",users:null,activeUser:null,constructor:function(_1){this.users=_1.users;this.onItemChange=_1.onItemChange;this.onSelect=_1.onSelect;this._grdUsers=_1.grid;},onItemChange:function(){},_setActiveItemAttr:function(_2){this.activeUser=_2;this._populateUser();this.onSelect(this.activeUser!=null);if(this.activeUser!=null&&this.users.isDirty({item:this.activeUser})){this._editUserValues();}else{this._disableUserValues();}},postCreate:function(){this.inherited("postCreate",arguments);this._txtUserName=new dijit.form.ValidationTextBox({intermediateChanges:true,invalidMessage:"You must provide a 'Username' value",promptMessage:"User (login) name.<br>NOTE: this value cannot be changed<br> after the user has been saved",required:true,trim:true,disabled:true,style:"width:100%",onChange:dojo.hitch(this,this._txtUserName_onChange)},this.txtUserName);this._txtFirstName=new dijit.form.ValidationTextBox({intermediateChanges:true,promptMessage:"User's first name",required:false,trim:true,disabled:true,style:"width:100%",onChange:dojo.hitch(this,this._txtFirstName_onChange)},this.txtFirstName);this._txtLastName=new dijit.form.ValidationTextBox({intermediateChanges:true,promptMessage:"User's last name",required:false,trim:true,disabled:true,style:"width:100%",onChange:dojo.hitch(this,this._txtLastName_onChange)},this.txtLastName);this._txtEmail=new dijit.form.ValidationTextBox({intermediateChanges:true,promptMessage:"User's email address",required:false,trim:true,disabled:true,style:"width:100%",onChange:dojo.hitch(this,this._txtEmail_onChange)},this.txtEmail);this._txtGeneratePass=new dijit.form.ValidationTextBox({intermediateChanges:true,invalidMessage:"",promptMessage:"Enter or generate a new password for the user",require:true,trim:false,disabled:true,style:"width:190px",onChange:dojo.hitch(this,this._txtGeneratePass_onChange)},this.txtGeneratePass);this._txtResetPass=new dijit.form.ValidationTextBox({intermediateChanges:true,invalidMessage:"",promptMessage:"Enter or generate a new password for the user",require:true,trim:false,disabled:true,style:"width:190px",onChange:dojo.hitch(this,this._txtResetPass_onChange)},this.txtResetPass);this._btnGeneratePass=new dijit.form.Button({iconClass:"imageIcon bfreeIconLock",label:"Generate Random Password",showLabel:false,disabled:true,onClick:dojo.hitch(this,this._btnGeneratePass_onClick)},this.btnGeneratePass);this._btnResetPass=new dijit.form.Button({iconClass:"imageIcon bfreeIconUnlock",label:"Reset Password",showLabel:false,disabled:true,onClick:dojo.hitch(this,this._btnResetPass_onClick)},this.btnResetPass);},_txtUserName_onChange:function(_3){if(this.activeUser!=null&&_3!=this.activeUser.name){this.users.setValue(this.activeUser,"name",_3);}},_txtFirstName_onChange:function(_4){if(this.activeUser!=null&&_4!=this.activeUser.first_name){this.users.setValue(this.activeUser,"first_name",_4);}},_txtLastName_onChange:function(_5){if(this.activeUser!=null&&_5!=this.activeUser.last_name){this.users.setValue(this.activeUser,"last_name",_5);}},_txtEmail_onChange:function(_6){if(this.activeUser!=null&&_6!=this.activeUser.email){this.users.setValue(this.activeUser,"email",_6);}},_btnResetPass_onClick:function(_7){if(confirm("Are you sure you want to reset "+(this.activeUser.first_name+" "+this.activeUser.last_name).trim()+"'s password?")){var _8=bfree.api.RkoUsers.generatePassword({length:8});this.users.setValue(this.activeUser,"resetPassword",_8);this._txtResetPass.set("disabled",false);dojo.toggleClass(this.lblResetPass,"bfreeDarkDisabled",false);this._txtResetPass.set("value",_8);this._txtResetPass.focus();}},_btnGeneratePass_onClick:function(_9){var _a=bfree.api.RkoUsers.generatePassword({length:8});this.users.setValue(this.activeUser,"password",_a);this._txtGeneratePass.set("value",_a);this._txtGeneratePass.focus();},_txtGeneratePass_onChange:function(_b){if(this.activeUser!=null&&this.activeUser.password!=_b&&_b!=""){this.users.setValue(this.activeUser,"password",_b);}},_txtResetPass_onChange:function(_c){if(this.activeUser!=null&&this.activeUser.resetPassword!=_c&&_c!=""){this.users.setValue(this.activeUser,"resetPassword",_c);}},_editUserValues:function(){this._txtUserName.set("disabled",false);this._txtFirstName.set("disabled",false);this._txtLastName.set("disabled",false);this._txtEmail.set("disabled",false);if(this.activeUser.id!=null){dojo.style(this.trGeneratePass,{display:"none"});dojo.style(this.trResetPass,{display:""});this._btnResetPass.set("disabled",false);this._btnGeneratePass.set("disabled",true);this._txtGeneratePass.set("disabled",true);}else{dojo.style(this.trGeneratePass,{display:""});dojo.style(this.trResetPass,{display:"none"});this._txtResetPass.set("disabled",true);this._btnResetPass.set("disabled",true);this._txtGeneratePass.set("disabled",false);this._btnGeneratePass.set("disabled",false);}},_disableUserValues:function(){this._txtUserName.set("disabled",true);this._txtFirstName.set("disabled",true);this._txtLastName.set("disabled",true);this._txtEmail.set("disabled",true);this._txtGeneratePass.set("disabled",true);this._txtResetPass.set("disabled",true);this._btnGeneratePass.set("disabled",true);this._btnResetPass.set("disabled",true);},_populateUser:function(){if(this.activeUser==null){this._txtUserName.set("value","");this._txtFirstName.set("value","");this._txtLastName.set("value","");this._txtEmail.set("value","");this._txtGeneratePass.set("value","");this._txtResetPass.set("value","");}else{this._txtUserName.set("value",this.activeUser.name?this.activeUser.name:"");this._txtFirstName.set("value",this.activeUser.first_name?this.activeUser.first_name:"");this._txtLastName.set("value",this.activeUser.last_name?this.activeUser.last_name:"");this._txtEmail.set("value",this.activeUser.email?this.activeUser.email:"");this._txtGeneratePass.set("value","");this._txtResetPass.set("value","");}},_validateItems:function(){var _d=true;for(var _e=0;_e<this._grdUsers.rowCount;_e++){var _f=this._grdUsers.getItem(_e);if(this.users.isDirty({item:_f})){_d&=_f.isValid();}}return _d;},save:function(){if(!this._validateItems()){var msg="Cannot save User changes: One or more Users contain invalid data";alert(msg);return false;}this.users.save();this.onItemChange(false);this._grdUsers.selection.select(null);return true;},edit:function(){this.users.setDirty({item:this.activeUser});this.onItemChange(true);this._editUserValues();this._txtUserName.focus();},createItem:function(){this.activeUser=this.users.create();this.users.setValue(this.activeUser,"password",bfree.api.RkoUsers.generatePassword({length:8}));this._txtGeneratePass.set("value",this.activeUser.password);this._grdUsers.selection.select(this.activeUser);this.onItemChange(true);this._editUserValues();},revert:function(){this.users.revert();this._grdUsers.update();this._grdUsers.sort();this.onItemChange(false);this._populateUser();this._disableUserValues();},remove:function(){this.users.destroy({no_save:true,item:this.activeUser});this._grdUsers.selection.select(null);this.onItemChange(true);},startup:function(){this.inherited("startup",arguments);},isDirty:function(){for(var idx=0;idx<this._grdUsers.rowCount;idx++){var _10=this._grdUsers.getItem(idx);if(this.users.isDirty({item:_10})){return true;}}return false;}});}