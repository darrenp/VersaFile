/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.choiceList.Editor"]){dojo._hasResource["bfree.widget.choiceList.Editor"]=true;dojo.provide("bfree.widget.choiceList.Editor");dojo.require("bfree.api.Application");dojo.require("bfree.api.DataTypes");dojo.require("bfree.widget.Bfree");dojo.require("bfree.widget.FilteringSelect");dojo.require("bfree.widget.ObjectInfo");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.choiceList.ValueBar");dojo.require("bfree.widget.choiceList.values.Editor");dojo.require("dijit._Widget");dojo.require("dijit._Templated");dojo.require("dijit.form.Form");dojo.declare("bfree.widget.choiceList.Editor",[dijit._Widget,dijit._Templated],{templateString:dojo.cache("bfree/widget/choiceList","template/Editor.html","<div style=\"height:100%;width:100%\">\n\n<div    dojoAttachPoint=\"mainNode\"\n        dojoType=\"dijit.layout.BorderContainer\"\n        design=\"headline\"\n        gutters=\"false\"\n        liveSplitters=\"true\"\n        style=\"width:100%;height:100%\">\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"top\"\n            style=\"overflow:hidden;padding:0;height: 112px;\">\n\n         <div dojoAttachPoint=\"formNode\">\n\n            <div dojoAttachPoint=\"tableNode\"></div>\n\n        </div>\n\n        Users:\n    </div>\n\n    <div    dojoType=\"dijit.layout.BorderContainer\"\n            splitter=\"false\"\n            region=\"center\"\n            design=\"sidebar\"\n            gutters=\"false\"\n            liveSplitters=\"true\"\n            style=\"width:100%;height:100%\">\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"center\">\n\n            <div dojoAttachPoint=\"valueListNode\"></div>\n\n        </div>\n\n        <div    dojoType=\"dijit.layout.ContentPane\"\n                splitter=\"false\"\n                region=\"right\"\n                style=\"overflow:hidden;padding:16px 0 0 0;width:24px\">\n\n            <div dojoAttachPoint=\"valueBarNode\"></div>\n\n        </div>\n\n    </div>\n\n    <div    dojoType=\"dijit.layout.ContentPane\"\n            splitter=\"false\"\n            region=\"bottom\"\n            style=\"padding:0 8px 0 8px;height: 80px;\">\n\n        <div dojoAttachPoint=\"infoNode\"></div>\n\n    </div>\n\n</div>\n\n</div>\n"),widgetsInTemplate:true,activeItem:null,choiceLists:null,_handles:[],_cmbDataTypes:null,_cmdBar:null,_dataTypes:null,_form:null,_grdValues:null,_tblProperties:null,_txtName:null,_valueStore:null,_wdgInfo:null,__onValueDlgClose:function(_1,_2){var _3=null;if(_1==bfree.widget.Dialog.dialogResult.ok){try{this._grdValues.beginUpdate();_3=this._valueStore.newItem({sort:this._grdValues.rowCount,id:_2.display,display:_2.display,value:_2.value});}finally{this._grdValues.endUpdate();}if(_3){this._grdValues.selectItem(_3);}}return true;},_cmbDataTypes_onChange:function(_4){if((_4==null)||_4==""){return;}var _5=(_4==null)?-1:parseInt(_4);if(this.activeItem.data_type_id!=_5){this.choiceLists.setValue(this.activeItem,"data_type_id",_5);this.activeItem.choice_values=[];this._setStore();}},_grdValues_onSelectedItem:function(_6){this._cmdBar.set("activeValue",_6);},_onValueChange:function(_7,_8){if(!this.activeItem){return;}var _9=this.choiceLists.getValue(this.activeItem,_7);if(_9!=_8){this.choiceLists.store.setValue(this.activeItem,_7,_8);this.onValueChange(this.activeItem,_7,_9,_8);}},_onValueCommand:function(_a){switch(_a){case bfree.widget.Bfree.Commands.ADD:this._onValueAdd();break;case bfree.widget.Bfree.Commands.MOVE_UP:this._onValueUp();break;case bfree.widget.Bfree.Commands.MOVE_DOWN:this._onValueDown();break;case bfree.widget.Bfree.Commands.REMOVE:this._onValueRemove();break;}},_onValueAdd:function(){try{bfree.widget.choiceList.values.Editor.show({choiceList:this.activeItem,dataType:this._dataTypes.fetchById({id:this.activeItem.data_type_id}),valueStore:this._valueStore,onClose:dojo.hitch(this,this.__onValueDlgClose)});}catch(e){var _b=new bfree.api.Error("Failed to open 'Choice List Values' dialog",e);bfree.widget.ErrorManager.handleError({error:_b});}},_onValueCreated:function(_c,_d){this.activeItem.choice_values.push({sort_order:this._valueStore.getValue(_c,"sort"),name:this._valueStore.getValue(_c,"display"),value:this._valueStore.getValue(_c,"value")});this.onValueChange(this.activeItem,"choice_values",[],this.activeItem.choice_values);},_onValueDeleted:function(_e){for(var _f=0;_f<this.activeItem.choice_values.length;_f++){var _10=this._valueStore.getIdentity(_e);if(this.activeItem.choice_values[_f].name==_10){this.activeItem.choice_values.splice(_f,1);break;}}this.onValueChange(this.activeItem,"choice_values",[],this.activeItem.choice_values);},_onValueDown:function(){var _11=this._grdValues.selection.getFirstSelected();if(_11){this._grdValues.moveItem(_11,bfree.widget.SortGrid.move.DOWN);}},_onValueUp:function(){var _12=this._grdValues.selection.getFirstSelected();if(_12){this._grdValues.moveItem(_12,bfree.widget.SortGrid.move.UP);}},_onValueRemove:function(){var idx=0;try{this._grdValues.beginUpdate();var _13=this._grdValues.selection.getFirstSelected();idx=this._grdValues.getItemIndex(_13);this._valueStore.deleteItem(_13);this._valueStore.save();}catch(e){var err=new bfree.api.Error("Failed to remove Value",e);bfree.widget.ErrorManager.handleError({error:err});}finally{this._grdValues.endUpdate();}this._grdValues.setSelectedIndex(idx);},_onValueUpdated:function(_14,_15,_16,_17){_15=(_15=="sort")?"sort_order":_15;var _18=this._valueStore.getIdentity(_14);for(var i=0;i<this.activeItem.choice_values.length;i++){if(this.activeItem.choice_values[i].name==_18){if(this.activeItem.choice_values[i].hasOwnProperty(_15)){if(this.activeItem.choice_values[i][_15]!=_17){this.activeItem.choice_values[i][_15]=_17;}}}}this.onValueChange(this.activeItem,"choice_values",[],this.activeItem.choice_values);},_setActiveItemAttr:function(_19){this.activeItem=_19;if(this.activeItem){this._txtName.set("value",this.activeItem.name);this._txtDescription.set("value",this.activeItem.description);this._cmbDataTypes.set("value",this.activeItem.data_type_id);}else{this._txtName.reset();this._txtDescription.reset();this._cmbDataTypes.reset();}this._cmdBar.set("activeChoiceList",this.activeItem);this._wdgInfo.set("activeItem",this.activeItem);this._setStore();this._setState();},_setState:function(){var _1a=false;var _1b=false;if(this.activeItem){_1a=this.choiceLists.isDirty({item:this.activeItem});_1b=this.activeItem.isNew();}this._txtName.set("disabled",!_1a);this._txtDescription.set("disabled",!_1a);this._cmbDataTypes.set("disabled",!(_1a&&_1b));this._cmdBar.set("disabled",!_1a);},_setStore:function(){var _1c=[];if(this.activeItem){dojo.forEach(this.activeItem.choice_values,function(_1d,idx){_1c.push({sort:_1d.sort_order,id:_1d.name,display:_1d.name,value:_1d.value});},this);}dojo.forEach(this._handles,function(_1e,idx){dojo.disconnect(_1e);delete this._handles[idx];},this);this._valueStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"display",items:_1c}});this._handles[0]=dojo.connect(this._valueStore,"onNew",this,this._onValueCreated);this._handles[1]=dojo.connect(this._valueStore,"onDelete",this,this._onValueDeleted);this._handles[2]=dojo.connect(this._valueStore,"onSet",this,this._onValueUpdated);this._grdValues.setStore(this._valueStore);},_updateValues:function(){if(!this.activeItem){return;}var _1f=[];for(var i=0;i<this._grdValues.rowCount;i++){var _20=this._grdValues.getItem(i);_1f.push({sort_order:this._valueStore.getValue(_20,"sort"),name:this._valueStore.getValue(_20,"display"),value:this._valueStore.getValue(_20,"value")});}this.choiceLists.store.setValue(this.activeItem,"choice_values",_1f);this.onValueChange(this.activeItem,"choice_values",[],this.activeItem.choice_values);},constructor:function(_21){this._valueStore=new bfree.api.ItemFileWriteStore({data:{identifier:"id",label:"display",items:[]}});},destroy:function(){this.destroyDescendants();if(this._tblProperties){this._tblProperties.destroyRecursive();this._tblProperties=null;}if(this._form){this._form.destroy();this._form=null;}this.inherited("destroy",arguments);},focus:function(){this._txtName.setFocus(true);},onValueChange:function(_22,_23,_24,_25){},postCreate:function(){this.inherited("postCreate",arguments);this._dataTypes=bfree.api.Application.getDataTypes();this._form=new dijit.form.Form({id:"propDefForm"},this.formNode);this._tblProperties=new dojox.layout.TableContainer({id:"tblProps1",customClass:"versa",showLabels:true,cols:1,labelWidth:96,style:"width:100%"},this.tableNode);this._txtName=new bfree.widget.ValidationTextBox({id:"txtName",label:"Name",selectOnClick:true,intermediateChanges:true,disabled:true,required:true,style:"width:100%",validator:dojo.hitch(this,this._txtNameValidator),onChange:dojo.hitch(this,this._onValueChange,"name")});this._tblProperties.addChild(this._txtName);this._txtDescription=new dijit.form.SimpleTextarea({label:"Description","class":"bfree",disabled:true,rows:2,style:"resize:none;width:100%",onChange:dojo.hitch(this,this._onValueChange,"description")});this._tblProperties.addChild(this._txtDescription);this._cmbDataTypes=new bfree.widget.FilteringSelect({label:"Data Type",query:{allow_choice_list:true},disabled:true,required:true,style:"width:100%",store:this._dataTypes.store,onChange:dojo.hitch(this,this._cmbDataTypes_onChange)});this._tblProperties.addChild(this._cmbDataTypes);this._grdValues=new bfree.widget.SortGrid({id:"grdValues","class":"versaGridOutlineNoPad",query:{},noDataMessage:"No Values Defined",store:this._valueStore,sort_field:"sort",structure:bfree.widget.choiceList.Editor.view1,formatterScope:this,rowsPerPage:1000,style:"width:100%;height:100%",onSelectedItem:dojo.hitch(this,this._grdValues_onSelectedItem)},this.valueListNode);this._cmdBar=new bfree.widget.choiceList.ValueBar({id:"wdgValueBar","class":"versaSidebar",valueStore:this._valueStore,grid:this._grdValues,onCommand:dojo.hitch(this,this._onValueCommand)},this.valueBarNode);this._wdgInfo=new bfree.widget.ObjectInfo({id:"wdgChoiceListInfo1"},this.infoNode);this._grdValues.startup();},_txtNameValidator:function(_26){var _27=this.choiceLists.fetch();for(var i=0;i<_27.length;i++){if(_27[i].name&&_27[i].name.toLowerCase().trim()==_26.toLowerCase().trim()&&_27[i].__id!=this.activeItem.__id){this._txtName.set("invalidMessage","Duplicate choice list");return false;}}return true;},resize:function(){this.inherited("resize",arguments);this.mainNode.resize();},startup:function(){this.inherited("startup",arguments);this._tblProperties.startup();}});bfree.widget.choiceList.Editor.valueFormatter=function(_28){if(_28 instanceof Date){return bfree.api.Utilities.formatDate(_28);}return _28;};bfree.widget.choiceList.Editor.view1=[{cells:[{field:"sort",name:"&nbsp",width:"16px",hidden:true},{field:"display",name:"Displayed Value",width:"128px"},{field:"value",name:"Value",width:"auto",formatter:bfree.widget.choiceList.Editor.valueFormatter}],width:"auto"}];}