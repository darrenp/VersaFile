/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.folder.Tree"]){dojo._hasResource["bfree.widget.folder.Tree"]=true;dojo.provide("bfree.widget.folder.Tree");dojo.require("bfree.api.Search");dojo.require("bfree.widget.folder.ContextMenu");dojo.require("dijit.InlineEditBox");dojo.require("dijit.Tree");dojo.require("dijit.tree.ForestStoreModel");dojo.declare("bfree.widget._TreeNode",dijit._TreeNode,{_editor:null,_isEditing:false,library:null,user:null,_createEditor:function(){dojo.attr(this.labelNode,"innerHTML","");var _1=dojo.create("span",{innerHTML:this.label},this.labelNode,"first");var nc=dojo.coords(this.labelNode);var tc=dojo.coords(this.tree.domNode);this._editor=new dijit.InlineEditBox({id:"wdgEditor",intermediateChanges:false,tree:this.tree,node:this,autoSave:true,onChange:dojo.hitch(this,this._editor_onChange),onCancel:dojo.hitch(this,this._editor_onCancel),width:(tc.w-nc.l-16)+"px",scrollIntoView:false,value:this.item.name},_1);this._editor.startup();},_destroyEditor:function(){try{this._editor.destroyRecursive();this._editor=null;}catch(e){}},_editor_onCancel:function(){try{this.set("label",this.item.name);this.tree.folders.revert();var _2;if(this.item.parent_id==0){_2=this.tree.rootNode.item;}else{_2=this.tree.folders.fetchById({id:this.item.parent_id});}var _3=this.tree.getNodesByItem(_2);dojo.forEach(_3,function(_4,_5){var _6=_4.getChildren();if(_6.length==0){this.tree._collapseNode(_4);}else{if(_6.length==1&&this.item.isNew()){if(_6[0].item.__id==this.item.__id){_4.setChildItems([]);this.tree._collapseNode(_4);}}}},this);}catch(e){}finally{this.tree.setEditing(false);this._destroyEditor();}},_editor_onChange:function(_7,_8){var _9=false;try{var _a;if(this.item.parent_id==0){_a=this.tree.rootNode.item;}else{_a=this.tree.folders.fetchById({id:this.item.parent_id});}for(var i in _a.children){if(i!="__parent"&&_a.children[i].declaredClass=="bfree.api.Folder"&&_a.children[i].name.toLowerCase()==_7.toLowerCase()&&_a.children[i].id!=this.item.id){alert("Duplicate folder names are not allowed.");this._destroyEditor();setTimeout(dojo.hitch(this,function(){this.edit();}),100);return;}}if(_7==""){this.set("label",this.item.name);this.tree.folders.revert();this.tree._afterSelected(this);this.tree.setEditing(false);this._destroyEditor();return;}this.set("label",_7);this.tree._beforeSelected(this);_9=this.item.isNew();this.tree.folders.setValue(this.item,"name",_7);this.tree.folders.save();var _b=this.tree.getNodesByItem(_a);dojo.forEach(_b,function(_c,_d){_c.item.children.sort(bfree.api.Folder.sort);_c.setChildItems(_c.item.children);},this);(_9)?this.tree.onNewNode(this):this.tree.onUpdateNode(this);this.tree._afterSelected(this);this.tree.setEditing(false);this._destroyEditor();}catch(e){}finally{}},constructor:function(_e){if(!_e){_e={};}dojo.safeMixin(this,_e);},edit:function(){this._createEditor();this._editor.edit();this.tree.setEditing(true);this._editor.wrapperWidget.editWidget.domNode.focus();},hide:function(){dojo.style(this.domNode,"display","none");},postCreate:function(){this.inherited("postCreate",arguments);},startup:function(){this.inherited("startup",arguments);}});dojo.declare("bfree.widget.folder.Tree",dijit.Tree,{_nodeStyles:["dijitTreeExpandoLoading","dijitTreeExpandoOpened","dijitTreeExpandoClosed","dijitTreeExpandoLeaf"],folders:null,isSearchHidden:false,isTrashHidden:false,library:null,_afterSelected:function(_f){var i=_f.isExpandable?(_f.isExpanded?1:2):3;dojo.replaceClass(_f.expandoNode,this._nodeStyles[i],this._nodeStyles);},_beforeSelected:function(_10){dojo.replaceClass(_10.expandoNode,this._nodeStyles[0],this._nodeStyles);},_mnuFolder_onClose:function(evt){dojo.removeClass(this._mnuFolder.activeNode.rowNode,"dijitTreeMenuRow");},_mnuFolder_onOpen:function(evt){dojo.addClass(this._mnuFolder.activeNode.rowNode,"dijitTreeMenuRow");},_createTreeNode:function(_11){return new bfree.widget._TreeNode(_11);},_hideNodesByItem:function(_12){var _13=this.getNodesByItem(_12);dojo.forEach(_13,function(_14,idx){_14.hide();});},_onChildrenChange:function(_15,_16){_15.children.sort(bfree.api.Folder.sort);},_onKeyPress:function(e){if(this.tree._isEditing){return;}this.inherited(arguments);},_mayHaveChildren:function(_17){if((_17.is_trash)||(_17.is_search)){return false;}return dojo.isArray(_17.children)?(_17.children.length>0):(_17.children);},_node_onClick:function(_18,_19){if(!(this.tree._isEditing&&_19._editor)){this._beforeSelected(_19);this.inherited("onClick",arguments);this.onSelected(_18,_19);this._afterSelected(_19);}},_onCommand:function(_1a,_1b,_1c){this.onCommand(_1a,_1b,_1c);},constructor:function(_1d){this["class"]="versafile";this.model=new dijit.tree.ForestStoreModel({store:_1d.folders.store,query:{parent_id:0},rootId:0,rootLabel:_1d.library.name,deferItemLoadingUntilExpand:true,childrenAttrs:["children"],mayHaveChildren:this._mayHaveChildren,onChildrenChange:this._onChildrenChange});this.persist=false;this.openOnClick=false;},createFolder:function(_1e){var _1f={parent:_1e,attribute:"children"};var _20=this.folders.generateUniqueName({base_name:"Folder",parent:_1e});var _21=this.folders.store.newItem({name:"",parent_id:_1e.id,children:[]},_1f);_1e.children.sort(bfree.api.Folder.sort);var _22=this.getNodesByItem(_1e);dojo.forEach(_22,function(_23,idx){this._expandNode(_23);},this);_22=this.getNodesByItem(_21);dojo.forEach(_22,function(_24,idx){var _25=_24.getParent();_25.item.children.sort(bfree.api.Folder.sort);_25.setChildItems(_25.item.children);_24.edit();},this);},deleteFolder:function(_26){var msg=dojo.replace("Are you sure you want to delete the folder '{name}'?\n\n"+"NOTE: this will delete all existing sub-folders and contained documents.",_26);if(!confirm(msg)){return;}var _27=_26.path;this.folders.destroy({item:_26});this.folders.save();var _28;if(_26.parent_id==0){_28=this.rootNode.item;}else{_28=this.folders.fetchById({id:_26.parent_id});}if(_28.id!=0){this.folders.store._index[_28.__id+"#children"].removeByValue(_26);this.folders.store._updates=[];}_27.pop();this.setSelectedPath(_27);},editFolder:function(_29){if(_29.is_trash||_29.is_search){return;}var _2a=this.getNodesByItem(_29);dojo.forEach(_2a,function(_2b,idx){_2b.edit();},this);},getIconClass:function(_2c,_2d){if(_2c.is_trash){return "folderIcon bfreeTrashFolder";}if(_2c.is_search){return "folderIcon bfreeSearchFolder";}return (!_2c||this.model.mayHaveChildren(_2c))?(_2d?"dijitFolderOpened":"dijitFolderClosed"):"dijitFolderClosed";},hideSearch:function(){var _2e=this.library.getFolders().getSearchFolder();this._hideNodesByItem(_2e);},hideTrash:function(){var _2f=this.library.getFolders().getTrashFolder();this._hideNodesByItem(_2f);},onNewNode:function(_30){this.setSelectedItem(_30.item);},onUpdateNode:function(_31){},postCreate:function(){this.inherited("postCreate",arguments);this._mnuFolder=new bfree.widget.folder.ContextMenu({tree:this,activeLibrary:this.library,activeUser:this.user,onCommand:dojo.hitch(this,this._onCommand),onOpen:dojo.hitch(this,this._mnuFolder_onOpen),onClose:dojo.hitch(this,this._mnuFolder_onClose),targetNodeIds:[this.id]});this.connect(this,"onClick",this._node_onClick);dojo.connect(this,"onMouseDown",this,this._onMouseDown);},_onMouseDown:function(evt){var _32=dijit.getEnclosingWidget(evt.target);if(this.tree._isEditing&&_32._editor){}else{this.dndController.startNode=_32;if(evt.button==2){this._mnuFolder.set("activeNode",_32);}}},setEditing:function(_33){this._isEditing=_33;},setSelectedItem:function(_34){var _35=this.getNodesByItem(_34);this.set("selectedNode",_35[0]);this.onSelected(_34,_35[0]);},setSelectedNode:function(_36){this.set("selectedNode",_36);this.onSelected(_36.item,_36);},setSelectedPath:function(_37){this.set("path",_37);this.setSelectedNode(this.selectedNode);},startup:function(){this.inherited("startup",arguments);this._mnuFolder.startup();dojo.safeMixin(this.rootNode.item,{"active_permissions":this.library.active_permissions,"name":this.library.name,"text_path":"/","updated_at":this.library.updated_at,"getActiveQuery":dojo.hitch(this.rootNode.item,function(){return new bfree.api.Search({type:bfree.api.Search.types.FOLDER,queryData:0});}),"hasRights":dojo.hitch(this.rootNode.item,function(_38){return ((this.active_permissions&_38)==_38);})});if(this.isSearchHidden){this.hideSearch();}if(this.isTrashHidden){this.hideTrash();}this.rootNode.item.children.sort(bfree.api.Folder.sort);this.rootNode.setChildItems(this.rootNode.item.children);this.setSelectedNode(this.rootNode);},getNodesByItem:function(_39){if(!_39){return [];}var _3a=dojo.isString(_39)?_39:this.model.getIdentity(_39);if(this._itemNodesMap[_3a]){return [].concat(this._itemNodesMap[_3a]);}else{return [].concat(this._itemNodesMap[_39.__clientId.substring(_39.__clientId.lastIndexOf("/")+1)]);}},_onClick:function(_3b,e){if(!(this.tree._isEditing&&_3b._editor)){var _3c=e.target,_3d=this.isExpandoNode(_3c,_3b);if((this.openOnClick&&_3b.isExpandable)||_3d){if(_3b.isExpandable){this._onExpandoClick({node:_3b});}}else{this._publish("execute",{item:_3b.item,node:_3b,evt:e});this.onClick(_3b.item,_3b,e);this.focusNode(_3b);}dojo.stopEvent(e);}}});}