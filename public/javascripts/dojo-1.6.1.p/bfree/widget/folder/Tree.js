/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.folder.Tree"]){dojo._hasResource["bfree.widget.folder.Tree"]=true;dojo.provide("bfree.widget.folder.Tree");dojo.require("bfree.api.Search");dojo.require("bfree.widget.ValidationTextBox");dojo.require("bfree.widget.folder.ContextMenu");dojo.require("bfree.widget.folder.DndSource");dojo.require("dijit.InlineEditBox");dojo.require("dijit.Tree");dojo.require("dijit.tree.TreeStoreModel");dojo.declare("bfree.widget._TreeNode",dijit._TreeNode,{_editor:null,_isEditing:false,library:null,group:null,user:null,_createEditor:function(){dojo.attr(this.labelNode,"innerHTML","");var _1=dojo.create("span",{innerHTML:this.label},this.labelNode,"first");var nc=dojo.coords(this.labelNode);var tc=dojo.coords(this.tree.domNode);this._editor=new dijit.InlineEditBox({id:"wdgEditor",editor:"bfree.widget.ValidationTextBox",intermediateChanges:false,tree:this.tree,node:this,autoSave:true,onChange:dojo.hitch(this,this._editor_onChange),onCancel:dojo.hitch(this,this._editor_onCancel),width:(tc.w-nc.l-25)+"px",scrollIntoView:false,value:this.item.name},_1);this._editor.startup();},_destroyEditor:function(){try{this._editor.destroyRecursive();this._editor=null;}catch(e){}},_editor_onCancel:function(){try{this.set("label",this.item.name);var _2;if(this.item.parent_id==0){_2=this.tree.rootNode.item;}else{_2=this.tree.folders.fetchById({id:this.item.parent_id});}if(this.item.isNew()){var _3=this.tree.getNodesByItem(_2);dojo.forEach(_3,function(_4){var _5=_4.getChildren();_5.removeByValue(this);for(var i in _5){if(_5[i].item){_5[i]=_5[i].item;}}_4.setChildItems(_5);},this);this.tree.folders.destroy({item:this.item});this.tree.folders.save();}else{this.tree.folders.revert();this.tree.folders.save();}}catch(e){}finally{this.tree.setEditing(false);this._destroyEditor();}},_editor_onChange:function(_6){try{function _7(){this._destroyEditor();setTimeout(dojo.hitch(this,function(){this.edit();}),100);};var _8=this.tree.folders.fetchById({id:this.item.parent_id});if(_8.childNameExists(_6,this.item.getId())){var _9=dojo.replace("Cannot create folder: The destination folder already contains a folder named '{0}'",[_6]);alert(_9);this._destroyEditor();setTimeout(dojo.hitch(this,function(){this.edit();}),100);}else{if(_6.trim()==""){this._editor_onCancel();}else{this.set("label",_6);this.tree._beforeSelected(this);this.tree.folders.setValue(this.item,"name",_6);this.tree.folders.save();this.tree.resortChildren(_8);(this.item.isNew())?this.tree.onNewNode(this):this.tree.onUpdateNode(this);this.tree._afterSelected(this);this.tree.setEditing(false);this._destroyEditor();}}}catch(e){}finally{this.setSelected(true);}},constructor:function(_a){},edit:function(){this.tree.setEditing(true);this._createEditor();this._editor.edit();this._editor.wrapperWidget.editWidget.domNode.focus();},hide:function(){dojo.style(this.domNode,"display","none");},show:function(){dojo.style(this.domNode,"display","block");},postCreate:function(){this.inherited("postCreate",arguments);},startup:function(){this.inherited("startup",arguments);}});dojo.declare("bfree.widget.folder.Tree",dijit.Tree,{_isEditing:false,_nodeStyles:["dijitTreeExpandoLoading","dijitTreeExpandoOpened","dijitTreeExpandoClosed","dijitTreeExpandoLeaf"],_rootItem:null,dndController:"bfree.widget.folder.DndSource",folders:null,isSearchHidden:true,isShareRootHidden:false,isTrashHidden:false,openOnDblClick:true,library:null,zone:null,_afterSelected:function(_b){var i=_b.isExpandable?(_b.isExpanded?1:2):3;dojo.replaceClass(_b.expandoNode,this._nodeStyles[i],this._nodeStyles);},_beforeSelected:function(_c){dojo.replaceClass(_c.expandoNode,this._nodeStyles[0],this._nodeStyles);},_mnuFolder_onClose:function(_d){if(this._mnuFolder.activeNode.rowNode){dojo.removeClass(this._mnuFolder.activeNode.rowNode,"dijitTreeMenuRow");}},_mnuFolder_onOpen:function(_e){if(this._mnuFolder.activeNode.rowNode){dojo.addClass(this._mnuFolder.activeNode.rowNode,"dijitTreeMenuRow");}},_createTreeNode:function(_f){return new bfree.widget._TreeNode(_f);},_hideNodesByItem:function(_10){var _11=this.getNodesByItem(_10);dojo.forEach(_11,function(_12,idx){_12.hide();});},_showNodesByItem:function(_13){var _14=this.getNodesByItem(_13);dojo.forEach(_14,function(_15,idx){_15.show();});},_onKeyPress:function(e){if(this.tree._isEditing){return;}this.inherited(arguments);},_mayHaveChildren:function(_16){if((_16.isTrash())||(_16.isSearch())){return false;}return dojo.isArray(_16.children)?(_16.children.length>0):(_16.children);},_node_onClick:function(_17,_18){if(!(this.tree._isEditing&&_18._editor)){this._beforeSelected(_18);this.inherited("onClick",arguments);this._onSelected(_17,_18);this._afterSelected(_18);}},_onCommand:function(_19,_1a,_1b){this.onCommand(_19,_1a,_1b);},_onMouseDown:function(evt){this.onFocus();var _1c=dijit.getEnclosingWidget(evt.target);if(this.tree._isEditing&&_1c._editor){}else{if(this.dndController){this.dndController.startNode=_1c;}if(dojo.mouseButtons.isRight(evt)){this._mnuFolder.set("activeNode",_1c);}}},_onSelected:function(_1d,_1e){this.onSelected(_1d,_1e);},constructor:function(_1f){this["class"]="versafile";this.model=new dijit.tree.TreeStoreModel({store:_1f.folders.store,deferItemLoadingUntilExpand:true,query:"root",mayHaveChildren:this._mayHaveChildren});this.persist=false;this.openOnClick=false;},createFolder:function(_20){var _21={parent:_20,attribute:"children"};var _22=this.folders.generateUniqueName({base_name:"Folder",parent:_20});var _23=this.folders.store.newItem({name:"",parent_id:_20.id,children:[]},_21);var _24=this.getNodesByItem(_20);dojo.forEach(_24,function(_25,idx){this._expandNode(_25);},this);_24=this.getNodesByItem(_23);dojo.forEach(_24,function(_26,idx){_26.edit();},this);},deleteFolder:function(_27){var msg="";if(_27.isShare()){msg=dojo.replace("Are you sure you want to remove the shared folder '{name}'?",_27);}else{msg=dojo.replace("Are you sure you want to delete the folder '{name}'?\n\n"+"NOTE: this will delete all existing sub-folders and contained documents.",_27);}if(!confirm(msg)){this.setBusy(_27,false);return;}var _28=_27.path;this.setSelectedItem(_27);this.folders.destroy({item:_27});_28.pop();this.setSelectedPath(_28);},editFolder:function(_29){if(_29.isTrash()||_29.isSearch()||_29.isShareRoot()){return;}var _2a=this.getNodesByItem(_29);dojo.forEach(_2a,function(_2b,idx){var _2c=_2b.domNode;while(_2c!=null){var wgt=dijit.getEnclosingWidget(_2c);if(wgt.declaredClass=="bfree.widget.folder.Tree"){_2b.edit();break;}_2c=_2c.parentNode;}},this);},getIconClass:function(_2d,_2e){var _2f="dijitFolderOpened";if(_2d.isRoot()){_2f="folderIcon bfreeRootFolder";}else{if(_2d.isTrash()){_2f="folderIcon bfreeTrashFolder";}else{if(_2d.isSearch()){_2f="folderIcon bfreeSearchFolder";}else{if(_2d.isShareRoot()){_2f="folderIcon bfreeShareRootFolder";}else{if(_2d.isShare()){_2f=(!_2d||this.model.mayHaveChildren(_2d))?(_2e?"folderIcon bfreeShareFolderOpened":"folderIcon bfreeShareFolderClosed"):"folderIcon bfreeShareFolderClosed";}else{if(_2d.isError()){_2f="folderIcon bfreeIconError";}else{_2f=(!_2d||this.model.mayHaveChildren(_2d))?(_2e?"dijitFolderOpened":"dijitFolderClosed"):"dijitFolderClosed";}}}}}}return _2f;},getNodesByItem:function(_30){if(!_30){return [];}var _31=dojo.isString(_30)?_30:this.model.getIdentity(_30);if(this._itemNodesMap[_31]){return [].concat(this._itemNodesMap[_31]);}else{return [].concat(this._itemNodesMap[_30.__clientId.substring(_30.__clientId.lastIndexOf("/")+1)]);}},getRoot:function(){if(!this._rootItem){this.model.getRoot(dojo.hitch(this,function(_32){this._rootItem=_32;}));}return this._rootItem;},hideSearch:function(){var _33=this.getRoot().getSearchFolder();if(_33){this._hideNodesByItem(_33);}},hideShareRoot:function(){var _34=this.getRoot().getShareRootFolder();if(_34){this._hideNodesByItem(_34);}},hideTrash:function(){var _35=this.getRoot().getTrashFolder();if(_35){this._hideNodesByItem(_35);}},moveFolder:function(_36,_37){var _38=this.getNodesByItem(_37)[0];var _39=this.getNodesByItem(_36)[0];var _3a=_38.getParent();_39.expand();if(_36.childNameExists(_37.name)){var msg=dojo.replace("Cannot move folder: The destination folder already contains a folder named '{name}'",_37);alert(msg);}else{this.library.getFolders().setValue(_37,"parent_id",_36.getId());this.model.pasteItem(_37,_3a.item,_36,false);this.library.getFolders().save();this.updateChildren(_37);_39.item.children.sort(bfree.api.Folder.sort);_39.setChildItems(_39.item.children);this.setSelectedPath(_37.path);}},updateChildren:function(_3b){this.model.getChildren(_3b,dojo.hitch(this,function(_3c){dojo.forEach(_3c,function(_3d){_3d.path=_3b.path.slice(0);_3d.path.push(_3d.id.toString());_3d.text_path=_3b.text_path+"/"+_3d.name;this.updateChildren(_3d);},this);}));},onNewNode:function(_3e){this.setSelectedItem(_3e.item);},onUpdateNode:function(_3f){},postCreate:function(){this.inherited("postCreate",arguments);this._mnuFolder=new bfree.widget.folder.ContextMenu({tree:this,activeLibrary:this.library,activeGroup:this.group,activeUser:this.user,onCommand:dojo.hitch(this,this._onCommand),onOpen:dojo.hitch(this,this._mnuFolder_onOpen),onClose:dojo.hitch(this,this._mnuFolder_onClose),targetNodeIds:[this.id]});dojo.connect(this,"onClick",this._node_onClick);dojo.connect(this,"onMouseDown",this,this._onMouseDown);this.dndController.onCommand=dojo.hitch(this,this.onCommand);},onSelected:function(_40,_41){},resortChildren:function(_42){var _43=this.tree.getNodesByItem(_42);dojo.forEach(_43,function(_44){_44.item.children.sort(bfree.api.Folder.sort);_44.setChildItems(_44.item.children);},this);},selectRoot:function(){this.setSelectedNode(this.rootNode);},setBusy:function(_45,_46){var _47=this.getNodesByItem(_45);dojo.forEach(_47,function(_48,idx){(_46)?_48.markProcessing():_48.unmarkProcessing();},this);},setEditing:function(_49){this._isEditing=_49;},setSelectedItem:function(_4a){var _4b=this.getNodesByItem(_4a);this.set("selectedNode",_4b[0]);this._onSelected(_4a,_4b[0]);},setSelectedNode:function(_4c){this.set("selectedNode",_4c);this._onSelected(_4c.item,_4c);},setSelectedPath:function(_4d){this.set("path",_4d);this.setSelectedNode(this.selectedNode);},showSearch:function(){var _4e=this.getRoot().getSearchFolder();if(_4e){this._showNodesByItem(_4e);}},startup:function(){this.inherited("startup",arguments);this._mnuFolder.startup();var _4f=(this.isShareRootHidden)?null:this.getRoot().getShareRootFolder();this.isShareRootHidden=((!_4f)||(!_4f.hasRights(bfree.api._Securable.permissions.VIEW)));if(this.isSearchHidden){this.hideSearch();}if(this.isTrashHidden){this.hideTrash();}if(this.isShareRootHidden){this.hideShareRoot();}},_onClick:function(_50,e){if(!(this.tree._isEditing&&_50._editor)){var _51=e.target,_52=this.isExpandoNode(_51,_50);if((this.openOnClick&&_50.isExpandable)||_52){if(_50.isExpandable){this._onExpandoClick({node:_50});}}else{setTimeout(dojo.hitch(this,function(){this._publish("execute",{item:_50.item,node:_50,evt:e});this.onClick(_50.item,_50,e);this.focusNode(_50);}),50);}dojo.stopEvent(e);}}});}