/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.folder.Tree"]){dojo._hasResource["bfree.widget.folder.Tree"]=true;dojo.provide("bfree.widget.folder.Tree");dojo.require("bfree.api.Search");dojo.require("bfree.widget.folder.ContextMenu");dojo.require("dijit.InlineEditBox");dojo.require("dijit.Tree");dojo.require("dijit.tree.TreeStoreModel");dojo.declare("bfree.widget._TreeNode",dijit._TreeNode,{_editor:null,_isEditing:false,library:null,group:null,user:null,_createEditor:function(){dojo.attr(this.labelNode,"innerHTML","");var _1=dojo.create("span",{innerHTML:this.label},this.labelNode,"first");var nc=dojo.coords(this.labelNode);var tc=dojo.coords(this.tree.domNode);this._editor=new dijit.InlineEditBox({id:"wdgEditor",intermediateChanges:false,tree:this.tree,node:this,autoSave:true,onChange:dojo.hitch(this,this._editor_onChange),onCancel:dojo.hitch(this,this._editor_onCancel),width:(tc.w-nc.l-25)+"px",scrollIntoView:false,value:this.item.name},_1);this._editor.startup();},_destroyEditor:function(){try{this._editor.destroyRecursive();this._editor=null;}catch(e){}},_editor_onCancel:function(){try{this.set("label",this.item.name);var _2;if(this.item.parent_id==0){_2=this.tree.rootNode.item;}else{_2=this.tree.folders.fetchById({id:this.item.parent_id});}if(this.item.isNew()){var _3=this.tree.getNodesByItem(_2);dojo.forEach(_3,function(_4,_5){var _6=_4.getChildren();_6.removeByValue(this);for(var i in _6){if(_6[i].item){_6[i]=_6[i].item;}}_4.setChildItems(_6);},this);this.tree.folders.destroy({item:this.item});this.tree.folders.save();}else{this.tree.folders.revert();this.tree.folders.save();}}catch(e){}finally{this.tree.setEditing(false);this._destroyEditor();}},_editor_onChange:function(_7,_8){var _9=false;try{var _a;if(this.item.parent_id==0){_a=this.tree.rootNode.item;}else{_a=this.tree.folders.fetchById({id:this.item.parent_id});}for(var i in _a.children){if(i!="__parent"&&_a.children[i].declaredClass=="bfree.api.Folder"&&_a.children[i].name.toLowerCase()==_7.toLowerCase()&&_a.children[i].id!=this.item.id){alert("Duplicate folder names are not allowed.");this._destroyEditor();setTimeout(dojo.hitch(this,function(){this.edit();}),100);return;}}if(_7.trim()==""){this._editor_onCancel();return;}this.set("label",_7);this.tree._beforeSelected(this);_9=this.item.isNew();this.tree.folders.setValue(this.item,"name",_7);this.tree.folders.save();var _b=this.tree.getNodesByItem(_a);dojo.forEach(_b,function(_c,_d){_c.item.children.sort(bfree.api.Folder.sort);_c.setChildItems(_c.item.children);},this);(_9)?this.tree.onNewNode(this):this.tree.onUpdateNode(this);this.tree._afterSelected(this);this.tree.setEditing(false);this._destroyEditor();}catch(e){}finally{this.setSelected(true);}},constructor:function(_e){},edit:function(){this._createEditor();this._editor.edit();this.tree.setEditing(true);this._editor.wrapperWidget.editWidget.domNode.focus();},hide:function(){dojo.style(this.domNode,"display","none");},show:function(){dojo.style(this.domNode,"display","block");},postCreate:function(){this.inherited("postCreate",arguments);},startup:function(){this.inherited("startup",arguments);}});dojo.declare("bfree.widget.folder.Tree",dijit.Tree,{_nodeStyles:["dijitTreeExpandoLoading","dijitTreeExpandoOpened","dijitTreeExpandoClosed","dijitTreeExpandoLeaf"],_rootItem:null,dndController:"bfree.widget.folder.DndSource",folders:null,isSearchHidden:true,isShareRootHidden:false,isTrashHidden:false,openOnDblClick:true,library:null,zone:null,_afterSelected:function(_f){var i=_f.isExpandable?(_f.isExpanded?1:2):3;dojo.replaceClass(_f.expandoNode,this._nodeStyles[i],this._nodeStyles);},_beforeSelected:function(_10){dojo.replaceClass(_10.expandoNode,this._nodeStyles[0],this._nodeStyles);},_mnuFolder_onClose:function(evt){dojo.removeClass(this._mnuFolder.activeNode.rowNode,"dijitTreeMenuRow");},_mnuFolder_onOpen:function(evt){dojo.addClass(this._mnuFolder.activeNode.rowNode,"dijitTreeMenuRow");},_createTreeNode:function(_11){return new bfree.widget._TreeNode(_11);},_hideNodesByItem:function(_12){var _13=this.getNodesByItem(_12);dojo.forEach(_13,function(_14,idx){_14.hide();});},_showNodesByItem:function(_15){var _16=this.getNodesByItem(_15);dojo.forEach(_16,function(_17,idx){_17.show();});},_onChildrenChange:function(_18,_19){_18.children.sort(bfree.api.Folder.sort);},_onKeyPress:function(e){if(this.tree._isEditing){return;}this.inherited(arguments);},_mayHaveChildren:function(_1a){if((_1a.isTrash())||(_1a.isSearch())){return false;}return dojo.isArray(_1a.children)?(_1a.children.length>0):(_1a.children);},_node_onClick:function(_1b,_1c){if(!(this.tree._isEditing&&_1c._editor)){this._beforeSelected(_1c);this.inherited("onClick",arguments);this._onSelected(_1b,_1c);this._afterSelected(_1c);}},_onCommand:function(_1d,_1e,_1f){this.onCommand(_1d,_1e,_1f);},_onMouseDown:function(evt){var _20=dijit.getEnclosingWidget(evt.target);if(this.tree._isEditing&&_20._editor){}else{this.dndController.startNode=_20;if(evt.button==2){this._mnuFolder.set("activeNode",_20);}}},_onSelected:function(_21,_22){this.onSelected(_21,_22);},constructor:function(_23){this["class"]="versafile";this.model=new dijit.tree.TreeStoreModel({store:_23.folders.store,deferItemLoadingUntilExpand:true,query:"root",mayHaveChildren:this._mayHaveChildren});this.persist=false;this.openOnClick=false;},createFolder:function(_24){var _25={parent:_24,attribute:"children"};var _26=this.folders.generateUniqueName({base_name:"Folder",parent:_24});var _27=this.folders.store.newItem({name:"",parent_id:_24.id,children:[]},_25);var _28=this.getNodesByItem(_24);dojo.forEach(_28,function(_29,idx){this._expandNode(_29);},this);_28=this.getNodesByItem(_27);dojo.forEach(_28,function(_2a,idx){_2a.edit();},this);},deleteFolder:function(_2b){var msg="";if(_2b.isShare()){msg=dojo.replace("Are you sure you want to delete the shared folder '{name}'?",_2b);}else{msg=dojo.replace("Are you sure you want to delete the folder '{name}'?\n\n"+"NOTE: this will delete all existing sub-folders and contained documents.",_2b);}if(!confirm(msg)){this.setBusy(_2b,false);return;}var _2c=_2b.path;var _2d=this.getNodesByItem(_2b);dojo.forEach(_2d,function(_2e,idx){var _2f=_2e.getParent();var _30=_2f.getChildren();_30.removeByValue(_2e);for(var i in _30){if(_30[i].item){_30[i]=_30[i].item;}}_2f.setChildItems(_30);},this);this.folders.destroy({item:_2b});this.folders.save();_2c.pop();this.setSelectedPath(_2c);},editFolder:function(_31){if(_31.is_trash||_31.is_search){return;}var _32=this.getNodesByItem(_31);dojo.forEach(_32,function(_33,idx){var _34=_33.domNode;while(_34!=null){var wgt=dijit.getEnclosingWidget(_34);if(wgt.declaredClass=="bfree.widget.folder.Tree"){_33.edit();break;}_34=_34.parentNode;}},this);},getIconClass:function(_35,_36){var _37="dijitFolderOpened";if(_35.isRoot()){_37="folderIcon bfreeRootFolder";}else{if(_35.isTrash()){_37="folderIcon bfreeTrashFolder";}else{if(_35.isSearch()){_37="folderIcon bfreeSearchFolder";}else{if(_35.isShareRoot()){_37="folderIcon bfreeShareRootFolder";}else{if(_35.isShare()){_37=(!_35||this.model.mayHaveChildren(_35))?(_36?"folderIcon bfreeShareFolderOpened":"folderIcon bfreeShareFolderClosed"):"folderIcon bfreeShareFolderClosed";}else{if(_35.isError()){_37="folderIcon bfreeIconError";}else{_37=(!_35||this.model.mayHaveChildren(_35))?(_36?"dijitFolderOpened":"dijitFolderClosed"):"dijitFolderClosed";}}}}}}return _37;},getNodesByItem:function(_38){if(!_38){return [];}var _39=dojo.isString(_38)?_38:this.model.getIdentity(_38);if(this._itemNodesMap[_39]){return [].concat(this._itemNodesMap[_39]);}else{return [].concat(this._itemNodesMap[_38.__clientId.substring(_38.__clientId.lastIndexOf("/")+1)]);}},getRoot:function(){if(!this._rootItem){this.model.getRoot(dojo.hitch(this,function(_3a){this._rootItem=_3a;}));}return this._rootItem;},hideSearch:function(){var _3b=this.getRoot().getSearchFolder();if(_3b){this._hideNodesByItem(_3b);}},hideShareRoot:function(){var _3c=this.getRoot().getShareRootFolder();if(_3c){this._hideNodesByItem(_3c);}},hideTrash:function(){var _3d=this.getRoot().getTrashFolder();if(_3d){this._hideNodesByItem(_3d);}},showSearch:function(){var _3e=this.getRoot().getSearchFolder();if(_3e){this._showNodesByItem(_3e);}},moveFolder:function(_3f,_40){var _41=this.getNodesByItem(_40)[0];var _42=this.getNodesByItem(_3f)[0];var _43=_41.getParent();_42.expand();this.library.getFolders().setValue(_40,"parent_id",_3f.getId());this.model.pasteItem(_40,_43.item,_3f,false);this.library.getFolders().save();this.setSelectedPath(_40.path);},onNewNode:function(_44){this.setSelectedItem(_44.item);},onUpdateNode:function(_45){},postCreate:function(){this.inherited("postCreate",arguments);this._mnuFolder=new bfree.widget.folder.ContextMenu({tree:this,activeLibrary:this.library,activeGroup:this.group,activeUser:this.user,onCommand:dojo.hitch(this,this._onCommand),onOpen:dojo.hitch(this,this._mnuFolder_onOpen),onClose:dojo.hitch(this,this._mnuFolder_onClose),targetNodeIds:[this.id]});dojo.connect(this,"onClick",this._node_onClick);dojo.connect(this,"onMouseDown",this,this._onMouseDown);this.dndController.onCommand=dojo.hitch(this,this.onCommand);},onSelected:function(_46,_47){},selectRoot:function(){this.setSelectedNode(this.rootNode);},setBusy:function(_48,_49){var _4a=this.getNodesByItem(_48);dojo.forEach(_4a,function(_4b,idx){(_49)?_4b.markProcessing():_4b.unmarkProcessing();},this);},setEditing:function(_4c){this._isEditing=_4c;},setSelectedItem:function(_4d){var _4e=this.getNodesByItem(_4d);this.set("selectedNode",_4e[0]);this._onSelected(_4d,_4e[0]);},setSelectedNode:function(_4f){this.set("selectedNode",_4f);this._onSelected(_4f.item,_4f);},setSelectedPath:function(_50){this.set("path",_50);this.setSelectedNode(this.selectedNode);},startup:function(){this.inherited("startup",arguments);this._mnuFolder.startup();var _51=this.getRoot().getShareRootFolder();this.isShareRootHidden=((_51)&&(!_51.hasRights(bfree.api._Securable.permissions.VIEW)));if(this.isSearchHidden){this.hideSearch();}if(this.isTrashHidden){this.hideTrash();}if(this.isShareRootHidden){this.hideShareRoot();}},_onClick:function(_52,e){if(!(this.tree._isEditing&&_52._editor)){var _53=e.target,_54=this.isExpandoNode(_53,_52);if((this.openOnClick&&_52.isExpandable)||_54){if(_52.isExpandable){this._onExpandoClick({node:_52});}}else{setTimeout(dojo.hitch(this,function(){this._publish("execute",{item:_52.item,node:_52,evt:e});this.onClick(_52.item,_52,e);this.focusNode(_52);}),50);}dojo.stopEvent(e);}}});}