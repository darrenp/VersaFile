/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.folder.DndSource"]){dojo._hasResource["bfree.widget.folder.DndSource"]=true;dojo.provide("bfree.widget.folder.DndSource");dojo.require("dijit.tree.dndSource");dojo.declare("bfree.widget.folder.DndSource",dijit.tree.dndSource,{singular:true,_normalizedCreator:null,_checkDocumentDrag:function(_1){var _2=true;return _2;},_checkReferenceAcceptance:function(_3,_4){var _5=true;if((_4[0].folder_id==_3.getId())&&(!_4[0].isDeleted())){_5=false;}else{if(_3.isSpecial()){if(_3.isTrash()){_5=dojo.every(_4,function(_6,_7){return (!_6.isDeleted())&&_6.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS);},this);}else{if(_3.isSearch()){_5=false;}else{if(_3.isShareRoot()){_5=false;}else{if(_3.isShare()){_5=!_4[0].isDeleted();}}}}}else{if(!_3.hasRights(bfree.api._Securable.permissions.CREATE_DOCUMENTS)){_5=false;}else{_5=dojo.every(_4,function(_8,_9){return _8.hasRights(bfree.api._Securable.permissions.WRITE_METADATA);},this);}}}return _5;},_checkFolderAcceptance:function(_a,_b){var _c=true;if(!_a.hasRights(bfree.api._Securable.permissions.CREATE_FOLDERS)){_c=false;}if(_b[0].parent_id==_a.getId()){_c=false;}else{if(_a.isSearch()||_a.isShare()){_c=false;}}return _c;},_checkFolderDrag:function(_d){var _e=true;dojo.every(_d,function(_f,idx){if(_f.isSpecial()){_e=false;}return _e;},this);return _e;},_getSourceItems:function(_10){var _11=[];if(!_10){return _11;}if(_10.isInstanceOf(bfree.widget.folder.DndSource)){_11.push(_10.anchor.item);}else{if(_10.isInstanceOf(versa.widget.reference.dnd.Source)){var _12=_10.getSelectedNodes();dojo.forEach(_12,function(_13,idx){_11.push(_10.getItem(_13.id).data);});}}return _11;},_getTargetItem:function(_14){var _15=dijit.getEnclosingWidget(_14);return _15.item;},_onFolderDrop:function(_16,_17){if(_16.isTrash()){this.onCommand(bfree.widget.Bfree.Commands.DESTROY,bfree.widget.Bfree.ObjectTypes.FOLDER,{folder:_17[0]});}else{if(_16.isShareRoot()){this.onCommand(bfree.widget.Bfree.Commands.NEW,bfree.widget.Bfree.ObjectTypes.SHARE,{folder:_17[0]});}else{if(_16.isRoot()||_16.isContent()){this.onCommand(bfree.widget.Bfree.Commands.MOVE,bfree.widget.Bfree.ObjectTypes.FOLDER,{parent:_16,folder:_17[0]});}}}},_onReferenceDrop:function(_18,_19){if(_18.isTrash()){this.onCommand(bfree.widget.Bfree.Commands.DELETE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{items:_19});}else{if(_18.isShare()){this.onCommand(bfree.widget.Bfree.Commands.SHARE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{folder:_18,items:_19});}else{if(_19[0].isDeleted()){this.onCommand(bfree.widget.Bfree.Commands.RESTORE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{folder:_18,items:_19});}else{this.onCommand(bfree.widget.Bfree.Commands.MOVE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{folder:_18,items:_19});}}}},_onSelectStart:function(evt){if(!this.tree._isEditing){dojo.stopEvent(evt);}},checkItemAcceptance:function(_1a,_1b,_1c){var _1d=false;var _1e=this._getTargetItem(_1a);var _1f=this._getSourceItems(_1b);if((!_1e)||(_1f.length<1)){return _1d;}if(_1f[0].isInstanceOf(bfree.api.Reference)){_1d=this._checkReferenceAcceptance(_1e,_1f);}else{if(_1f[0].isInstanceOf(bfree.api.Folder)){_1d=this._checkFolderAcceptance(_1e,_1f);}}return _1d;},constructor:function(_20){this._normalizedCreator=this.creator;dojo.forEach(this.events,function(evt,idx){if(evt[1]=="onselectstart"){dojo.disconnect(evt);this.events[idx]=dojo.connect(this.node,"onselectstart",this,"_onSelectStart");}},this);},creator:function(_21,_22){var _23=null;if(_22=="avatar"){var _24=bfree.api.Folder.getIconUrl(_21.item,16);_23=dojo.create("div",{"class":"dijitDarkLabel",innerHTML:_21.item.name,style:{paddingLeft:"18px",height:"16px",position:"relative"}});dojo.create("img",{src:_24,style:{left:"0",position:"absolute",top:"0"}},_23);}else{_23=dojo.create("div",{innerHTML:_21.item.name});}return {node:_23,data:_21,type:"folder"};},onCommand:function(_25,_26,_27){},onDndDrop:function(_28,_29,_2a){try{if(!this.targetAnchor){return;}var _2b=this.targetAnchor.item;var _2c=this._getSourceItems(_28);if((!_2b)||(_2c.length<1)){return;}setTimeout(bfree.widget.folder.DndSource._deferred(this,_2b,_2c),10);}finally{this.inherited("onDndCancel",arguments);}},onDndStart:function(_2d,_2e,_2f){this.inherited("onDndStart",arguments);if(_2d!==this){_2d.cancelled=true;return;}var _30=dojo.every(_2e,function(_31){var _32=_2d.getItem(_31.id).data;return _32.item.hasRights(bfree.api._Securable.permissions.WRITE_METADATA)&&(!(_32.item.isRoot()||_32.item.isSpecial()));},this);if(!_30){dojo.dnd.manager().onKeyDown({keyCode:dojo.keys.ESCAPE});}},onMouseDown:function(e){if(!(e.target.type&&e.target.type=="text")){this.mouseDown=true;this.mouseButton=e.button;this._lastX=e.pageX;this._lastY=e.pageY;this.inherited(arguments);}}});dojo.dnd.manager().canDrop=function(_33){var _34=Boolean(this.target&&_33);if(this.canDropFlag!=_34){this.canDropFlag=_34;if(this.avatar){this.avatar.update();}}};dojo.dnd.manager().startDrag=function(_35,_36,_37){this.source=_35;this.nodes=_36;this.copy=Boolean(_37);this.avatar=this.makeAvatar();dojo.body().appendChild(this.avatar.node);dojo.publish("/dnd/start",[_35,_36,this.copy]);this.events=[dojo.connect(dojo.doc,"onmousemove",this,"onMouseMove"),dojo.connect(dojo.doc,"onmouseup",this,"onMouseUp"),dojo.connect(dojo.doc,"onkeydown",this,"onKeyDown"),dojo.connect(dojo.doc,"onkeyup",this,"onKeyUp"),dojo.connect(dojo.doc,"ondragstart",dojo.stopEvent)];var c="dojoDnd"+(_37?"Copy":"Move");dojo.addClass(dojo.body(),c);};bfree.widget.folder.DndSource._deferred=function(_38,_39,_3a){return function(){if(_3a[0].isInstanceOf(bfree.api.Reference)){_38._onReferenceDrop(_39,_3a);}else{if(_3a[0].isInstanceOf(bfree.api.Folder)){_38._onFolderDrop(_39,_3a);}}};};}