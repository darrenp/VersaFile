/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.folder.DndSource"]){dojo._hasResource["bfree.widget.folder.DndSource"]=true;dojo.provide("bfree.widget.folder.DndSource");dojo.require("dijit.tree.dndSource");dojo.declare("bfree.widget.folder.DndSource",[dijit.tree.dndSource],{singular:true,onDndDrop:function(_1,_2,_3){try{if(this.containerState!=""&&this.targetAnchor!=null){if(_2[0].type=="Document"){var _4=dijit.getEnclosingWidget(_2[0]);var _5=_4.payload;dojo.forEach(_5,dojo.hitch(this,function(_6,_7){if(this.targetAnchor.item.is_trash){this.tree.documents.setValue(_6,"state",_6.setState(bfree.api.Document.states.DELETED,true));}else{if(_6.getState(bfree.api.Document.states.DELETED)){this.tree.documents.setValue(_6,"state",_6.setState(bfree.api.Document.states.DELETED,false));}this.tree.documents.setValue(_6,"folder_id",this.targetAnchor.item.$ref?this.targetAnchor.item.$ref:(this.targetAnchor.item.id));}}));this.tree.documents.save({onComplete:function(){_4.grid.selection.clear();_4.grid.refresh();}});}else{if(this.targetAnchor.item.is_trash){this.tree.deleteFolder(this.anchor.item);}else{if(this.anchor.item.root){this.moveFolder({anchor:this.anchor,targetAnchor:this.targetAnchor});}else{this.tree.folders.loadItem({item:this.anchor.item,onItem:dojo.hitch(this,this.moveFolder,{anchor:this.anchor,targetAnchor:this.targetAnchor})});}}}}}catch(e){}finally{this.inherited("onDndCancel",arguments);}},onDndStart:function(_8,_9,_a){if(_9[0].type!="Document"&&this.startNode.declaredClass!="bfree.widget._TreeNode"){dojo.dnd.manager().stopDrag();return;}if(_9[0].type=="Document"){var _b=dijit.getEnclosingWidget(_9[0]);var _c=_b.payload;var _d=true;var _e=true;dojo.forEach(_c,function(_f,idx){var _10=_f.getPermissionSet(null,this.tree.library,this.tree.user);if(!_10.getValue(versa.api.PermissionIndices.MOVE)){_e=false;}if(!_10.getValue(versa.api.PermissionIndices.DELETE)){_d=false;}},this);if(!_e&&!_d){dojo.dnd.manager().stopDrag();return;}}if(_8.anchor.item&&(_8.anchor.item.is_trash||_8.anchor.item.is_search)){dojo.dnd.manager().stopDrag();return;}if(_9[0].type!="Document"&&!this.tree.user.is_admin){dojo.dnd.manager().stopDrag();return;}this.inherited("onDndStart",arguments);},moveFolder:function(_11){var _12=_11.anchor;var _13=_11.targetAnchor;var _14=_12.getParent();_13.expand();var _15=_13.item.id||_13.item.root?_13.item.id:_13.item.$ref;this.tree.folders.loadItem({item:_13.item,callback:dojo.hitch(this,function(_16){this.tree.folders.setValue(_12.item,"parent_id",_15);this.tree.model.pasteItem(_12.item,_14.item,_16,false);})});this.tree.folders.save();dojo.removeClass(_13.domNode,"dijitTreeRowSelected");dojo.removeClass(_13.domNode,"dijitTreeRowHover");this.tree.setSelectedPath(_12.item.path);},checkItemAcceptance:function(_17,_18,_19){var _1a=dijit.getEnclosingWidget(_17);var _1b=dijit.getEnclosingWidget(_18.anchor);var _1c=(_1a.item.id||_1a.item.root)?_1a.item.id:_1a.item.$ref;if(!_18.anchor){return false;}if(_18.anchor.item&&_1c==_18.anchor.item.parent_id){return false;}if(_18.anchor.type=="Document"){var _1d=_1a.payload;var _1e=true;var _1f=true;dojo.forEach(_1d,function(_20,idx){var _21=bfree.api.Document.getPermissionSet(_20,null,this.tree.library,this.tree.user);if(!_21[bfree.api.Document.permissionIndices.MOVE]){_1f=false;}if(!_21[bfree.api.Document.permissionIndices.DELETE]){_1e=false;}},this);if(!_1e){if(_1a.item.is_trash){return false;}}if(!_1f){if(!_1a.item.is_trash){return false;}}}var _22=_1a.getChildren();for(var i in _22){if(_22[i].item&&_22[i].item.name&&_18.anchor.item&&_22[i].item.name==_18.anchor.item.name){return false;}}if(_1a.item.is_search||_1a.item.is_trash){if(_18.anchor.type=="Document"&&_1a.item.is_trash&&!_1b.document.getState(bfree.api.Document.states.DELETED)){return true;}else{if(_18.anchor.type!="Document"&&_1a.item.is_trash){return true;}}return false;}return true;},constructor:function(_23){},onMouseDown:function(e){if(!(e.target.type&&e.target.type=="text")){this.mouseDown=true;this.mouseButton=e.button;this._lastX=e.pageX;this._lastY=e.pageY;this.inherited(arguments);}}});}