/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.folder.DndSource"]){dojo._hasResource["bfree.widget.folder.DndSource"]=true;dojo.provide("bfree.widget.folder.DndSource");dojo.require("dijit.tree.dndSource");dojo.declare("bfree.widget.folder.DndSource",dijit.tree.dndSource,{singular:true,_normalizedCreator:null,_checkDocumentDrag:function(_1){var _2=true;return _2;},_checkReferenceAcceptance:function(_3,_4){var _5=true;if((_4[0].folder_id==_3.getId())&&(!_4[0].isDeleted())){_5=false;}else{if(_3.isSpecial()){if(_3.isTrash()){_5=dojo.every(_4,function(_6,_7){return (!(_6.isDeleted()||_6.isShare()))&&_6.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS);},this);}else{if(_3.isSearch()){_5=false;}else{if(_3.isShareRoot()){_5=false;}else{if(_3.isShare()){_5=!(_4[0].isDeleted()||_4[0].isShare());}}}}}else{if(!_3.hasRights(bfree.api._Securable.permissions.CREATE_DOCUMENTS)){_5=false;}else{_5=dojo.every(_4,function(_8,_9){return (_8.hasRights(bfree.api._Securable.permissions.WRITE_METADATA)&&(!_8.isShare()));},this);}}}return _5;},_checkFolderAcceptance:function(_a,_b){var _c=true;if(!_a.hasRights(bfree.api._Securable.permissions.CREATE_FOLDERS)){_c=false;}if(_b[0].parent_id==_a.getId()){_c=false;}else{if(_a.isSearch()||_a.isShare()){_c=false;}else{_c=dojo.every(_b,function(_d){return (!(_d.isRoot()||_d.isSpecial())&&_d.hasRights(bfree.api._Securable.permissions.WRITE_METADATA));},this);}}return _c;},_checkFolderDrag:function(_e){var _f=true;dojo.every(_e,function(_10,idx){if(_10.isSpecial()){_f=false;}return _f;},this);return _f;},_getSourceItems:function(_11){var _12=[];if(!_11){return _12;}if(_11.isInstanceOf(bfree.widget.folder.DndSource)){_12.push(_11.anchor.item);}else{if(_11.isInstanceOf(versa.widget.reference.dnd.Source)){_12=_11.grid.selection.getSelected();}}return _12;},_getTargetItem:function(_13){var _14=dijit.getEnclosingWidget(_13);return _14.item;},_onFolderDrop:function(_15,_16){if(_15.isTrash()){this.onCommand(bfree.widget.Bfree.Commands.DESTROY,bfree.widget.Bfree.ObjectTypes.FOLDER,{folder:_16[0]});}else{if(_15.isShareRoot()){this.onCommand(bfree.widget.Bfree.Commands.NEW,bfree.widget.Bfree.ObjectTypes.SHARE,{folder:_16[0]});}else{if(_15.isRoot()||_15.isContent()){this.onCommand(bfree.widget.Bfree.Commands.MOVE,bfree.widget.Bfree.ObjectTypes.FOLDER,{parent:_15,folder:_16[0]});}}}},_onReferenceDrop:function(_17,_18){if(_17.isTrash()){this.onCommand(bfree.widget.Bfree.Commands.DELETE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{items:_18});}else{if(_17.isShare()){this.onCommand(bfree.widget.Bfree.Commands.SHARE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{folder:_17,items:_18});}else{if(_18[0].isDeleted()){this.onCommand(bfree.widget.Bfree.Commands.RESTORE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{folder:_17,items:_18});}else{this.onCommand(bfree.widget.Bfree.Commands.MOVE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{folder:_17,items:_18});}}}},_onSelectStart:function(evt){if(!this.tree._isEditing){dojo.stopEvent(evt);}},checkItemAcceptance:function(_19,_1a,_1b){var _1c=false;var _1d=this._getTargetItem(_19);var _1e=this._getSourceItems(_1a);if((!_1d)||(_1e.length<1)){return _1c;}if(_1e[0].isInstanceOf(bfree.api.Reference)){_1c=this._checkReferenceAcceptance(_1d,_1e);}else{if(_1e[0].isInstanceOf(bfree.api.Folder)){_1c=this._checkFolderAcceptance(_1d,_1e);}}return _1c;},constructor:function(_1f){this._normalizedCreator=this.creator;dojo.forEach(this.events,function(evt,idx){if(evt[1]=="onselectstart"){dojo.disconnect(evt);this.events[idx]=dojo.connect(this.node,"onselectstart",this,"_onSelectStart");}},this);},creator:function(_20,_21){var _22=null;if(_21=="avatar"){var _23=bfree.api.Folder.getIconUrl(_20.item,16);_22=dojo.create("div",{"class":"dijitDarkLabel",innerHTML:_20.item.name,style:{paddingLeft:"18px",height:"16px",position:"relative"}});dojo.create("img",{src:_23,style:{left:"0",position:"absolute",top:"0"}},_22);}else{_22=dojo.create("div",{innerHTML:_20.item.name});}return {node:_22,data:_20,type:"folder"};},onCommand:function(_24,_25,_26){},onDndDrop:function(_27,_28,_29){try{if(!this.targetAnchor){return;}var _2a=this.targetAnchor.item;var _2b=this._getSourceItems(_27);if((!_2a)||(_2b.length<1)){return;}setTimeout(bfree.widget.folder.DndSource._deferred(this,_2a,_2b),10);}finally{this.inherited("onDndCancel",arguments);}},onDndStart:function(_2c,_2d,_2e){this.inherited("onDndStart",arguments);},onMouseDown:function(e){if((!(e.target.type&&e.target.type=="text")&&(e.button==0||(dojo.isIE<9&&e.button==1)))){this.mouseDown=true;this.mouseButton=e.button;this._lastX=e.pageX;this._lastY=e.pageY;this.inherited(arguments);}},onOutEvent:function(){if(this.timeout){clearTimeout(this.timeout);delete this.timeout;}this.inherited("onOutEvent",arguments);},_onDragMouse:function(){var _2f=this.targetAnchor;this.inherited("_onDragMouse",arguments);if(this.timeout&&_2f!==this.targetAnchor){clearTimeout(this.timeout);delete this.timeout;}if(this.targetAnchor&&this.targetAnchor.isExpandable&&!this.targetAnchor.isExpanded&&!this.timeout){this.timeout=setTimeout(dojo.hitch(this,function(){this.tree._onExpandoClick({node:this.targetAnchor});delete this.timeout;}),1000);}},});bfree.widget.folder.DndSource._deferred=function(_30,_31,_32){return function(){if(_32[0].isInstanceOf(bfree.api.Reference)){_30._onReferenceDrop(_31,_32);}else{if(_32[0].isInstanceOf(bfree.api.Folder)){_30._onFolderDrop(_31,_32);}}};};}