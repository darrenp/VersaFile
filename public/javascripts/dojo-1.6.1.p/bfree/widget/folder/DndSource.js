/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.widget.folder.DndSource"]){dojo._hasResource["bfree.widget.folder.DndSource"]=true;dojo.provide("bfree.widget.folder.DndSource");dojo.require("dijit.tree.dndSource");dojo.declare("bfree.widget.folder.DndSource",dijit.tree.dndSource,{singular:true,_normalizedCreator:null,_checkDocumentDrag:function(_1){var _2=true;return _2;},_checkReferenceAcceptance:function(_3,_4){var _5=true;if((_4[0].folder_id==_3.getId())&&(!_4[0].isDeleted())){_5=false;}else{if(_3.isSpecial()){if(_3.isTrash()){_5=dojo.every(_4,function(_6,_7){return (!(_6.isDeleted()||_6.isShare()))&&_6.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS);},this);}else{if(_3.isSearch()){_5=false;}else{if(_3.isShareRoot()){_5=false;}else{if(_3.isShare()){_5=!(_4[0].isDeleted()||_4[0].isShare());}}}}}else{if(!_3.hasRights(bfree.api._Securable.permissions.CREATE_DOCUMENTS)){_5=false;}else{_5=dojo.every(_4,function(_8,_9){return (_8.hasRights(bfree.api._Securable.permissions.WRITE_METADATA)&&(!_8.isShare()));},this);}}}return _5;},_checkFolderAcceptance:function(_a,_b){var _c=true;if(!_a.hasRights(bfree.api._Securable.permissions.CREATE_FOLDERS)){_c=false;}if(_b[0].parent_id==_a.getId()){_c=false;}else{if(_a.isSearch()||_a.isShare()){_c=false;}else{_c=dojo.every(_b,function(_d){return (!(_d.isRoot()||_d.isSpecial())&&_d.hasRights(bfree.api._Securable.permissions.WRITE_METADATA));},this);}}return _c;},_checkFolderDrag:function(_e){var _f=true;dojo.every(_e,function(_10,idx){if(_10.isSpecial()){_f=false;}return _f;},this);return _f;},_getSourceItems:function(_11){var _12=[];if(!_11){return _12;}if(_11.isInstanceOf(bfree.widget.folder.DndSource)){_12.push(_11.anchor.item);}else{if(_11.isInstanceOf(versa.widget.reference.dnd.Source)){var _13=_11.getSelectedNodes();dojo.forEach(_13,function(_14,idx){_12.push(_11.getItem(_14.id).data);});}}return _12;},_getTargetItem:function(_15){var _16=dijit.getEnclosingWidget(_15);return _16.item;},_onFolderDrop:function(_17,_18){if(_17.isTrash()){this.onCommand(bfree.widget.Bfree.Commands.DESTROY,bfree.widget.Bfree.ObjectTypes.FOLDER,{folder:_18[0]});}else{if(_17.isShareRoot()){this.onCommand(bfree.widget.Bfree.Commands.NEW,bfree.widget.Bfree.ObjectTypes.SHARE,{folder:_18[0]});}else{if(_17.isRoot()||_17.isContent()){this.onCommand(bfree.widget.Bfree.Commands.MOVE,bfree.widget.Bfree.ObjectTypes.FOLDER,{parent:_17,folder:_18[0]});}}}},_onReferenceDrop:function(_19,_1a){if(_19.isTrash()){this.onCommand(bfree.widget.Bfree.Commands.DELETE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{items:_1a});}else{if(_19.isShare()){this.onCommand(bfree.widget.Bfree.Commands.SHARE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{folder:_19,items:_1a});}else{if(_1a[0].isDeleted()){this.onCommand(bfree.widget.Bfree.Commands.RESTORE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{folder:_19,items:_1a});}else{this.onCommand(bfree.widget.Bfree.Commands.MOVE,bfree.widget.Bfree.ObjectTypes.DOCUMENT,{folder:_19,items:_1a});}}}},_onSelectStart:function(evt){if(!this.tree._isEditing){dojo.stopEvent(evt);}},checkItemAcceptance:function(_1b,_1c,_1d){var _1e=false;var _1f=this._getTargetItem(_1b);var _20=this._getSourceItems(_1c);if((!_1f)||(_20.length<1)){return _1e;}if(_20[0].isInstanceOf(bfree.api.Reference)){_1e=this._checkReferenceAcceptance(_1f,_20);}else{if(_20[0].isInstanceOf(bfree.api.Folder)){_1e=this._checkFolderAcceptance(_1f,_20);}}return _1e;},constructor:function(_21){this._normalizedCreator=this.creator;dojo.forEach(this.events,function(evt,idx){if(evt[1]=="onselectstart"){dojo.disconnect(evt);this.events[idx]=dojo.connect(this.node,"onselectstart",this,"_onSelectStart");}},this);},creator:function(_22,_23){var _24=null;if(_23=="avatar"){var _25=bfree.api.Folder.getIconUrl(_22.item,16);_24=dojo.create("div",{"class":"dijitDarkLabel",innerHTML:_22.item.name,style:{paddingLeft:"18px",height:"16px",position:"relative"}});dojo.create("img",{src:_25,style:{left:"0",position:"absolute",top:"0"}},_24);}else{_24=dojo.create("div",{innerHTML:_22.item.name});}return {node:_24,data:_22,type:"folder"};},onCommand:function(_26,_27,_28){},onDndDrop:function(_29,_2a,_2b){try{if(!this.targetAnchor){return;}var _2c=this.targetAnchor.item;var _2d=this._getSourceItems(_29);if((!_2c)||(_2d.length<1)){return;}setTimeout(bfree.widget.folder.DndSource._deferred(this,_2c,_2d),10);}finally{this.inherited("onDndCancel",arguments);}},onDndStart:function(_2e,_2f,_30){this.inherited("onDndStart",arguments);},onMouseDown:function(e){if((!(e.target.type&&e.target.type=="text")&&(e.button==0||(dojo.isIE<9&&e.button==1)))){this.mouseDown=true;this.mouseButton=e.button;this._lastX=e.pageX;this._lastY=e.pageY;this.inherited(arguments);}}});bfree.widget.folder.DndSource._deferred=function(_31,_32,_33){return function(){if(_33[0].isInstanceOf(bfree.api.Reference)){_31._onReferenceDrop(_32,_33);}else{if(_33[0].isInstanceOf(bfree.api.Folder)){_31._onFolderDrop(_32,_33);}}};};}