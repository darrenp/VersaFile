/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.api.Reference"]){dojo._hasResource["bfree.api.Reference"]=true;dojo.provide("bfree.api.Reference");dojo.require("bfree.api._Object");dojo.require("bfree.api._Securable");dojo.require("bfree.api.DropboxAccounts");dojo.require("bfree.api.Utilities");dojo.declare("bfree.api.Reference",[bfree.api._Object,bfree.api._Securable],{zone:null,library:null,clean_properties:function(_1){var _2=_1.library;var _3=_2.getDocumentTypes().fetchById({id:this.document_type_id});for(var p in this){if(!dojo.isFunction(this[p])){var _4=dojo.replace("documents.{0}",[p]);var _5=_2.getPropertyDefinitions().fetchByDbName(_4);if((_5)&&(!_5.is_system)){if(!_3.hasProperty(_5.id)){delete this[p];}}}}},constructor:function(_6){dojo.safeMixin(this,((!_6)?{}:_6));this.securable_type=bfree.api._Securable.types.Reference;},cancelCheckout:function(_7){var _8=_7.zone;var _9=_7.library;var _a=dojo.replace(bfree.api.Reference.XCKO_TRGT,[_8.subdomain,_9.id,this.getId()]);var _b={};var _c=bfree.api.XhrHelper.doPutAction({target:_a,putData:_b});return true;},checkin:function(_d){var _e=_d.zone;var _f=_d.library;var url=dojo.replace(bfree.api.Reference.CKI_TRGT,[_e.subdomain,_f.id,this.getId()]);var _10=dojo.fromJson(dojox.json.ref.toJson(this,false,"",true));var _11=bfree.api.XhrHelper.doPutAction({target:url,putData:_10});return true;},checkout:function(_12){var _13=_12.zone;var _14=_12.library;var url=dojo.replace(bfree.api.Reference.CKO_TRGT,[_13.subdomain,_14.id,this.getId()]);var _15={};var _16=bfree.api.XhrHelper.doPutAction({target:url,putData:_15});return true;},synchronize:function(_17){var _18=_17.zone;var _19=_17.library;var url;if(_17.version_id!=null){url=dojo.replace(bfree.api.Reference.SYNCHV_TRGT,[_18.subdomain,_19.id,this.getId(),_17.version_id]);}else{url=dojo.replace(bfree.api.Reference.SYNCH_TRGT,[_18.subdomain,_19.id,this.getId()]);}var _1a={};var _1b=bfree.api.XhrHelper.doPutAction({target:url,putData:_1a});return true;},copyLocal:function(_1c){var _1d=_1c.zone;var _1e=_1c.library;var url="";if(this.id.indexOf&&this.id.indexOf("db")>=0){var uid=this.id;uid=uid.replace("db","");uid=uid.substring(0,(uid.indexOf("-")));var _1f=this.id;_1f=_1f.substring((_1f.indexOf("-")+2),_1f.length);_1f=_1f.replace(/\>/g,"/").replace(/\</g,".");var _20=_1c.library.getDropboxAccounts().fetchById({id:uid});dropbox.requestToken=_20.request_token;dropbox.requestTokenSecret=_20.request_secret;dropbox.accessToken=_20.access_token;dropbox.accessTokenSecret=_20.access_secret;dropbox.media(_1f,function(_21){bfree.api.Utilities.saveUrl({url:_21.url+"?dl=1",window_name:"versa_save"});});}else{url=(_1c.version_id)?dojo.replace(bfree.api.Reference.CPV_TRGT,[_1d.subdomain,_1e.id,this.getId(),_1c.version_id]):dojo.replace(bfree.api.Reference.CP_TRGT,[_1d.subdomain,_1e.id,this.getId()]);bfree.api.Utilities.saveUrl({url:url,window_name:"versa_save"});}},file:function(_22){var _23=_22.zone;var _24=_22.library;var _25=_22.folder;var url=dojo.replace(bfree.api.Reference.FILE_TRGT,[_23.subdomain,_24.id,this.getId(),_25.getId()]);var _26={};var _27=bfree.api.XhrHelper.doPutAction({target:url,putData:_26});_24.getReferences().store.onDelete(this);return true;},getPermissionSet:function(_28,_29,_2a){var _2b=new versa.api.PermissionSet();var _2c=_2a.is_admin||_29.zone.getGroups().fetchById({id:_2a.active_group}).is_admin;_2b.setValue(versa.api.PermissionIndices.VIEW,this.hasRights(bfree.api._Securable.permissions.VIEW));_2b.setValue(versa.api.PermissionIndices.COPY,this.hasRights(bfree.api._Securable.permissions.VIEW));_2b.setValue(versa.api.PermissionIndices.EDIT,this.hasRights(bfree.api._Securable.permissions.WRITE_METADATA));_2b.setValue(versa.api.PermissionIndices.MOVE,_2b.getValue(versa.api.PermissionIndices.EDIT));_2b.setValue(versa.api.PermissionIndices.CKO,(this.hasRights(bfree.api._Securable.permissions.VERSION)&&(this.getState(bfree.api.Document.states.CHECKED_IN)||this.getState(bfree.api.Document.states.INDEXED))));_2b.setValue(versa.api.PermissionIndices.CKI,(this.hasRights(bfree.api._Securable.permissions.VERSION)&&this.getState(bfree.api.Document.states.CHECKED_OUT)&&(this.checked_out_by==_2a.name)));_2b.setValue(versa.api.PermissionIndices.CANCEL_CKO,(this.hasRights(bfree.api._Securable.permissions.VERSION)&&this.getState(bfree.api.Document.states.CHECKED_OUT)&&(this.checked_out_by==_2a.name||_2c)));_2b.setValue(versa.api.PermissionIndices.DELETE,this.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS));_2b.setValue(versa.api.PermissionIndices.SECURE,this.hasRights(bfree.api._Securable.permissions.WRITE_ACL));_2b.setValue(versa.api.PermissionIndices.RESTORE,this.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS));_2b.setValue(versa.api.PermissionIndices.DESTROY,this.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS));_2b.setValue(versa.api.PermissionIndices.SYNCHRONIZE,this.hasRights(bfree.api._Securable.permissions.VERSION)&&!this.is_synchronized);return _2b;},getState:function(_2d){return ((this.state&_2d)==_2d);},isDeleted:function(){return this.getState(bfree.api.Document.states.DELETED);},isShare:function(){return this.reference_type==bfree.api.Reference.types.SHARE;},restore:function(_2e){var _2f=_2e.zone;var _30=_2e.library;var url=dojo.replace(bfree.api.Reference.RESTORE_TRGT,[_2f.subdomain,_30.getId(),this.getId()]);var _31={folder_id:(_2e.folder)?_2e.folder.id:null};var _32=bfree.api.XhrHelper.doPutAction({target:url,putData:_31});_30.getReferences().store.onDelete(this);return true;},share:function(_33){var _34=_33.zone;var _35=_33.library;var _36=_33.folder;var url=dojo.replace(bfree.api.Reference.SHARE_TRGT,[_34.subdomain,_35.id,this.getId(),_36.getId()]);var _37={};var _38=bfree.api.XhrHelper.doPutAction({target:url,putData:_37});return true;},unshare:function(_39){var _3a=_39.zone;var _3b=_39.library;var url=dojo.replace(bfree.api.Reference.UNSHARE_TRGT,[_3a.subdomain,_3b.id,this.getId()]);var _3c={};var _3d=bfree.api.XhrHelper.doPutAction({target:url,putData:_3c});_3b.getReferences().store.onDelete(this);return true;},view:function(_3e){var _3f=_3e.zone;var _40=_3e.library;var url="";if(this.id.indexOf&&this.id.indexOf("db")>=0){var uid=this.id;uid=uid.replace("db","");uid=uid.substring(0,(uid.indexOf("-")));var _41=this.id;_41=_41.substring((_41.indexOf("-")+2),_41.length);_41=_41.replace(/\>/g,"/").replace(/\</g,".");var _42=_3e.library.getDropboxAccounts().fetchById({id:uid});dropbox.requestToken=_42.request_token;dropbox.requestTokenSecret=_42.request_secret;dropbox.accessToken=_42.access_token;dropbox.accessTokenSecret=_42.access_secret;url=dropbox.getFileURL(_41,false);}else{url=(_3e.version_id)?dojo.replace(bfree.api.Reference.VWV_TRGT,[_3f.subdomain,_40.id,this.getId(),_3e.version_id]):dojo.replace(bfree.api.Reference.VW_TRGT,[_3f.subdomain,_40.id,this.getId()]);}bfree.api.Utilities.viewUrl({windowBox:_3e.windowBox,url:url,window_name:"versa_viewer"});}});bfree.api.Reference.VW_TRGT="/zones/{0}/libraries/{1}/references/{2}/download/?disposition=inline";bfree.api.Reference.VWV_TRGT="/zones/{0}/libraries/{1}/references/{2}/download/?disposition=inline&version_id={3}";bfree.api.Reference.CP_TRGT="/zones/{0}/libraries/{1}/references/{2}/download/?disposition=attachment";bfree.api.Reference.CPV_TRGT="/zones/{0}/libraries/{1}/references/{2}/download/?disposition=attachment&version_id={3}";bfree.api.Reference.CKO_TRGT="/zones/{0}/libraries/{1}/references/{2}/checkout.json";bfree.api.Reference.CKI_TRGT="/zones/{0}/libraries/{1}/references/{2}/checkin.json";bfree.api.Reference.XCKO_TRGT="/zones/{0}/libraries/{1}/references/{2}/cancel_checkout.json";bfree.api.Reference.SYNCH_TRGT="/zones/{0}/libraries/{1}/references/{2}/synchronize.json";bfree.api.Reference.SYNCHV_TRGT="/zones/{0}/libraries/{1}/references/{2}/synchronize.json?version_id={3}";bfree.api.Reference.FILE_TRGT="/zones/{0}/libraries/{1}/references/{2}/file.json?folder_id={3}";bfree.api.Reference.SHARE_TRGT="/zones/{0}/libraries/{1}/references/{2}/share.json?folder_id={3}";bfree.api.Reference.UNSHARE_TRGT="/zones/{0}/libraries/{1}/references/{2}/unshare.json?";bfree.api.Reference.RESTORE_TRGT="/zones/{0}/libraries/{1}/references/{2}/restore.json";bfree.api.Reference.types={"CONTENT":0,"SHARE":17,"TRASH":18};bfree.api.Reference.schema={type:"object",properties:{"id":{type:"integer"},"reference_type":{type:"integer"},"state":{type:"integer","default":bfree.api.Document.states.PENDING}},prototype:new bfree.api.Reference()};}