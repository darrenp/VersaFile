/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.api.Reference"]){dojo._hasResource["bfree.api.Reference"]=true;dojo.provide("bfree.api.Reference");dojo.require("bfree.api._Object");dojo.require("bfree.api._Securable");dojo.require("bfree.api.Utilities");dojo.declare("bfree.api.Reference",[bfree.api._Object,bfree.api._Securable],{zone:null,library:null,clean_properties:function(_1){var _2=_1.library;var _3=_2.getDocumentTypes().fetchById({id:this.document_type_id});for(var p in this){if(!dojo.isFunction(this[p])){var _4=dojo.replace("documents.{0}",[p]);var _5=_2.getPropertyDefinitions().fetchByDbName(_4);if((_5)&&(!_5.is_system)){if(!_3.hasProperty(_5.id)){delete this[p];}}}}},constructor:function(_6){dojo.safeMixin(this,((!_6)?{}:_6));this.securable_type=bfree.api._Securable.types.Reference;},cancelCheckout:function(_7){var _8=_7.zone;var _9=_7.library;var _a=dojo.replace(bfree.api.Reference.XCKO_TRGT,[_8.subdomain,_9.id,this.getId()]);var _b={};var _c=bfree.api.XhrHelper.doPutAction({target:_a,putData:_b});return true;},checkin:function(_d){var _e=_d.zone;var _f=_d.library;var url=dojo.replace(bfree.api.Reference.CKI_TRGT,[_e.subdomain,_f.id,this.getId()]);var _10=dojo.fromJson(dojox.json.ref.toJson(this,false,"",true));var _11=bfree.api.XhrHelper.doPutAction({target:url,putData:_10});return true;},checkout:function(_12){var _13=_12.zone;var _14=_12.library;var url=dojo.replace(bfree.api.Reference.CKO_TRGT,[_13.subdomain,_14.id,this.getId()]);var _15={};var _16=bfree.api.XhrHelper.doPutAction({target:url,putData:_15});return true;},copyLocal:function(_17){var _18=_17.zone;var _19=_17.library;var url=(_17.version_id)?dojo.replace(bfree.api.Reference.CPV_TRGT,[_18.subdomain,_19.id,this.getId(),_17.version_id]):dojo.replace(bfree.api.Reference.CP_TRGT,[_18.subdomain,_19.id,this.getId()]);if(dojo.isWebKit){var _1a;_1a=document.getElementById("hiddenDownloader");if(_1a===null){_1a=document.createElement("iframe");_1a.id="hiddenDownloader";_1a.style.visibility="hidden";document.body.appendChild(_1a);}_1a.src=url;}else{bfree.api.Utilities.saveUrl({url:url,window_name:"versa_save"});}},file:function(_1b){var _1c=_1b.zone;var _1d=_1b.library;var _1e=_1b.folder;var url=dojo.replace(bfree.api.Reference.FILE_TRGT,[_1c.subdomain,_1d.id,this.getId(),_1e.getId()]);var _1f={};var _20=bfree.api.XhrHelper.doPutAction({target:url,putData:_1f});_1d.getReferences().store.onDelete(this);return true;},getPermissionSet:function(_21,_22,_23){var _24=new versa.api.PermissionSet();var _25=_23.is_admin||_22.zone.getGroups().fetchById({id:_23.active_group}).is_admin;_24.setValue(versa.api.PermissionIndices.VIEW,this.hasRights(bfree.api._Securable.permissions.VIEW));_24.setValue(versa.api.PermissionIndices.COPY,this.hasRights(bfree.api._Securable.permissions.VIEW));_24.setValue(versa.api.PermissionIndices.EDIT,this.hasRights(bfree.api._Securable.permissions.WRITE_METADATA));_24.setValue(versa.api.PermissionIndices.MOVE,_24.getValue(versa.api.PermissionIndices.EDIT));_24.setValue(versa.api.PermissionIndices.CKO,(this.hasRights(bfree.api._Securable.permissions.VERSION)&&(this.getState(bfree.api.Document.states.CHECKED_IN)||this.getState(bfree.api.Document.states.INDEXED))));_24.setValue(versa.api.PermissionIndices.CKI,(this.hasRights(bfree.api._Securable.permissions.VERSION)&&this.getState(bfree.api.Document.states.CHECKED_OUT)&&(this.checked_out_by==_23.name)));_24.setValue(versa.api.PermissionIndices.CANCEL_CKO,(this.hasRights(bfree.api._Securable.permissions.VERSION)&&this.getState(bfree.api.Document.states.CHECKED_OUT)&&(this.checked_out_by==_23.name||_25)));_24.setValue(versa.api.PermissionIndices.DELETE,this.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS));_24.setValue(versa.api.PermissionIndices.SECURE,this.hasRights(bfree.api._Securable.permissions.WRITE_ACL));_24.setValue(versa.api.PermissionIndices.RESTORE,this.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS));_24.setValue(versa.api.PermissionIndices.DESTROY,this.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS));return _24;},getState:function(_26){return ((this.state&_26)==_26);},isDeleted:function(){return this.getState(bfree.api.Document.states.DELETED);},isShare:function(){return this.reference_type==bfree.api.Reference.types.SHARE;},restore:function(_27){var _28=_27.zone;var _29=_27.library;var url=dojo.replace(bfree.api.Reference.RESTORE_TRGT,[_28.subdomain,_29.getId(),this.getId()]);var _2a={folder_id:(_27.folder)?_27.folder.id:null};var _2b=bfree.api.XhrHelper.doPutAction({target:url,putData:_2a});_29.getReferences().store.onDelete(this);return true;},share:function(_2c){var _2d=_2c.zone;var _2e=_2c.library;var _2f=_2c.folder;var url=dojo.replace(bfree.api.Reference.SHARE_TRGT,[_2d.subdomain,_2e.id,this.getId(),_2f.getId()]);var _30={};var _31=bfree.api.XhrHelper.doPutAction({target:url,putData:_30});return true;},unshare:function(_32){var _33=_32.zone;var _34=_32.library;var url=dojo.replace(bfree.api.Reference.UNSHARE_TRGT,[_33.subdomain,_34.id,this.getId()]);var _35={};var _36=bfree.api.XhrHelper.doPutAction({target:url,putData:_35});_34.getReferences().store.onDelete(this);return true;},view:function(_37){var _38=_37.zone;var _39=_37.library;var url=(_37.version_id)?dojo.replace(bfree.api.Reference.VWV_TRGT,[_38.subdomain,_39.id,this.getId(),_37.version_id]):dojo.replace(bfree.api.Reference.VW_TRGT,[_38.subdomain,_39.id,this.getId()]);bfree.api.Utilities.viewUrl({windowBox:_37.windowBox,url:url,window_name:"versa_viewer"});}});bfree.api.Reference.VW_TRGT="/zones/{0}/libraries/{1}/references/{2}/download/?disposition=inline";bfree.api.Reference.VWV_TRGT="/zones/{0}/libraries/{1}/references/{2}/download/?disposition=inline&version_id={3}";bfree.api.Reference.CP_TRGT="/zones/{0}/libraries/{1}/references/{2}/download/?disposition=attachment";bfree.api.Reference.CPV_TRGT="/zones/{0}/libraries/{1}/references/{2}/download/?disposition=attachment&version_id={3}";bfree.api.Reference.CKO_TRGT="/zones/{0}/libraries/{1}/references/{2}/checkout.json";bfree.api.Reference.CKI_TRGT="/zones/{0}/libraries/{1}/references/{2}/checkin.json";bfree.api.Reference.XCKO_TRGT="/zones/{0}/libraries/{1}/references/{2}/cancel_checkout.json";bfree.api.Reference.FILE_TRGT="/zones/{0}/libraries/{1}/references/{2}/file.json?folder_id={3}";bfree.api.Reference.SHARE_TRGT="/zones/{0}/libraries/{1}/references/{2}/share.json?folder_id={3}";bfree.api.Reference.UNSHARE_TRGT="/zones/{0}/libraries/{1}/references/{2}/unshare.json?";bfree.api.Reference.RESTORE_TRGT="/zones/{0}/libraries/{1}/references/{2}/restore.json";bfree.api.Reference.types={"CONTENT":0,"SHARE":17,"TRASH":18};bfree.api.Reference.schema={type:"object",properties:{"id":{type:"integer"},"reference_type":{type:"integer"},"state":{type:"integer","default":bfree.api.Document.states.PENDING}},prototype:new bfree.api.Reference()};}