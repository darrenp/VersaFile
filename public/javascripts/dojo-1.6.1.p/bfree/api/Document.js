/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.api.Document"]){dojo._hasResource["bfree.api.Document"]=true;dojo.provide("bfree.api.Document");dojo.require("bfree.api._Object");dojo.require("bfree.api._Securable");dojo.require("bfree.api.Acl");dojo.require("bfree.api.Application");dojo.require("bfree.api.Utilities");dojo.require("bfree.api.Versions");dojo.require("dojox.json.ref");dojo.declare("bfree.api.Document",[bfree.api._Object,bfree.api._Securable],{zone:null,library:null,_versions:null,checked_out_by:"",document_type_id:null,library:null,state:0,cancelCheckout:function(_1){var _2=_1.zone;var _3=_1.library;var _4=dojo.replace(bfree.api.Document.XCKO_TRGT,[_2.subdomain,_3.id,this.id]);var _5={};var _6=bfree.api.XhrHelper.doPutAction({target:_4,putData:_5});return true;},getVersions:function(){if(!this._versions){this._versions=new bfree.api.Versions({zone:this.zone,library:this.library,document:this});}return this._versions;},checkin:function(_7){var _8=_7.zone;var _9=_7.library;var _a=dojo.replace(bfree.api.Document.CKI_TRGT,[_8.subdomain,_9.id,this.id]);var _b=dojo.fromJson(dojox.json.ref.toJson(this,false,"",true));var _c=bfree.api.XhrHelper.doPutAction({target:_a,putData:_b});return true;},checkout:function(_d){var _e=_d.zone;var _f=_d.library;var url=dojo.replace(bfree.api.Document.CKO_TRGT,[_e.subdomain,_f.id,this.id]);var _10={};var _11=bfree.api.XhrHelper.doPutAction({target:url,putData:_10});return true;},constructor:function(_12){this.securable_type=bfree.api._Securable.types.Document;if((this.created_at!=null)&&(typeof this.created_at=="string")){this.created_at=dojo.date.stamp.fromISOString(this.created_at);}if((this.updated_at!=null)&&(typeof this.updated_at=="string")){this.updated_at=dojo.date.stamp.fromISOString(this.created_at);}},copyLocal:function(_13){var _14=_13.zone;var _15=_13.library;var url=dojo.replace(bfree.api.Document.CP_TRGT,[_14.subdomain,_15.id,this.id]);bfree.api.Utilities.saveUrl({url:url,window_name:"versa_save"});},file:function(_16){var _17=_16.zone;var _18=_16.library;var url=dojo.replace(bfree.api.Document.FILE_TRGT,[_17.subdomain,_18.id,this.id]);var _19={folder_id:_16.folder.id};var _1a=bfree.api.XhrHelper.doPutAction({target:url,putData:_19});return true;},getFullVersion:function(){return dojo.replace("{major_version_number}.{minor_version_number}",this.current_version);},getState:function(_1b){return ((this.state&_1b)==_1b);},isDeleted:function(){return this.getState(bfree.api.Document.states.DELETED);},restore:function(_1c){var _1d=_1c.zone;var _1e=_1c.library;var url=dojo.replace(bfree.api.Document.RESTORE_TRGT,[_1d.subdomain,_1e.id,this.id]);var _1f={};var _20=bfree.api.XhrHelper.doPutAction({target:url,putData:_1f});return true;},setState:function(_21,_22){if(_22){this.state=this.state|_21;}else{this.state=this.state&~_21;}return this.state;},unfile:function(_23){var _24=_23.zone;var _25=_23.library;var url=dojo.replace(bfree.api.Document.UNFILE_TRGT,[_24.subdomain,_25.id,this.id]);var _26={};var _27=bfree.api.XhrHelper.doPutAction({target:url,putData:_26});return true;},validate:function(_28){if(!this.document_type_id){this.state|=bfree.api.Document.states.INVALID;return false;}var _29=_28.library.getDocumentTypes().fetchById({id:this.document_type_id});var _2a=_28.library.getPropertyDefinitions();var _2b=bfree.api.Application.getDataTypes();var _2c=dojo.every(_29.property_mappings,function(_2d,idx){var _2e=true;if(_2d.is_required){var _2f=_2a.fetchById({id:_2d.property_definition_id});var _30=_2b.fetchById({id:_2f.data_type_id});if(!_2f){return false;}var _31=this[_2f.column_name];if(_30.isString()){_2e=!String.isEmpty(_31);}}return _2e;},this);this.setState(bfree.api.Document.states.INVALID,!_2c);return _2c;},view:function(_32){var _33=_32.zone;var _34=_32.library;var url=dojo.replace(bfree.api.Document.VW_TRGT,[_33.subdomain,_34.id,this.id]);bfree.api.Utilities.viewUrl({windowBox:_32.windowBox,url:url,window_name:"versa_viewer"});}});bfree.api.Document.getIconUrl=function(_35,_36){return dojo.replace("/icons/{0}?size={1}",[encodeURIComponent(_35),_36]);};bfree.api.Document.getStateIcon=function(_37){var _38="none.16.png";switch(_37){case bfree.api.Document.states.PENDING:_38="pending.16.gif";break;case bfree.api.Document.states.UPLOADED:_38="uploaded.16.png";break;case bfree.api.Document.states.CHECKED_IN:_38="cki.16.png";break;case bfree.api.Document.states.INVALID:_38="invalid.16.png";break;}return _38;};bfree.api.Document.permissionIndices={"CREATE":0,"VIEW":1,"COPY":2,"EDIT":3,"MOVE":4,"CKO":5,"CKI":6,"CANCEL_CKO":7,"DELETE":8,"SECURE":9};bfree.api.Document.getPermissionSet=function(_39,_3a,_3b,_3c){var arr=new Array();var _3d=(_3b==null);var _3e=((_3d)||(_39==null));var _3f=((_3d)||(_3a==null));var _40=((!_3f)&&((_3a.is_trash)||(_3a.is_search)));arr[bfree.api.Document.permissionIndices.CREATE]=((!_3d)&&(!_40)&&(_3b.hasRights(bfree.api._Securable.permissions.CREATE_DOCUMENTS)));arr[bfree.api.Document.permissionIndices.VIEW]=((!_3e)&&(_39.hasRights(bfree.api._Securable.permissions.VIEW)));arr[bfree.api.Document.permissionIndices.COPY]=arr[bfree.api.Document.permissionIndices.VIEW];arr[bfree.api.Document.permissionIndices.EDIT]=((!_3e)&&(_39.hasRights(bfree.api._Securable.permissions.WRITE_METADATA)));arr[bfree.api.Document.permissionIndices.MOVE]=arr[bfree.api.Document.permissionIndices.EDIT];arr[bfree.api.Document.permissionIndices.CKO]=((!_3e)&&(_39.hasRights(bfree.api._Securable.permissions.VERSION))&&(_39.getState(bfree.api.Document.states.CHECKED_IN)));arr[bfree.api.Document.permissionIndices.CKI]=((!_3e)&&(_39.hasRights(bfree.api._Securable.permissions.VERSION))&&(_39.getState(bfree.api.Document.states.CHECKED_OUT))&&(_39.checked_out_by==_3c.name));arr[bfree.api.Document.permissionIndices.CANCEL_CKO]=arr[bfree.api.Document.permissionIndices.CKI];arr[bfree.api.Document.permissionIndices.DELETE]=((!_3e)&&(_39.hasRights(bfree.api._Securable.permissions.DELETE_ITEMS)));arr[bfree.api.Document.permissionIndices.SECURE]=((!_3e)&&(_39.hasRights(bfree.api._Securable.permissions.WRITE_ACL)));return arr;};bfree.api.Document.VW_TRGT="/zones/{0}/libraries/{1}/documents/{2}/download/?disposition=inline";bfree.api.Document.CP_TRGT="/zones/{0}/libraries/{1}/documents/{2}/download/?disposition=attachment";bfree.api.Document.CKO_TRGT="/zones/{0}/libraries/{1}/documents/{2}/checkout.json";bfree.api.Document.CKI_TRGT="/zones/{0}/libraries/{1}/documents/{2}/checkin.json";bfree.api.Document.XCKO_TRGT="/zones/{0}/libraries/{1}/documents/{2}/cancel_checkout.json";bfree.api.Document.FILE_TRGT="/zones/{0}/libraries/{1}/documents/{2}/file.json";bfree.api.Document.UNFILE_TRGT="/zones/{0}/libraries/{1}/documents/{2}/unfile.json";bfree.api.Document.RESTORE_TRGT="/zones/{0}/libraries/{1}/documents/{2}/restore.json";bfree.api.Document.states={"NONE":0,"PENDING":1,"UPLOADED":2,"BUSY":4,"INDEXED":16,"CHECKED_IN":32,"CHECKED_OUT":64,"INVALID":1024,"DELETED":2048,"ERROR":65535};bfree.api.Document.schema={type:"object",properties:{"id":{type:"integer"},"document_type_id":{type:"integer"},"folder_id":{type:"integer",optional:true},"name":{type:"string","default":"","required":true},"created_at":{type:["string","object","null"],format:"date-time"},"created_by":{type:["string","null"],"default":""},"checked_out_by":{type:["string","null"]},"state":{type:"integer","default":bfree.api.Document.states.PENDING},"updated_at":{format:"date-time",optional:true},"updated_by":{type:["string","null"],"default":""}},prototype:new bfree.api.Document()};}