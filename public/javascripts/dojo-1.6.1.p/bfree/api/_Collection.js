/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.api._Collection"]){dojo._hasResource["bfree.api._Collection"]=true;dojo.provide("bfree.api._Collection");dojo.require("dojox.data.ClientFilter");dojo.require("dojox.data.JsonRestStore");dojo.require("bfree.api.Error");dojo.require("bfree.api.Utilities");dojo.declare("bfree.api._Collection",null,{store:null,target:null,schema:null,syncMode:true,cache:false,first:null,isLoaded:false,_fetch_onComplete:function(_1,_2){this.isLoaded=true;if((_1!=null)&&(_1.length>1)){this.first=_1[0];}this.onFetchComplete(_1);},_getExistingNames:function(_3){var _4=[];var _5=this.fetch();var _6=null;if(_3){_6=_3.exclude;}dojo.forEach(_5,function(_7){if((_7!=_6)&&(this.store.hasAttribute(_7,"name"))){_4.push(_7.name);}},this);return _4;},_getIdentity:function(_8){var id=_8.id;if(id){return id;}id=_8.__clientId||_8.__id;if(!id){return id;}var _9=this.service.servicePath.replace(/[^\/]*$/,"");return id.substring(0,_9.length)!=_9?id:id.substring(_9.length);},_initialize:function(){this.store=new dojox.data.JsonRestStore({target:this.target,idAttribute:"id",labelAttribute:"name",schema:this.schema,syncMode:this.syncMode,cacheByDefault:this.cache,clearOnClose:true,loadLazyValues:false,alwaysPostNewItems:true});this.store.getIdentity=dojo.hitch(this.store,this._getIdentity);},clearCache:function(){this.store.clearCache();},clone:function(_a){this.store.changing(_a.item);},constructor:function(){},containsValue:function(_b,_c,_d){return this.store.containsValue(_b,_c,_d);},create:function(_e){var _f=this.store.newItem(_e);this.store.changing(_f);return _f;},destroy:function(_10){var _11=(_10)?_10.no_save:false;try{this.store.deleteItem(_10.item);if(!_11){this.save({alwaysPostNewItems:true,onComplete:((_10)&&(_10.onComplete))?_10.onComplete:function(){},scope:((_10)&&(_10.scope))?_10.scope:this});}}finally{_10.item.__isDirty=false;}},fetch:function(_12){var _13=this.store.fetch({query:{},queryOptions:{cache:this.cache},onComplete:dojo.hitch(this,this._fetch_onComplete)});return _13.results;},fetchById:function(_14){var _15=this.store.fetchItemByIdentity({identity:_14.id});return _15;},fetchByName:function(_16){var _17=null;function _18(_19,_1a){dojo.some(_19,function(_1b){if(_1b.name==_16){_17=_1b;return false;}},this);};this.store.fetch({query:{},queryOptions:{cache:true},onComplete:_18});return _17;},fetchItemsByName:function(_1c){var _1d=new Array();function _1e(_1f,_20){dojo.some(_1f,function(_21){if(_21.name==_1c){_1d.push(_21);}},this);};this.store.fetch({query:{},queryOptions:{cache:true},onComplete:_1e});return _1d;},forEach:function(_22,_23){function _24(_25,_26){dojo.forEach(_25,_22,_23);};this.store.fetch({query:{},onComplete:_24});},isDirty:function(_27){var _28=(_27)?_27.item:null;return this.store.isDirty(_28);},isNew:function(_29){return ((_29.item.id==undefined)||(_29.item.id==null));},loadItem:function(_2a){var err=null;var _2b=_2a.item;if(_2a.callback){_2a.onItem=_2a.callback;}var _2c=(_2a.scope)?_2a.scope:this;this.store.loadItem({item:_2b,scope:_2c,onItem:_2a.onItem,onError:_2a.onError});},merge:function(_2d,_2e){for(var _2f in _2d){var _30=_2d[_2f];if((_30!=null)&&(typeof _30=="object")&&(typeof _30.getMonth!="function")){continue;}if(_2e.hasOwnProperty(_2f)){var _31=_2e[_2f];if(_31!=_30){this.store.setValue(_2d,_2f,_31);}}}},onFetchComplete:function(_32){},query:function(_33){var _34=[];var _35=this.store.fetch({query:_33.query,queryOptions:{cache:false},sort:_33.sort});if((_35)&&(_35.results)){_34=_35.results;}return _34;},refresh:function(){this.store.clearCache();this.fetch();},refreshAsync:function(_36){var _37=this.store.service.servicePath.replace(/[^\/]*$/,"");var _38=(_37||"")+_36.identity;var _39=this.store._index[_38];if(_39){delete this.store._index[_38];}this.store.fetchItemByIdentity({scope:_36.scope,identity:_36.identity,onItem:_36.onItem,onError:_36.onError});},refreshItem:function(_3a){var _3b=this.store.fetch({query:_3a,queryOptions:{cache:false}});return _3b.results;},revert:function(_3c){this.store.revert();},save:function(_3d){var err=null;_3d=(!_3d)?{scope:this,onComplete:function(){}}:_3d;function _3e(_3f){err=new bfree.api.Error(_3f.responseText,_3f);};this.store.save({alwaysPostNewItems:true,revertOnError:false,onError:_3e,onComplete:((_3d)&&(_3d.onComplete))?_3d.onComplete:function(){},scope:((_3d)&&(_3d.scope))?_3d.scope:this});if(err){throw err;}},setDirty:function(_40){this.store.changing(_40);},setValue:function(_41,_42,_43){this.store.setValue(_41,_42,_43);},getValue:function(_44,_45){return this.store.getValue(_44,_45);},generateUniqueName:function(_46){var _47=this.getExistingNames();var _48=_46.base_name;var _49=_46.appendix;return bfree.api.Utilities.generateUniqueName({names:_47,base_name:_48,appendix:_49});},getExistingNames:function(_4a){var _4b=[];var _4c=this.fetch();var _4d=null;if(_4a){_4d=_4a.exclude;}dojo.forEach(_4c,function(_4e){if((_4e!=_4d)&&(this.store.hasAttribute(_4e,"name"))){_4b.push(_4e.name);}},this);return _4b;},fetchDirtyItems:function(_4f){var _50=[];var _51=this.store.fetch({query:{__isDirty:true},queryOptions:{cache:false}});if((_51)&&(_51.results)){_50=_51.results;}return _50;}});}