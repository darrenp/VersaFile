/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.api._Collection"]){dojo._hasResource["bfree.api._Collection"]=true;dojo.provide("bfree.api._Collection");dojo.require("dojox.data.ClientFilter");dojo.require("dojox.data.JsonRestStore");dojo.require("bfree.api.Error");dojo.require("bfree.api.Utilities");dojo.declare("bfree.api._Collection",null,{store:null,target:null,schema:null,cache:false,first:null,isLoaded:false,_fetch_onComplete:function(_1,_2){this.isLoaded=true;if((_1!=null)&&(_1.length>1)){this.first=_1[0];}this.onFetchComplete(_1);},_getExistingNames:function(_3){var _4=[];var _5=this.fetch();var _6=null;if(_3){_6=_3.exclude;}dojo.forEach(_5,function(_7){if((_7!=_6)&&(this.store.hasAttribute(_7,"name"))){_4.push(_7.name);}},this);return _4;},_getIdentity:function(_8){var id=_8.id;if(id){return id;}id=_8.__clientId||_8.__id;if(!id){return id;}var _9=this.service.servicePath.replace(/[^\/]*$/,"");return id.substring(0,_9.length)!=_9?id:id.substring(_9.length);},_initialize:function(){this.store=new dojox.data.JsonRestStore({target:this.target,idAttribute:"id",labelAttribute:"name",schema:this.schema,syncMode:true,cacheByDefault:this.cache,clearOnClose:true,loadLazyValues:false,alwaysPostNewItems:true});this.store.getIdentity=dojo.hitch(this.store,this._getIdentity);},clearCache:function(){this.store.clearCache();},constructor:function(){},clone:function(_a){this.store.changing(_a.item);},create:function(_b){var _c=this.store.newItem(_b);this.store.changing(_c);return _c;},destroy:function(_d){var _e=(_d)?_d.no_save:false;try{this.store.deleteItem(_d.item);if(!_e){this.save({alwaysPostNewItems:true,onComplete:((_d)&&(_d.onComplete))?_d.onComplete:function(){},scope:((_d)&&(_d.scope))?_d.scope:this});}}finally{_d.item.__isDirty=false;}},fetch:function(_f){var _10=this.store.fetch({query:{},queryOptions:{cache:this.cache},onComplete:dojo.hitch(this,this._fetch_onComplete)});return _10.results;},fetchById:function(_11){var _12=this.store.fetchItemByIdentity({identity:_11.id});return _12;},fetchByName:function(_13){var _14=null;function _15(_16,_17){dojo.some(_16,function(_18){if(_18.name==_13){_14=_18;return false;}},this);};this.store.fetch({query:{},queryOptions:{cache:true},onComplete:_15});return _14;},fetchItemsByName:function(_19){var _1a=new Array();function _1b(_1c,_1d){dojo.some(_1c,function(_1e){if(_1e.name==_19){_1a.push(_1e);}},this);};this.store.fetch({query:{},queryOptions:{cache:true},onComplete:_1b});return _1a;},forEach:function(_1f,_20){function _21(_22,_23){dojo.forEach(_22,_1f,_20);};this.store.fetch({query:{},onComplete:_21});},isDirty:function(_24){var _25=(_24)?_24.item:null;return this.store.isDirty(_25);},isNew:function(_26){return ((_26.item.id==undefined)||(_26.item.id==null));},loadItem:function(_27){var err=null;var _28=_27.item;if(_27.callback){_27.onItem=_27.callback;}var _29=(_27.scope)?_27.scope:this;this.store.loadItem({item:_28,scope:_29,onItem:_27.onItem,onError:_27.onError});},merge:function(_2a,_2b){for(var _2c in _2a){var _2d=_2a[_2c];if((_2d!=null)&&(typeof _2d=="object")&&(typeof _2d.getMonth!="function")){continue;}if(_2b.hasOwnProperty(_2c)){var _2e=_2b[_2c];if(_2e!=_2d){this.store.setValue(_2a,_2c,_2e);}}}},onFetchComplete:function(_2f){},query:function(_30){var _31=[];var _32=this.store.fetch({query:_30.query,queryOptions:{cache:false},sort:_30.sort});if((_32)&&(_32.results)){_31=_32.results;}return _31;},refresh:function(){this.store.clearCache();this.fetch();},refreshItem:function(_33){var _34=this.store.fetch({query:_33,queryOptions:{cache:false}});return _34.results;},revert:function(_35){this.store.revert();},save:function(_36){var err=null;_36=(!_36)?{scope:this,onComplete:function(){}}:_36;function _37(_38){err=new bfree.api.Error(_38.responseText,_38);};this.store.save({alwaysPostNewItems:true,revertOnError:false,onError:_37,onComplete:((_36)&&(_36.onComplete))?_36.onComplete:function(){},scope:((_36)&&(_36.scope))?_36.scope:this});if(err){throw err;}},setDirty:function(_39){this.store.changing(_39);},setValue:function(_3a,_3b,_3c){this.store.setValue(_3a,_3b,_3c);},getValue:function(_3d,_3e){return this.store.getValue(_3d,_3e);},generateUniqueName:function(_3f){var _40=this.getExistingNames();var _41=_3f.base_name;var _42=_3f.appendix;return bfree.api.Utilities.generateUniqueName({names:_40,base_name:_41,appendix:_42});},getExistingNames:function(_43){var _44=[];var _45=this.fetch();var _46=null;if(_43){_46=_43.exclude;}dojo.forEach(_45,function(_47){if((_47!=_46)&&(this.store.hasAttribute(_47,"name"))){_44.push(_47.name);}},this);return _44;},fetchDirtyItems:function(_48){var _49=[];var _4a=this.store.fetch({query:{__isDirty:true},queryOptions:{cache:false}});if((_4a)&&(_4a.results)){_49=_4a.results;}return _49;}});}