/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["bfree.api._Collection"]){dojo._hasResource["bfree.api._Collection"]=true;dojo.provide("bfree.api._Collection");dojo.require("dojox.data.ClientFilter");dojo.require("dojox.data.JsonRestStore");dojo.require("bfree.api.Utilities");dojo.declare("bfree.api._Collection",null,{store:null,target:null,schema:null,cache:false,first:null,isLoaded:false,_fetch_onComplete:function(_1,_2){this.isLoaded=true;if((_1!=null)&&(_1.length>1)){this.first=_1[0];}this.onFetchComplete(_1);},_getExistingNames:function(_3){var _4=[];var _5=this.fetch();var _6=null;if(_3){_6=_3.exclude;}dojo.forEach(_5,function(_7){if((_7!=_6)&&(this.store.hasAttribute(_7,"name"))){_4.push(_7.name);}},this);return _4;},_getIdentity:function(_8){var id=_8.id;if(id){return id;}id=_8.__clientId||_8.__id;if(!id){return id;}var _9=this.service.servicePath.replace(/[^\/]*$/,"");return id.substring(0,_9.length)!=_9?id:id.substring(_9.length);},_initialize:function(){this.store=new dojox.data.JsonRestStore({target:this.target,idAttribute:"id",labelAttribute:"name",schema:this.schema,syncMode:true,cacheByDefault:this.cache,clearOnClose:true,loadLazyValues:false,alwaysPostNewItems:true});this.store.getIdentity=dojo.hitch(this.store,this._getIdentity);},clearCache:function(){this.store.clearCache();},constructor:function(){},clone:function(_a){this.store.changing(_a.item);},create:function(_b){var _c=this.store.newItem(_b);this.store.changing(_c);return _c;},destroy:function(_d){var _e=(_d)?_d.no_save:false;var _f=_d&&_d.onComplete?_d.onComplete:function(){};try{this.store.deleteItem(_d.item);if(!_e){this.save({onComplete:_f});}}finally{_d.item.__isDirty=false;}},fetch:function(_10){var _11=this.store.fetch({query:{},queryOptions:{cache:this.cache},onComplete:dojo.hitch(this,this._fetch_onComplete)});return _11.results;},fetchById:function(_12){var _13=this.store.fetchItemByIdentity({identity:_12.id});return _13;},fetchByName:function(_14){var _15=null;function _16(_17,_18){dojo.some(_17,function(_19){if(_19.name==_14){_15=_19;return false;}},this);};this.store.fetch({query:{},queryOptions:{cache:true},onComplete:_16});return _15;},fetchItemsByName:function(_1a){var _1b=new Array();function _1c(_1d,_1e){dojo.some(_1d,function(_1f){if(_1f.name==_1a){_1b.push(_1f);}},this);};this.store.fetch({query:{},queryOptions:{cache:true},onComplete:_1c});return _1b;},forEach:function(_20,_21){function _22(_23,_24){dojo.forEach(_23,_20,_21);};this.store.fetch({query:{},onComplete:_22});},isDirty:function(_25){var _26=(_25)?_25.item:null;return this.store.isDirty(_26);},isNew:function(_27){return ((_27.item.id==undefined)||(_27.item.id==null));},loadItem:function(_28){var _29=_28.item;this.store.loadItem({item:_29,onItem:_28.callback});},merge:function(_2a,_2b){for(var _2c in _2a){var _2d=_2a[_2c];if((_2d!=null)&&(typeof _2d=="object")&&(typeof _2d.getMonth!="function")){continue;}if(_2b.hasOwnProperty(_2c)){var _2e=_2b[_2c];if(_2e!=_2d){this.store.setValue(_2a,_2c,_2e);}}}},onFetchComplete:function(_2f){},query:function(_30){var _31=[];var _32=this.store.fetch({query:_30.query,queryOptions:{cache:false},sort:_30.sort});if((_32)&&(_32.results)){_31=_32.results;}return _31;},refresh:function(){this.store.clearCache();this.fetch();},refreshItem:function(_33){var _34=this.store.fetch({query:_33,queryOptions:{cache:false}});return _34.results;},revert:function(_35){this.store.revert();},save:function(_36){var err=null;_36=(!_36)?{scope:this,onComplete:function(){}}:_36;var _37=true;if(_36&&_36.revertOnError!=null){_37=_36.revertOnError;}function _38(_39){err=new bfree.api.Error(_39.responseText);if(_37){}};this.store.save({alwaysPostNewItems:true,onError:_38,onComplete:((_36)&&(_36.onComplete))?_36.onComplete:function(){},scope:((_36)&&(_36.scope))?_36.scope:this});if(err){throw new Error(err.message);}},setDirty:function(_3a){this.store.changing(_3a);},setValue:function(_3b,_3c,_3d){this.store.setValue(_3b,_3c,_3d);},getValue:function(_3e,_3f){return this.store.getValue(_3e,_3f);},generateUniqueName:function(_40){var _41=this.getExistingNames();var _42=_40.base_name;var _43=_40.appendix;return bfree.api.Utilities.generateUniqueName({names:_41,base_name:_42,appendix:_43});},getExistingNames:function(_44){var _45=[];var _46=this.fetch();var _47=null;if(_44){_47=_44.exclude;}dojo.forEach(_46,function(_48){if((_48!=_47)&&(this.store.hasAttribute(_48,"name"))){_45.push(_48.name);}},this);return _45;},fetchDirtyItems:function(_49){var _4a=[];var _4b=this.store.fetch({query:{__isDirty:true},queryOptions:{cache:false}});if((_4b)&&(_4b.results)){_4a=_4b.results;}return _4a;}});}