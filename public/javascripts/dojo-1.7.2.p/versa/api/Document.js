//>>built
define("versa/api/Document",["dojo/_base/declare","dojox/json/ref","versa/api/_Object","versa/api/_Securable","versa/api/Acl","versa/api/Application","versa/api/Utilities","versa/api/Versions","versa/api/PermissionSet"],function(_1){var o=_1("versa.api.Document",[versa.api._Object,versa.api._Securable],{zone:null,library:null,checked_out_by:"",document_type_id:null,library:null,state:0,clean_properties:function(_2){var _3=_2.library;var _4=_3.getDocumentTypes().fetchById({id:this.document_type_id});for(var p in this){if(!dojo.isFunction(this[p])){var _5=dojo.replace("documents.{0}",[p]);var _6=_3.getPropertyDefinitions().fetchByDbName(_5);if((_6)&&(!_6.is_system)){if(!_4.hasProperty(_6.id)){delete this[p];}}}}},constructor:function(_7){dojo.safeMixin(this,((!_7)?{}:_7));this.securable_type=versa.api._Securable.types.Document;if((this.created_at!=null)&&(typeof this.created_at=="string")){this.created_at=dojo.date.stamp.fromISOString(this.created_at);}if((this.updated_at!=null)&&(typeof this.updated_at=="string")){this.updated_at=dojo.date.stamp.fromISOString(this.created_at);}},copyLocal:function(_8){var _9=_8.zone;var _a=_8.library;var _b=dojo.replace(versa.api.Document.CP_TRGT,[_9.subdomain,_a.id,this.getId()]);versa.api.Utilities.saveUrl({url:_b,window_name:"versa_save"});},file:function(_c){var _d=_c.zone;var _e=_c.library;var _f=dojo.replace(versa.api.Document.FILE_TRGT,[_d.subdomain,_e.id,this.getId()]);var _10={folder_id:_c.folder.id};var _11=versa.api.XhrHelper.doPutAction({target:_f,putData:_10});return true;},getFullVersion:function(){return this.major_version_number;},getPermissionSet:function(_12,_13,_14){var _15=new versa.api.PermissionSet();_15.setValue(versa.api.PermissionIndices.VIEW,this.hasRights(versa.api._Securable.permissions.VIEW));_15.setValue(versa.api.PermissionIndices.COPY,this.hasRights(versa.api._Securable.permissions.VIEW));_15.setValue(versa.api.PermissionIndices.EDIT,this.hasRights(versa.api._Securable.permissions.WRITE_METADATA));_15.setValue(versa.api.PermissionIndices.MOVE,_15.getValue(versa.api.PermissionIndices.EDIT));_15.setValue(versa.api.PermissionIndices.CKO,(this.hasRights(versa.api._Securable.permissions.VERSION)&&this.getState(versa.api.Document.states.CHECKED_IN)));_15.setValue(versa.api.PermissionIndices.CKI,(this.hasRights(versa.api._Securable.permissions.VERSION)&&this.getState(versa.api.Document.states.CHECKED_OUT)&&(this.checked_out_by==_14.name)));_15.setValue(versa.api.PermissionIndices.CANCEL_CKO,_15.getValue(versa.api.PermissionIndices.CKI));_15.setValue(versa.api.PermissionIndices.DELETE,this.hasRights(versa.api._Securable.permissions.DELETE_ITEMS));_15.setValue(versa.api.PermissionIndices.SECURE,this.hasRights(versa.api._Securable.permissions.WRITE_ACL));_15.setValue(versa.api.PermissionIndices.RESTORE,this.hasRights(versa.api._Securable.permissions.DELETE_ITEMS));_15.setValue(versa.api.PermissionIndices.DESTROY,this.hasRights(versa.api._Securable.permissions.DELETE_ITEMS));return _15;},getState:function(_16){return versa.api.Document._isState(this.state,_16);},getVersions:function(_17){if(!this._versions){this._versions=new versa.api.Versions({zone:_17.zone,library:_17.library,document:this});}return this._versions;},isDeleted:function(){return this.getState(versa.api.Document.states.DELETED);},restore:function(_18){var _19=_18.zone;var _1a=_18.library;var url=dojo.replace(versa.api.Document.RESTORE_TRGT,[_19.subdomain,_1a.getId(),this.getId()]);var _1b={};var _1c=versa.api.XhrHelper.doPutAction({target:url,putData:_1b});return true;},setState:function(_1d,_1e){if(_1e){this.state=this.state|_1d;}else{this.state=this.state&~_1d;}return this.state;},unfile:function(_1f){var _20=_1f.zone;var _21=_1f.library;var url=dojo.replace(versa.api.Document.UNFILE_TRGT,[_20.subdomain,_21.id,this.id]);var _22={};var _23=versa.api.XhrHelper.doPutAction({target:url,putData:_22});return true;},validate:function(_24){if(!this.document_type_id){this.state|=versa.api.Document.states.INVALID;return false;}var _25=_24.library.getDocumentTypes().fetchById({id:this.document_type_id});var _26=_24.library.getPropertyDefinitions();var _27=versa.api.Application.getDataTypes();var _28=dojo.every(_25.property_mappings,function(_29,idx){var _2a=true;if(_29.is_required){var _2b=_26.fetchById({id:_29.property_definition_id});var _2c=_27.fetchById({id:_2b.data_type_id});if(!_2b){return false;}var _2d=this[_2b.column_name];if(_2c.isString()){_2a=!String.isEmpty(_2d);}}return _2a;},this);this.setState(versa.api.Document.states.INVALID,!_28);return _28;},getViewUrl:function(_2e,_2f){return dojo.replace(versa.api.Document.VW_TRGT,[_2e.subdomain,_2f.id,this.getId()]);},view:function(_30){var _31=_30.zone;var _32=_30.library;var url=this.getViewUrl(_31,_32);versa.api.Utilities.viewUrl({windowBox:_30.windowBox,url:url,window_name:"versa_viewer"});}});o.getIconUrl=function(_33,_34){return dojo.replace("/icons/{0}?size={1}",[encodeURIComponent(_33),_34]);};o._isState=function(_35,_36){return ((_35&_36)==_36);};o.getStateIcon=function(_37){var _38="none.16.png";if(versa.api.Document._isState(_37,versa.api.Document.states.ERROR)){_38="error.16.png";}else{if(versa.api.Document._isState(_37,versa.api.Document.states.INVALID)){_38="invalid.16.png";}else{if(versa.api.Document._isState(_37,versa.api.Document.states.CHECKED_IN)){_38="cki.16.png";}else{if(versa.api.Document._isState(_37,versa.api.Document.states.PENDING)){_38="pending.16.gif";}else{if(versa.api.Document._isState(_37,versa.api.Document.states.UPLOADED)){_38="uploaded.16.png";}}}}}return _38;};o.getStateMessage=function(_39){var msg="";if(versa.api.Document._isState(_39,versa.api.Document.states.ERROR)){msg="An error occurred";}else{if(versa.api.Document._isState(_39,versa.api.Document.states.INVALID)){msg="The file contains missing or invalid property values";}else{if(versa.api.Document._isState(_39,versa.api.Document.states.CHECKED_IN)){msg="The file has been added to VersaFile";}else{if(versa.api.Document._isState(_39,(versa.api.Document.states.PENDING|versa.api.Document.states.UPLOADED))){msg="The file is being added to VersaFile";}else{if(versa.api.Document._isState(_39,versa.api.Document.states.PENDING)){msg="Uploading...";}else{if(versa.api.Document._isState(_39,versa.api.Document.states.UPLOADED)){msg="The file has been uploaded and is ready for checkin";}}}}}}return msg;};o.VW_TRGT="/zones/{0}/libraries/{1}/documents/{2}/download/?disposition=inline";o.CP_TRGT="/zones/{0}/libraries/{1}/documents/{2}/download/?disposition=attachment";o.CKO_TRGT="/zones/{0}/libraries/{1}/documents/{2}/checkout.json";o.CKI_TRGT="/zones/{0}/libraries/{1}/documents/{2}/checkin.json";o.XCKO_TRGT="/zones/{0}/libraries/{1}/documents/{2}/cancel_checkout.json";o.FILE_TRGT="/zones/{0}/libraries/{1}/documents/{2}/file.json";o.UNFILE_TRGT="/zones/{0}/libraries/{1}/documents/{2}/unfile.json";o.RESTORE_TRGT="/zones/{0}/libraries/{1}/documents/{2}/restore.json";o.SDEL_TRGT="/zones/{0}/libraries/{1}/documents/{2}/soft_delete.json";o.states={"NONE":0,"PENDING":1,"UPLOADED":2,"BUSY":4,"INDEXED":16,"CHECKED_IN":32,"CHECKED_OUT":64,"INVALID":1024,"DELETED":2048,"ERROR":32768};o.schema={type:"object",properties:{"id":{type:"integer"},"document_type_id":{type:"integer"},"name":{type:"string","default":"","required":true},"created_at":{type:["string","object","null"],format:"date-time"},"created_by":{type:["string","null"],"default":""},"checked_out_by":{type:["string","null"]},"state":{type:"integer","default":o.PENDING},"updated_at":{type:["string","object","null"],format:"date-time"},"updated_by":{type:["string","null"],"default":""},"prp_dtt001":{type:["string","object","null"],format:"date-time"},"prp_dtt002":{type:["string","object","null"],format:"date-time"},"prp_dtt003":{type:["string","object","null"],format:"date-time"},"prp_dtt004":{type:["string","object","null"],format:"date-time"},"prp_dtt005":{type:["string","object","null"],format:"date-time"},"prp_dtt006":{type:["string","object","null"],format:"date-time"},"prp_dtt007":{type:["string","object","null"],format:"date-time"},"prp_dtt008":{type:["string","object","null"],format:"date-time"}},prototype:new o()};return o;});